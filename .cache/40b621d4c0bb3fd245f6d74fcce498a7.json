{"d": [{"url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1602", "repository_url": "https://api.github.com/repos/nodemailer/nodemailer", "labels_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1602/labels{/name}", "comments_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1602/comments", "events_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1602/events", "html_url": "https://github.com/nodemailer/nodemailer/issues/1602", "id": 2038829391, "node_id": "I_kwDOABNqaM55hhFP", "number": 1602, "title": "Memory leak issue with attachments", "user": {"login": "souramoo", "id": 11202149, "node_id": "MDQ6VXNlcjExMjAyMTQ5", "avatar_url": "https://avatars.githubusercontent.com/u/11202149?v=4", "gravatar_id": "", "url": "https://api.github.com/users/souramoo", "html_url": "https://github.com/souramoo", "followers_url": "https://api.github.com/users/souramoo/followers", "following_url": "https://api.github.com/users/souramoo/following{/other_user}", "gists_url": "https://api.github.com/users/souramoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/souramoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/souramoo/subscriptions", "organizations_url": "https://api.github.com/users/souramoo/orgs", "repos_url": "https://api.github.com/users/souramoo/repos", "events_url": "https://api.github.com/users/souramoo/events{/privacy}", "received_events_url": "https://api.github.com/users/souramoo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 107505, "node_id": "MDU6TGFiZWwxMDc1MDU=", "url": "https://api.github.com/repos/nodemailer/nodemailer/labels/Bug", "name": "Bug", "color": "e10c02", "default": false, "description": null}, {"id": 6320718955, "node_id": "LA_kwDOABNqaM8AAAABeL6Eaw", "url": "https://api.github.com/repos/nodemailer/nodemailer/labels/pending", "name": "pending", "color": "FCE68F", "default": false, "description": ""}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 4, "created_at": "2023-12-13T02:12:43Z", "updated_at": "2024-06-28T07:22:52Z", "closed_at": "2024-06-28T07:22:52Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Strictly speaking, it's not a pure memory leak. One of my servers (a docker container host server) started randomly crashing at various time intervals with incredibly high loads, which required further investigation. Curiously, I found in `dmesg`, the following error message:\r\n\r\n```\r\ntcp: out of memory -- consider tuning tcp_mem\r\n```\r\n\r\nWeird - I increased my tcp socket count to mitigate the issue for any users, and then went hunting. This led me to the following blog post - https://hechao.li/2022/09/30/a-tcp-timeout-investigation/ which helped me create a bash script and a python script to identify the container responsible for crashing the server.\r\n\r\n```\r\n#!/bin/bash\r\ncontainers=($(docker ps --format '{{.Names}}'))\r\nfor container in \"${containers[@]}\"\r\ndo\r\n  echo \"===$container===\"\r\n  pid=$(docker inspect --format '{{.State.Pid}}' \"$container\")\r\n  sudo nsenter --target \"$pid\" --net -- ss -t -m | grep skmem | cut -d\":\" -f2 | tr -d \"()\"\r\ndone\r\n```\r\n\r\n(piped the output of the above script into skmem_all.txt and then ran...)\r\n\r\n```\r\nwith open('skmem_all.txt') as f:\r\n    lines = [line.rstrip() for line in f]\r\n    total = 0\r\n    for line in lines:\r\n        if line.startswith(\"===\"):\r\n            if total > 0:\r\n                print(total)\r\n            total = 0\r\n            print(line)\r\n            continue\r\n        parts = line.split(\",\")\r\n        for part in parts:\r\n            if part.startswith(\"rb\") or part.startswith(\"tb\") or part.startswith(\"d\"):\r\n                continue\r\n            elif part.startswith(\"bl\"):\r\n                total += int(part[2:])\r\n            else:\r\n                total += int(part[1:])\r\n    print(total)\r\n```\r\n\r\nWhich revealed it was one of my custom containers running my own code! The code it was running was an express server which periodically sends out emails through nodemailer.\r\n\r\nI diligently attached my debugger and captured a few heap dumps, which revealed to me the reason why I was running out of sockets was because of an endless stream of ArrayBuffers which were associated with nodemailer.\r\n\r\nSpecifically, it was trying to send an (just one!) email, with an attachment (linked to via its URL in the href field of the attachment object array) to an invalid email address. Every time this was run, it appears that the sendMail function generated an error (which was caught and logged to not disrupt the flow of the server), but the socket to the attachment URL remained open. Forever. And everytime it periodically would try to resend this email to an invalid address, it would open more and more and more sockets, until it ran out of memory.\r\n\r\nI created a small proof of concept code:\r\n\r\nindex.js:\r\n```\r\nconst nodemailer = require(\"nodemailer\")\r\n\r\nlet smtpConfig = {\r\n    host: \"smtp.mailtrap.io\",\r\n    port: 587,\r\n    secure: false,\r\n    tls: {\r\n      rejectUnauthorized: false,\r\n    },\r\n    requireTLS: true,\r\n    pool: true,\r\n    auth: {\r\n      user: \"...\",\r\n      pass: \"...\",\r\n    },\r\n};\r\nlet transporter = nodemailer.createTransport(smtpConfig);\r\n\r\nasync function sendMail() {\r\n  try {\r\n    await transporter.sendMail({\r\n      from: '\"Fred Foo \ud83d\udc7b\" <foo@example.com>', // sender address\r\n      to: \"invalid-email\", // list of receivers\r\n      subject: \"Hello \u2714\", // Subject line\r\n      text: \"Hello world?\", // plain text body\r\n      html: \"<b>Hello world?</b>\", // html body\r\n      attachments: [{href: \"https://upload.wikimedia.org/wikipedia/commons/3/3d/LARGE_elevation.jpg\", filename: \"a.png\"}]\r\n    })\r\n  } catch(e) {\r\n//console.log(e)\r\n}\r\n\r\n}\r\n\r\n\r\nsetInterval(sendMail, 1000)\r\nconsole.log(\"running\")\r\n\r\n```\r\nThen run the code with `node --inspect index.js` and attach your chrome devtools node debugger. You will get a trace as follows:\r\n![image](https://github.com/nodemailer/nodemailer/assets/11202149/fdf0bb22-c9ad-4240-942d-df4e43683363)\r\n\r\nAfter a few seconds\r\n\r\n![image](https://github.com/nodemailer/nodemailer/assets/11202149/27bb7c8a-e65e-4362-bbc9-00114f5fbd34)\r\n\r\n\r\nAfter a few more seconds...\r\n![image](https://github.com/nodemailer/nodemailer/assets/11202149/818b49fc-385f-46ac-9414-cf5f330e9164)\r\n\r\n\r\nNote the growth in ArrayBuffer objects in that time, and the trace showing that each second the sendMail function is run, more arraybuffers are allocated onto memory but never released, despite this being expected behaviour once the sendMail function has resulted in an error.\r\n\r\n\r\n", "closed_by": {"login": "andris9", "id": 132242, "node_id": "MDQ6VXNlcjEzMjI0Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/132242?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andris9", "html_url": "https://github.com/andris9", "followers_url": "https://api.github.com/users/andris9/followers", "following_url": "https://api.github.com/users/andris9/following{/other_user}", "gists_url": "https://api.github.com/users/andris9/gists{/gist_id}", "starred_url": "https://api.github.com/users/andris9/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andris9/subscriptions", "organizations_url": "https://api.github.com/users/andris9/orgs", "repos_url": "https://api.github.com/users/andris9/repos", "events_url": "https://api.github.com/users/andris9/events{/privacy}", "received_events_url": "https://api.github.com/users/andris9/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1602/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1602/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/nodemailer/nodemailer/issues/22", "repository_url": "https://api.github.com/repos/nodemailer/nodemailer", "labels_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/22/labels{/name}", "comments_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/22/comments", "events_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/22/events", "html_url": "https://github.com/nodemailer/nodemailer/issues/22", "id": 946177, "node_id": "MDU6SXNzdWU5NDYxNzc=", "number": 22, "title": "Tls ?", "user": {"login": "joaomachado", "id": 143567, "node_id": "MDQ6VXNlcjE0MzU2Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/143567?v=4", "gravatar_id": "", "url": "https://api.github.com/users/joaomachado", "html_url": "https://github.com/joaomachado", "followers_url": "https://api.github.com/users/joaomachado/followers", "following_url": "https://api.github.com/users/joaomachado/following{/other_user}", "gists_url": "https://api.github.com/users/joaomachado/gists{/gist_id}", "starred_url": "https://api.github.com/users/joaomachado/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/joaomachado/subscriptions", "organizations_url": "https://api.github.com/users/joaomachado/orgs", "repos_url": "https://api.github.com/users/joaomachado/repos", "events_url": "https://api.github.com/users/joaomachado/events{/privacy}", "received_events_url": "https://api.github.com/users/joaomachado/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 107505, "node_id": "MDU6TGFiZWwxMDc1MDU=", "url": "https://api.github.com/repos/nodemailer/nodemailer/labels/Bug", "name": "Bug", "color": "e10c02", "default": false, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 3, "created_at": "2011-05-24T09:37:27Z", "updated_at": "2011-05-24T17:17:23Z", "closed_at": "2011-05-24T17:17:23Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Can send using TLS\n\nSMTP Configured\nSending Mail\n# Nodemailer, 0.1.13; +http://www.nodemailer.org: 1\n\nCONNECTION (1): 220 SAPO.pt PTMailServer ESMTP SPF1\nConnection established! (1)\nSEND (1):\n\u2514\u2500\u2500\"EHLO sl.pt\\r\\n\"\nRECEIVE (1):\n\u2514\u2500\u2500\"250-SAPO.pt PTMailServer\\r\\n250-AUTH LOGIN PLAIN\\r\\n250-AUTH=LOGIN PLAIN\\r\\n250-PIPELINING\\r\\n250-STARTTLS\\r\\n250-SIZE 0\\r\\n250 8BITMIME\\r\\n\" \"\"\nRouting Data (1)\nSTARTTLS: (1)\nSEND (1):\n\u2514\u2500\u2500\"STARTTLS\\r\\n\"\nRECEIVE (1):\n\u2514\u2500\u2500\"220 ready for tls\\r\\n\" \"\"\nRouting Data (1)\nRECEIVE (1):\n\u2514\u2500\u2500\"\\u0016\\u0003..(truncated).\\u0000\" \"\"\n\nUncaught Exception TypeError: Cannot call method 'verifyError' of undefined\n    at SecurePair.<anonymous> (/home/jpaulo/Desktop/testes/ptmailAlert/node_modules/nodemailer/lib/starttls.js:24:37)\n    at SecurePair.emit (events.js:61:17)\n    at SecurePair.maybeInitFinished (tls.js:598:10)\n    at CleartextStream._push (tls.js:269:17)\n    at SecurePair.cycle (tls.js:574:20)\n    at EncryptedStream.write (tls.js:96:13)\n    at Socket.ondata (stream.js:36:26)\n    at Socket.emit (events.js:81:20)\n    at Socket._onReadable (net.js:678:14)\n    at IOWatcher.onReadable [as callback](net.js:177:10)\n", "closed_by": {"login": "andris9", "id": 132242, "node_id": "MDQ6VXNlcjEzMjI0Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/132242?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andris9", "html_url": "https://github.com/andris9", "followers_url": "https://api.github.com/users/andris9/followers", "following_url": "https://api.github.com/users/andris9/following{/other_user}", "gists_url": "https://api.github.com/users/andris9/gists{/gist_id}", "starred_url": "https://api.github.com/users/andris9/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andris9/subscriptions", "organizations_url": "https://api.github.com/users/andris9/orgs", "repos_url": "https://api.github.com/users/andris9/repos", "events_url": "https://api.github.com/users/andris9/events{/privacy}", "received_events_url": "https://api.github.com/users/andris9/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/nodemailer/nodemailer/issues/22/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/22/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1775", "repository_url": "https://api.github.com/repos/nodemailer/nodemailer", "labels_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1775/labels{/name}", "comments_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1775/comments", "events_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1775/events", "html_url": "https://github.com/nodemailer/nodemailer/issues/1775", "id": 3542764381, "node_id": "I_kwDOABNqaM7TKktd", "number": 1775, "title": "Messages with attachments larger than ~90KB arrive at 0B as of 7.0.6", "user": {"login": "summ1else", "id": 100859, "node_id": "MDQ6VXNlcjEwMDg1OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/100859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/summ1else", "html_url": "https://github.com/summ1else", "followers_url": "https://api.github.com/users/summ1else/followers", "following_url": "https://api.github.com/users/summ1else/following{/other_user}", "gists_url": "https://api.github.com/users/summ1else/gists{/gist_id}", "starred_url": "https://api.github.com/users/summ1else/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/summ1else/subscriptions", "organizations_url": "https://api.github.com/users/summ1else/orgs", "repos_url": "https://api.github.com/users/summ1else/repos", "events_url": "https://api.github.com/users/summ1else/events{/privacy}", "received_events_url": "https://api.github.com/users/summ1else/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 107505, "node_id": "MDU6TGFiZWwxMDc1MDU=", "url": "https://api.github.com/repos/nodemailer/nodemailer/labels/Bug", "name": "Bug", "color": "e10c02", "default": false, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 2, "created_at": "2025-10-23T00:42:30Z", "updated_at": "2025-10-23T06:25:31Z", "closed_at": "2025-10-23T06:25:31Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "After moving to 7.0.6 from 7.05 (and we checked 7.0.9 and the issue still exists), 'large' attachments of size 100KB or larger arrive as 0B when transmitted to an SMTP service provider.\n\nWe tested both SMTP2Go and Sendgrid. Since both show the issue, and reverting to 7.0.5 solves the issue, we are confident that there has been a change in 7.0.6 that is causing unforeseen side effects with the way attachments are transported to our standard SMTP service providers. I'm attaching a sample JSON that is known to succed before and fail after the version change.\n\n```\n[\n  {\n    \"path\": \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD......Xk4xEtzHi/aKLD71Fdz//2Q==\",\n    \"filename\": \"file_example_JPG_500kB\"\n  }\n]\n```\nBecause the message could not be as long as the data, I have attached the image that was used. The shortened data is just the base64 representation of the image as plain text.\n\n![Image](https://github.com/user-attachments/assets/e3856c3c-a66a-42a6-9bec-a907653ef532)", "closed_by": {"login": "andris9", "id": 132242, "node_id": "MDQ6VXNlcjEzMjI0Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/132242?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andris9", "html_url": "https://github.com/andris9", "followers_url": "https://api.github.com/users/andris9/followers", "following_url": "https://api.github.com/users/andris9/following{/other_user}", "gists_url": "https://api.github.com/users/andris9/gists{/gist_id}", "starred_url": "https://api.github.com/users/andris9/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andris9/subscriptions", "organizations_url": "https://api.github.com/users/andris9/orgs", "repos_url": "https://api.github.com/users/andris9/repos", "events_url": "https://api.github.com/users/andris9/events{/privacy}", "received_events_url": "https://api.github.com/users/andris9/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1775/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/nodemailer/nodemailer/issues/1775/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}]}