{"d": {"_id": "varnish", "_rev": "5-5f0d74e4a06e30881f61502f4f02756a", "name": "varnish", "description": "high level tools for varnish", "dist-tags": {"latest": "0.0.1"}, "versions": {"0.0.1": {"name": "varnish", "description": "high level tools for varnish", "version": "0.0.1", "author": {"name": "Nathan White", "email": "nw@nwhite.net"}, "dependencies": {}, "devDependencies": {"should": "*", "mocha": "*"}, "keywords": ["varnish", "vlc", "routing", "load balancing", "load balancer", "proxy", "web accelerator"], "readme": "# Varnish\n\nvarnish.js is a library to help with the management of varnish servers.\n\n_from:_ [varnish-cache.org](https://www.varnish-cache.org/)\n\n```\nVarnish is a web accelerator. You install it in front of your web application and it will speed it up significantly. \n```\n\n__Note:__ This library only targets Varnish 3.x and above. For clarity on the feature please refer to the [documentation](https://www.varnish-cache.org/docs/3.0/)\n\n## README Contents\n- [Features](#a1)\n- [Installation](#a2)\n- [Usage](#a3)\n- [Api](#a4)\n\t- [Server](#a5)\n\t- [Admin](#a6)\n\t- [VCL](#a7)\n\t- [Stat](#a8)\n\t- [Top](#a9)\n\t- [Log](#a10)\n- [Resources](#a11)\n- [License](#a12)\n\n<a name=\"a1\"/>\n## Features\n\n<a name=\"a2\"/>\n## Installation\n\n```bash\n\nnpm install varnish\n```\nYou don't need varnish on the same machine or even at all to use this package. In order to run the integration tests you will need varnish running locally. Check out the [documentation and installation](https://www.varnish-cache.org/docs).\n\n<a name=\"a3\"/>\n## Usage\n\n```js\n\nvar varnish = require('varnish');\n```\n\n**Discover**\n\n```js\n\nvarnish.discover(function(err, servers){\n\tservers.forEach(function(server){\n\t\tconsole.log(server.pid);\n\t});\n});\n```\n\n**Create**\n\n```js\n\nvar server = varnish.create();\n\nserver\n\t.id('test')\n\t.name('mine')\n\t.storage('malloc')\n\t.shmlog(\"200M\")\n\t.workers('2,500,300')\n\t.pidfile('/var/run/varnish/example.pid')\n\t.secret('/hidden/file')\n\t.listen(':9000')\n\t.listen('proxy:8383')\n\t.management('localhost:4242')\n\t.vcl('/etc/varnish/default.vcl')\n\t.ttl(900)\n\t.param('max_restarts', 10);\n\t\nserver.start(function(err, server){\n\tconsole.log(server.pid);\n});\n```\n\n**Manage**\n\n```js\n\nvar admin = server.admin();\n\nadmin\n\t.ping()\n\t.start()\n\t.stop()\n\t.backend()\n\t.use()\n\t.kill();\n```\n\n**Analyse**\n\n```js\n\nvar stats = server.stats({fields: ['client_conn', 'client_req', 'cache_hit']});\n\nstats.on('data', function(json){\n\tjson.timestamp\n\tjson.cache_hit.value;\n\tjson.cache_hit.persec;\n\tjson.description\n});\n\nstats.kill();\n```\n\n**Configure**\n\n```js\n\nvar vcl = varnish.vcl();\n\nvcl.recv(function(resp, req){\n  var header = req.http(\"Accept-Encoding\");\n  this.if(req.url.like(\"\\.(jpg|png|gif|gz|tgz|bz2|tbz|mp3|ogg)$\"))\n    .comment(\"No point in compressing these\")\n    .unset(header)\n  .elseif(header.like('gzip'))\n    .set(header, \"gzip\")\n  .elseif(header.like(\"deflate\"))\n    .set(header, \"deflate\")\n  .else()\n    .comment(\"unknown algorithm\")\n    .unset(header);\n});\n\nadmin.inline('refname', vcl, function(err){\n\tif(err) return next(err);\n\tadmin.use('refname', function(err){\n\t\t\n\t});\n});\n\t\n```\n<a name=\"a4\"/>\n## Varnish\n\n### varnish.get()\n\nFind a varnishd instance based on id or instance name (-n). A function can be passed as a filter. The first server matches wins.\n\n```js\n\nvarnish.get(pid, callback);\nvarnish.get(name, callback); // -n referenced\nvarnish.get(fn, callback); // filter function\n\n```\n\n### varnish.discover()\n\n```js\n\nvarnish.discover();\nvarnish.discover({filter: fn});\nvarnish.discover({filter: [fn,fn]})\n```\n\nfilters receive a process obj.\n\n  - `pid`: pid\n  - `ppid`: Parent pid\n  - `user`: user\n  - `command`: command running\n  - `args`: string of args passed to command\n\n\n### varnish.create()\n\n\n<a name=\"a5\"/>\n## Server()\n\nA helper class for wrapping the generation of command line options to create a varnishd instance. For more clarity on the options to pass please refer to the [varnishd documentation](https://www.varnish-cache.org/docs/3.0/reference/varnishd.html). \n\nConfiguration options cannot be changed once a server has been initialized and has a pid. Attempts to change will be ignored.\n\n  - pid: false\n  - path: '/usr/local/sbin/varnishd'\n  - running: false\n  - child: false\n\n\n### Server.listen(host)\n\nListen for client requests on the specified address and port. The address can be a host name (\u201clocalhost\u201d), an IPv4 dotted-quad (\u201c127.0.0.1\u201d), or an IPv6 address enclosed in square brackets (\u201c[::1]\u201d). If address is not specified, varnishd will listen on all available IPv4 and IPv6 interfaces. If port is not specified, the default HTTP port as listed in /etc/services is used. Multiple listening addresses and ports can be specified.\n\n```js\n\nserver\n  .listen(':9000')\n\t.listen('host.com:8888')\n\t.toString(); // 'varnishd -a :9000,host.com:8888'\n```\n\n\n### Server.backend(host)\n\nUse the specified host as backend server. If port is not specified, the default is 8080\n\n```js\n\nserver\n\t.backend('backend.com')\n\t.toString(); // 'varnishd -b backend.com'\n```\n\n### Server.compile()\n\nPrint VCL code compiled to C language and exit. Specify the VCL file to compile with the -f option (`Server.vcl`).\n\n```js\n\nserver\n\t.compile\n\t.toString(); // 'varnishd -C'\n```\n\n\n### Server.debug()\n\nEnables debugging mode: The parent process runs in the foreground with a CLI connection on stdin/stdout, and the child process must be started explicitly with a CLI command. Terminating the parent process will also terminate the child.\n\n```js\n\nserver\n\t.debug()\n\t.toString(); // 'varnishd -d'\n```\n\n### Server.foreground()\n\nRun in the foreground.\n\n```js\n\nserver\n\t.foreground()\n\t.toString(); // 'varnishd -F'\n```\n\n### Server.vcl(vclfile)\n\nUse the specified VCL configuration file instead of the builtin default. See vcl for details on VCL syntax. When no configuration is supplied varnishd will not start the cache process.\n\n```js\n\nserver\n\t.vcl('/varnish/vcl/test.vcl')\n\t.toString(); // 'varnishd -f /varnish/vcl/test.vcl'\n```\n\n### Server.group(group)\n\nSpecifies the name of an unprivileged group to which the child process should switch before it starts accepting connections. This is a shortcut for specifying the group run-time parameter.\n\n```js\n\nserver\n\t.group('admin')\n\t.toString(); // 'varnishd -g admin'\n```\n\n### Server.hash()\n\nSpecifies the hash algorithm.\n\n  - `simple_list`: A simple doubly-linked list. Not recommended for production use.\n  - `classic[,buckets]`: A standard hash table. This is the default. The hash key is the CRC32 of the object's URL modulo the size of the hash table. Each table entry points to a list of elements which share the same hash key. The buckets parameter specifies the number of entries in the hash table. The default is 16383.\n  - `critbit`: A self-scaling tree structure. The default hash algorithm in 2.1. In comparison to a more traditional B tree the critbit tree is almost completely lockless.\n  \n```js\n\nserver\n\t.hash('classic,16383')\n\t.toString(); // 'varnishd -h classic,16383'\n```\n\n### Server.id()\n\nSpecify the identity of the varnish server. This can be accessed using server.identity from VCL\n\n```js\n\nserver\n\t.id('integration')\n\t.toString(); // 'varnishd -i integration'\n```\n\n### Server.shmlog()\n\nSpecify size of shmlog file. Scaling suffixes like 'k', 'm' can be used up to (e)tabytes. Default is 80 Megabytes. Specifying less than 8 Megabytes is unwise.\n\n```js\n\nserver\n\t.shmlog('80M')\n\t.toString(); // 'varnishd -l 80M'\n```\n\n### Server.name()\n\nSpecify a name for this instance. Amonst other things, this name is used to construct the name of the directory in which varnishd keeps temporary files and persistent state. If the specified name begins with a forward slash, it is interpreted as the absolute path to the directory which should be used for this purpose.\n\n```js\n\nserver\n\t.name('ref')\n\t.toString(); // 'varnishd -n ref'\n```\n\n### Server.pidfile()\n\nWrite the process's PID to the specified file.\n\n```js\n\nserver\n\t.pidfile('/var/run/varnish.pid')\n\t.toString(); // 'varnishd -P /var/run/varnish.pid'\n```\n\n### Server.param()\n\nSet the parameter specified by param to the specified value. See Run-Time Parameters for a list of parameters. This option can be used multiple times to specify multiple parameters.\n\n```js\n\nserver\n  .param('ban_lurker_sleep', 100)\n  .param('cli_buffer', 64000)\n  .toString(); // 'varnishd -p ban_lurker_sleep=100 -p cli_buffer=64000'\n```\n\n### Server.secret()\n\nPath to a file containing a secret used for authorizing access to the management port.\n\n```js\n\nserver\n  .secret('/secret.file')\n  .toString(); // 'varnishd -S /secret.file'\n```\n\n### Server.storage()\n\nUse the specified storage backend. See Storage Types for a list of supported storage types. This option can be used multiple times to specify multiple storage files. You can name the different backends. Varnish will then reference that backend with the given name in logs, statistics, etc.\n\n```js\n\nserver\n  .storage('malloc,500M)\n  .toString(); // 'varnishd -s malloc,500M'\n```\n\n### Server.management()\n\nOffer a management interface on the specified address and port. See Management Interface for a list of management commands.\n\n```js\n\nserver\n  .management('localhost:5421')\n  .toString(); // 'varnishd -T localhost:5421'\n```\n\n### Server.reverse()\n\nConnect to this port and offer the command line interface. Think of it as a reverse shell. When running with -M and there is no backend defined the child process (the cache) will not start initially.\n\n```js\n\nserver\n  .reverse('localhost:1245')\n  .toString(); // 'varnishd -M localhost:1245'\n```\n\n### Server.ttl()\n\nSpecifies a hard minimum time to live for cached documents. This is a shortcut for specifying the default_ttl run-time parameter.\n\n```js\n\nserver\n  .ttl(500)\n  .toString(); // 'varnishd -t 500'\n```\n\n### Server.user()\n\nSpecifies the name of an unprivileged user to which the child process should switch before it starts accepting connections. This is a shortcut for specifying the user run- time parameter.\n\nIf specifying both a user and a group, the user should be specified first.\n\n```js\n\nserver\n  .user('nw')\n  .toString(); // 'varnishd -u nw'\n```\n\n### Server.version()\n\nDisplay the version number and exit.\n\n```js\n\nserver\n  .version()\n  .toString(); // 'varnishd -V'\n```\n\n### Server.workers()\n\nStart at least min but no more than max worker threads with the specified idle timeout. This is a shortcut for specifying the thread_pool_min, thread_pool_max and thread_pool_timeout run-time parameters.\n\nIf only one number is specified, thread_pool_min and thread_pool_max are both set to this number, and thread_pool_timeout has no effect.\n\n```js\n\nserver\n  .workers('2,500,300')\n  .toString(); // 'varnishd -w 2,500,300'\n```\n\n### Server.start()\n\n### Server.kill()\n\n### Server.admin()\n\n### Server.stat()\n\n### Server.log()\n\n\n<a name=\"a6\"/>\n## Admin(host, port, options)\n\n  Admin client for `varnishadm`\n\n\n```js\n\nvar varnish = require('varnish')\n  , admin = new varnish.Admin(host, port, options);\n```\n  \n  __Options__:\n  \n- `name` {String} name of the instance to connect to\n- `auth` {String||Buffer} content of secret file for varnish\n- `file` if auth not present will load file contents.\n- `auto connect` {Boolean}\n\nUsing the `Server` class you can also create an `Admin` instance.\n\n```js\n\nvar admin = server.admin();\n```\n\nThe nice thing about creating it from the server is all properties set that apply to the admin class will be passed through automatically if the server has already been initialized and is running.\n\n\n\n### Events\n\n- `connect`: when a socket connection has been established with the management port.\n- `authenticated`: when the authentication challenge from management port has been responded to correctly.\n- `close`: when connection to the admin port has been closed.\n- `error`: any network related error.\n\n### Errors\n\n__Command Errors__\n\nAll errors that occur talking directly to the admin port will be handled in a callback and will not emit an `error` event.\n\n`error instanceof Error` in addition they have the a `code` property.\n\n- 100: 'Syntax Error'\n- 101: 'Unknown Request'\n- 102: 'Not Implemented'\n- 104: 'Too Few Parameters'\n- 105: 'Too Many Parameters'\n- 106: 'Bad Parameter'\n- 107: 'Authentication Required'\n- 200: 'OK'\n- 201: 'Truncated'\n- 300: \"Can't Perform Operation\"\n- 400: \"Communication Error\"\n- 500: \"Close\"\n\n_not implemented by varnishadm_\n- 800: 'Response Parsing Error'\n\n\n### Admin.connect()\n\n  Use when `autoconnect` flag == false\n\n\n### Admin.send(command, arg1, arg2, Function)\n\n  Send command to `varnishadm`. This is talking to the socket directly.\n\n```js\n\nadmin.send('help', function(err, resp){\n\t\n});\n\nadmin.send('vcl.load', 'dosattack', '/path/to/file/');\nadmin.send('vcl.use dosattack');\n```\n\nresp in all cases will be a string of the complete response from the admin.\n\n\n### __Command Wrappers__\n\nThe following methods wrap the send command and parse the output of the response for you. As a result all callbacks passed to these method will receive three parameters.\n\n- `error` {Error} object or `null`\n- `resp` parsed {Object} if `error == null`\n- `raw` the string response from the socket.\n\n\n### Admin.ping(callback)\n\n  Ping backend\n\n```js\n\nadmin.ping(function(err, pong){\n\tif(!pong) // we have problems\n})\n```\n\n### Admin.status(callback)\n\n  Check if child state == 'running'\n\n```js\n\nadmin.status(function(err, running){\n\tif(!running) // we need to start it\n})\n```\n\n### Admin.start(callback)\n\n  Starts child process (sets state == 'running')\n\n```js\n\nadmin.start(function(err){\n\t// started if no error\n});\n```\n\n### Admin.stop(callback)\n\n  Stops child process (sets state == 'stopped')\n\n```js\n\nadmin.stop(function(err){\n\t// stopped if no error\n});\n```\n\n### Admin.list(callback)\n\n  Returns list of loaded vcl files\n  \n  VCL {Object}\n  \n- name {String} name of vcl\n- num {String} ???\n- status {String} 'active|available|boot'\n\n```js\n\nadmin.list(function(err, list){\n\nconsole.log(list);\t\n/*\n [ {\n     \"status\": \"available\",\n     \"num\": \"0\",\n     \"name\": \"old\"\n   },\n   {\n     \"status\": \"active\",\n     \"num\": \"7\",\n     \"name\": \"super_cache\"\n   }\n ] */\n});\n```\n\n### Admin.load(reference, path, callback)\n\n  Load a vcl from a file\n\n### Admin.use(reference, callback)\n\n  Make a vcl config active.\n\n### Admin.inline(reference, inline, callback)\n\n  Make a vcl config active.\n\n### Admin.discard(reference, callback)\n\n  Discard a loaded vcl\n\n### Admin.settings(name, callback)\n\n  Get details on varnish configuration parameters\n  \n  __Param__:\n  \n- value: {String} current value\n- unit: {String} the unit type varnish expects\n- default: {String} default value\n- description: {String} description\n\n**[Complete List of Parameters](https://github.com/triplecrown/varnish/wiki/Server-Runtime-Parameters)**\n\n```js\n{\n  auto_restart: {\n    value: 'on',\n    unit: 'bool',\n    default: 'on [bool]',\n    desc: 'Restart child process automatically if it dies.'\n  },\n  cli_buffer: {\n    value: '8192',\n    unit: 'bytes',\n    default: '8192 [bytes]',\n    desc: 'Size of buffer for CLI input. You may need to increase this if you have big VCL files and use the vcl.inline CLI command. NB: Must be specified with -p to have effect.'\n  },\n  cli_timeout: {\n    value: '10',\n    unit: 'seconds',\n    default: '10 [seconds]',\n    desc: 'Timeout for the childs replies to CLI requests from the master.'\n  }\n}\n```\n\n### Admin.set(parameter, new, callback)\n\n  Set a parameter\n  \n```js\n\nadmin.set('cli_timeout', 20, function(err){\n  \n});\n\n```\n\n### Admin.panic(callback)\n\n  Check for latest panic\n\n### Admin.clear(callback)\n\n  Clears the last panic\n\n### Admin.storage(callback)\n\n  Get list of current storage w/ type\n\n```js\n\nadmin.storage(function(err, devices){\n\tconsole.log(devices);\n\t/* {\n    \"storage.Transient\": \"malloc\",\n    \"storage.s0\": \"malloc\"\n  } */\n})\n\n```\n\n### Admin.backend(callback)\n\n  List of all backend currently referenced in loaded VCLs\n  \n  __Backend__:\n\n- name {String}\n- host {String}\n- port {String}\n- refs {String} number of vcls pointing at backend\n- admin {String}\n- status {String}\n- passed {String}\n- window {String}\n\n```js\n\napp.backend(function(err, backends){\n\tconsole.log(backends);\n\t\n\t /* [\n    {\n      \"name\": \"prod\",\n      \"host\": \"108.166.39.30\",\n      \"port\": \"80\",\n      \"refs\": \"1\",\n      \"admin\": \"probe\",\n      \"status\": \"Sick\",\n      \"passed\": \"1\",\n      \"window\": \"5\"\n    },\n    {\n      \"name\": \"api\",\n      \"host\": \"198.61.245.73\",\n      \"port\": \"80\",\n      \"refs\": \"6\",\n      \"admin\": \"probe\",\n      \"status\": \"Healthy\",\n      \"passed\": \"5\",\n      \"window\": \"5\"\n    }\n  ] */\n\t\n})\n\n```\n\n### Admin.ban(url, callback)\n\n  Ban urls/rules from cache\n\n<a name=\"a7\"/>\n## VCL()\n\nA chain-able interface that allows vcl files to be written in javascript.\n\n\n\n\n<a name=\"a8\"/>\n## Stat\n\n\n  Stats client for `varnishstat`\n\n\n```js\n\nvar varnish = require('varnish')\n  , stat = new varnish.Stat(options);\n```\n\n  __Options__:\n\n- `fields` {Array} array of varnish fields to collect stats on\n- `every` sample rate in `second` units.\n- `name` instance of varnish to listen for\n\n\n### Events\n\n- `data`: stats object\n  - timestamp: {Date} object normalized to current timezone.\n  - fields: each field passed in options will be available. Each will have the following properties.\n    - `value`: the current value of the field\n    - `persec`: the normalized value over the last sec\n    - `description`: description about the field\n- `exit`: when connection to stats has been closed.\n- `error`: any data received on stderr. This is not an `Error` object. It is a `Buffer`.\n\n\n### Stat.list(callback) _static_\n\n```js\n\nStat.list(function(err, list){\n  console.log(list);\n  /*\n  {\n    client_conn: \"Client connections accepted\"\n  , client_drop: \"Connection dropped, no sess/wrk\"\n  , client_req: \"Client requests recieved\"\n  , cache_hit: \"Cache hits\"\n  // truncated \n  }\n  */\n})\n\n```\n\n**[Complete List of Stat Fields](https://github.com/triplecrown/varnish/wiki/Stat-Fields)**\n\n\n### Stat.kill(callback)\n\n\n\n\n<a name=\"a9\"/>\n## Top\n\n<a name=\"a10\"/>\n## Log\n\n<a name=\"a11\"/>\n## Resources\n\n\n![varnish](http://nw.is.s3.amazonaws.com/varnish.jpg)\n\n\n<a name=\"a12\"/>\n## Licence\n\n(The MIT License)\n\nCopyright (c) 2013 Nathan White <nw@nwhite.net>\n\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n'Software'), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\nIN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\nCLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\nTORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\nSOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n\n\n\n\n", "readmeFilename": "readme.md", "_id": "varnish@0.0.1", "dist": {"shasum": "bacb84419c19798b400f0d226e53a32745e8b240", "tarball": "https://registry.npmjs.org/varnish/-/varnish-0.0.1.tgz", "integrity": "sha512-zEoe1Sy1/6nsyObPxNsQw1yqqVvS+7kfUy0P4xIhBa8adK0OhZG7+eXx1xq9ch1Kvi+0/ohGx7pFV1bK0ARzKQ==", "signatures": [{"keyid": "SHA256:jl3bwswu80PjjokCgh0o2w5c2U4LhQAE57gj9cz1kzA", "sig": "MEYCIQDmjDBK2Lsir5ZjWYqlgKKse+RHW7YaM6LEJNlUw1CZjgIhAKiDqDAnlHXOqh3eOqbJXxbfxFtgpaHqyS5OtsdJWjP/"}]}, "_from": ".", "_npmVersion": "1.2.15", "_npmUser": {"name": "nw", "email": "nw@nwhite.net"}, "maintainers": [{"name": "nw", "email": "nw@nwhite.net"}]}}, "readme": "# Varnish\n\nvarnish.js is a library to help with the management of varnish servers.\n\n_from:_ [varnish-cache.org](https://www.varnish-cache.org/)\n\n```\nVarnish is a web accelerator. You install it in front of your web application and it will speed it up significantly. \n```\n\n__Note:__ This library only targets Varnish 3.x and above. For clarity on the feature please refer to the [documentation](https://www.varnish-cache.org/docs/3.0/)\n\n## README Contents\n- [Features](#a1)\n- [Installation](#a2)\n- [Usage](#a3)\n- [Api](#a4)\n\t- [Server](#a5)\n\t- [Admin](#a6)\n\t- [VCL](#a7)\n\t- [Stat](#a8)\n\t- [Top](#a9)\n\t- [Log](#a10)\n- [Resources](#a11)\n- [License](#a12)\n\n<a name=\"a1\"/>\n## Features\n\n<a name=\"a2\"/>\n## Installation\n\n```bash\n\nnpm install varnish\n```\nYou don't need varnish on the same machine or even at all to use this package. In order to run the integration tests you will need varnish running locally. Check out the [documentation and installation](https://www.varnish-cache.org/docs).\n\n<a name=\"a3\"/>\n## Usage\n\n```js\n\nvar varnish = require('varnish');\n```\n\n**Discover**\n\n```js\n\nvarnish.discover(function(err, servers){\n\tservers.forEach(function(server){\n\t\tconsole.log(server.pid);\n\t});\n});\n```\n\n**Create**\n\n```js\n\nvar server = varnish.create();\n\nserver\n\t.id('test')\n\t.name('mine')\n\t.storage('malloc')\n\t.shmlog(\"200M\")\n\t.workers('2,500,300')\n\t.pidfile('/var/run/varnish/example.pid')\n\t.secret('/hidden/file')\n\t.listen(':9000')\n\t.listen('proxy:8383')\n\t.management('localhost:4242')\n\t.vcl('/etc/varnish/default.vcl')\n\t.ttl(900)\n\t.param('max_restarts', 10);\n\t\nserver.start(function(err, server){\n\tconsole.log(server.pid);\n});\n```\n\n**Manage**\n\n```js\n\nvar admin = server.admin();\n\nadmin\n\t.ping()\n\t.start()\n\t.stop()\n\t.backend()\n\t.use()\n\t.kill();\n```\n\n**Analyse**\n\n```js\n\nvar stats = server.stats({fields: ['client_conn', 'client_req', 'cache_hit']});\n\nstats.on('data', function(json){\n\tjson.timestamp\n\tjson.cache_hit.value;\n\tjson.cache_hit.persec;\n\tjson.description\n});\n\nstats.kill();\n```\n\n**Configure**\n\n```js\n\nvar vcl = varnish.vcl();\n\nvcl.recv(function(resp, req){\n  var header = req.http(\"Accept-Encoding\");\n  this.if(req.url.like(\"\\.(jpg|png|gif|gz|tgz|bz2|tbz|mp3|ogg)$\"))\n    .comment(\"No point in compressing these\")\n    .unset(header)\n  .elseif(header.like('gzip'))\n    .set(header, \"gzip\")\n  .elseif(header.like(\"deflate\"))\n    .set(header, \"deflate\")\n  .else()\n    .comment(\"unknown algorithm\")\n    .unset(header);\n});\n\nadmin.inline('refname', vcl, function(err){\n\tif(err) return next(err);\n\tadmin.use('refname', function(err){\n\t\t\n\t});\n});\n\t\n```\n<a name=\"a4\"/>\n## Varnish\n\n### varnish.get()\n\nFind a varnishd instance based on id or instance name (-n). A function can be passed as a filter. The first server matches wins.\n\n```js\n\nvarnish.get(pid, callback);\nvarnish.get(name, callback); // -n referenced\nvarnish.get(fn, callback); // filter function\n\n```\n\n### varnish.discover()\n\n```js\n\nvarnish.discover();\nvarnish.discover({filter: fn});\nvarnish.discover({filter: [fn,fn]})\n```\n\nfilters receive a process obj.\n\n  - `pid`: pid\n  - `ppid`: Parent pid\n  - `user`: user\n  - `command`: command running\n  - `args`: string of args passed to command\n\n\n### varnish.create()\n\n\n<a name=\"a5\"/>\n## Server()\n\nA helper class for wrapping the generation of command line options to create a varnishd instance. For more clarity on the options to pass please refer to the [varnishd documentation](https://www.varnish-cache.org/docs/3.0/reference/varnishd.html). \n\nConfiguration options cannot be changed once a server has been initialized and has a pid. Attempts to change will be ignored.\n\n  - pid: false\n  - path: '/usr/local/sbin/varnishd'\n  - running: false\n  - child: false\n\n\n### Server.listen(host)\n\nListen for client requests on the specified address and port. The address can be a host name (\u201clocalhost\u201d), an IPv4 dotted-quad (\u201c127.0.0.1\u201d), or an IPv6 address enclosed in square brackets (\u201c[::1]\u201d). If address is not specified, varnishd will listen on all available IPv4 and IPv6 interfaces. If port is not specified, the default HTTP port as listed in /etc/services is used. Multiple listening addresses and ports can be specified.\n\n```js\n\nserver\n  .listen(':9000')\n\t.listen('host.com:8888')\n\t.toString(); // 'varnishd -a :9000,host.com:8888'\n```\n\n\n### Server.backend(host)\n\nUse the specified host as backend server. If port is not specified, the default is 8080\n\n```js\n\nserver\n\t.backend('backend.com')\n\t.toString(); // 'varnishd -b backend.com'\n```\n\n### Server.compile()\n\nPrint VCL code compiled to C language and exit. Specify the VCL file to compile with the -f option (`Server.vcl`).\n\n```js\n\nserver\n\t.compile\n\t.toString(); // 'varnishd -C'\n```\n\n\n### Server.debug()\n\nEnables debugging mode: The parent process runs in the foreground with a CLI connection on stdin/stdout, and the child process must be started explicitly with a CLI command. Terminating the parent process will also terminate the child.\n\n```js\n\nserver\n\t.debug()\n\t.toString(); // 'varnishd -d'\n```\n\n### Server.foreground()\n\nRun in the foreground.\n\n```js\n\nserver\n\t.foreground()\n\t.toString(); // 'varnishd -F'\n```\n\n### Server.vcl(vclfile)\n\nUse the specified VCL configuration file instead of the builtin default. See vcl for details on VCL syntax. When no configuration is supplied varnishd will not start the cache process.\n\n```js\n\nserver\n\t.vcl('/varnish/vcl/test.vcl')\n\t.toString(); // 'varnishd -f /varnish/vcl/test.vcl'\n```\n\n### Server.group(group)\n\nSpecifies the name of an unprivileged group to which the child process should switch before it starts accepting connections. This is a shortcut for specifying the group run-time parameter.\n\n```js\n\nserver\n\t.group('admin')\n\t.toString(); // 'varnishd -g admin'\n```\n\n### Server.hash()\n\nSpecifies the hash algorithm.\n\n  - `simple_list`: A simple doubly-linked list. Not recommended for production use.\n  - `classic[,buckets]`: A standard hash table. This is the default. The hash key is the CRC32 of the object's URL modulo the size of the hash table. Each table entry points to a list of elements which share the same hash key. The buckets parameter specifies the number of entries in the hash table. The default is 16383.\n  - `critbit`: A self-scaling tree structure. The default hash algorithm in 2.1. In comparison to a more traditional B tree the critbit tree is almost completely lockless.\n  \n```js\n\nserver\n\t.hash('classic,16383')\n\t.toString(); // 'varnishd -h classic,16383'\n```\n\n### Server.id()\n\nSpecify the identity of the varnish server. This can be accessed using server.identity from VCL\n\n```js\n\nserver\n\t.id('integration')\n\t.toString(); // 'varnishd -i integration'\n```\n\n### Server.shmlog()\n\nSpecify size of shmlog file. Scaling suffixes like 'k', 'm' can be used up to (e)tabytes. Default is 80 Megabytes. Specifying less than 8 Megabytes is unwise.\n\n```js\n\nserver\n\t.shmlog('80M')\n\t.toString(); // 'varnishd -l 80M'\n```\n\n### Server.name()\n\nSpecify a name for this instance. Amonst other things, this name is used to construct the name of the directory in which varnishd keeps temporary files and persistent state. If the specified name begins with a forward slash, it is interpreted as the absolute path to the directory which should be used for this purpose.\n\n```js\n\nserver\n\t.name('ref')\n\t.toString(); // 'varnishd -n ref'\n```\n\n### Server.pidfile()\n\nWrite the process's PID to the specified file.\n\n```js\n\nserver\n\t.pidfile('/var/run/varnish.pid')\n\t.toString(); // 'varnishd -P /var/run/varnish.pid'\n```\n\n### Server.param()\n\nSet the parameter specified by param to the specified value. See Run-Time Parameters for a list of parameters. This option can be used multiple times to specify multiple parameters.\n\n```js\n\nserver\n  .param('ban_lurker_sleep', 100)\n  .param('cli_buffer', 64000)\n  .toString(); // 'varnishd -p ban_lurker_sleep=100 -p cli_buffer=64000'\n```\n\n### Server.secret()\n\nPath to a file containing a secret used for authorizing access to the management port.\n\n```js\n\nserver\n  .secret('/secret.file')\n  .toString(); // 'varnishd -S /secret.file'\n```\n\n### Server.storage()\n\nUse the specified storage backend. See Storage Types for a list of supported storage types. This option can be used multiple times to specify multiple storage files. You can name the different backends. Varnish will then reference that backend with the given name in logs, statistics, etc.\n\n```js\n\nserver\n  .storage('malloc,500M)\n  .toString(); // 'varnishd -s malloc,500M'\n```\n\n### Server.management()\n\nOffer a management interface on the specified address and port. See Management Interface for a list of management commands.\n\n```js\n\nserver\n  .management('localhost:5421')\n  .toString(); // 'varnishd -T localhost:5421'\n```\n\n### Server.reverse()\n\nConnect to this port and offer the command line interface. Think of it as a reverse shell. When running with -M and there is no backend defined the child process (the cache) will not start initially.\n\n```js\n\nserver\n  .reverse('localhost:1245')\n  .toString(); // 'varnishd -M localhost:1245'\n```\n\n### Server.ttl()\n\nSpecifies a hard minimum time to live for cached documents. This is a shortcut for specifying the default_ttl run-time parameter.\n\n```js\n\nserver\n  .ttl(500)\n  .toString(); // 'varnishd -t 500'\n```\n\n### Server.user()\n\nSpecifies the name of an unprivileged user to which the child process should switch before it starts accepting connections. This is a shortcut for specifying the user run- time parameter.\n\nIf specifying both a user and a group, the user should be specified first.\n\n```js\n\nserver\n  .user('nw')\n  .toString(); // 'varnishd -u nw'\n```\n\n### Server.version()\n\nDisplay the version number and exit.\n\n```js\n\nserver\n  .version()\n  .toString(); // 'varnishd -V'\n```\n\n### Server.workers()\n\nStart at least min but no more than max worker threads with the specified idle timeout. This is a shortcut for specifying the thread_pool_min, thread_pool_max and thread_pool_timeout run-time parameters.\n\nIf only one number is specified, thread_pool_min and thread_pool_max are both set to this number, and thread_pool_timeout has no effect.\n\n```js\n\nserver\n  .workers('2,500,300')\n  .toString(); // 'varnishd -w 2,500,300'\n```\n\n### Server.start()\n\n### Server.kill()\n\n### Server.admin()\n\n### Server.stat()\n\n### Server.log()\n\n\n<a name=\"a6\"/>\n## Admin(host, port, options)\n\n  Admin client for `varnishadm`\n\n\n```js\n\nvar varnish = require('varnish')\n  , admin = new varnish.Admin(host, port, options);\n```\n  \n  __Options__:\n  \n- `name` {String} name of the instance to connect to\n- `auth` {String||Buffer} content of secret file for varnish\n- `file` if auth not present will load file contents.\n- `auto connect` {Boolean}\n\nUsing the `Server` class you can also create an `Admin` instance.\n\n```js\n\nvar admin = server.admin();\n```\n\nThe nice thing about creating it from the server is all properties set that apply to the admin class will be passed through automatically if the server has already been initialized and is running.\n\n\n\n### Events\n\n- `connect`: when a socket connection has been established with the management port.\n- `authenticated`: when the authentication challenge from management port has been responded to correctly.\n- `close`: when connection to the admin port has been closed.\n- `error`: any network related error.\n\n### Errors\n\n__Command Errors__\n\nAll errors that occur talking directly to the admin port will be handled in a callback and will not emit an `error` event.\n\n`error instanceof Error` in addition they have the a `code` property.\n\n- 100: 'Syntax Error'\n- 101: 'Unknown Request'\n- 102: 'Not Implemented'\n- 104: 'Too Few Parameters'\n- 105: 'Too Many Parameters'\n- 106: 'Bad Parameter'\n- 107: 'Authentication Required'\n- 200: 'OK'\n- 201: 'Truncated'\n- 300: \"Can't Perform Operation\"\n- 400: \"Communication Error\"\n- 500: \"Close\"\n\n_not implemented by varnishadm_\n- 800: 'Response Parsing Error'\n\n\n### Admin.connect()\n\n  Use when `autoconnect` flag == false\n\n\n### Admin.send(command, arg1, arg2, Function)\n\n  Send command to `varnishadm`. This is talking to the socket directly.\n\n```js\n\nadmin.send('help', function(err, resp){\n\t\n});\n\nadmin.send('vcl.load', 'dosattack', '/path/to/file/');\nadmin.send('vcl.use dosattack');\n```\n\nresp in all cases will be a string of the complete response from the admin.\n\n\n### __Command Wrappers__\n\nThe following methods wrap the send command and parse the output of the response for you. As a result all callbacks passed to these method will receive three parameters.\n\n- `error` {Error} object or `null`\n- `resp` parsed {Object} if `error == null`\n- `raw` the string response from the socket.\n\n\n### Admin.ping(callback)\n\n  Ping backend\n\n```js\n\nadmin.ping(function(err, pong){\n\tif(!pong) // we have problems\n})\n```\n\n### Admin.status(callback)\n\n  Check if child state == 'running'\n\n```js\n\nadmin.status(function(err, running){\n\tif(!running) // we need to start it\n})\n```\n\n### Admin.start(callback)\n\n  Starts child process (sets state == 'running')\n\n```js\n\nadmin.start(function(err){\n\t// started if no error\n});\n```\n\n### Admin.stop(callback)\n\n  Stops child process (sets state == 'stopped')\n\n```js\n\nadmin.stop(function(err){\n\t// stopped if no error\n});\n```\n\n### Admin.list(callback)\n\n  Returns list of loaded vcl files\n  \n  VCL {Object}\n  \n- name {String} name of vcl\n- num {String} ???\n- status {String} 'active|available|boot'\n\n```js\n\nadmin.list(function(err, list){\n\nconsole.log(list);\t\n/*\n [ {\n     \"status\": \"available\",\n     \"num\": \"0\",\n     \"name\": \"old\"\n   },\n   {\n     \"status\": \"active\",\n     \"num\": \"7\",\n     \"name\": \"super_cache\"\n   }\n ] */\n});\n```\n\n### Admin.load(reference, path, callback)\n\n  Load a vcl from a file\n\n### Admin.use(reference, callback)\n\n  Make a vcl config active.\n\n### Admin.inline(reference, inline, callback)\n\n  Make a vcl config active.\n\n### Admin.discard(reference, callback)\n\n  Discard a loaded vcl\n\n### Admin.settings(name, callback)\n\n  Get details on varnish configuration parameters\n  \n  __Param__:\n  \n- value: {String} current value\n- unit: {String} the unit type varnish expects\n- default: {String} default value\n- description: {String} description\n\n**[Complete List of Parameters](https://github.com/triplecrown/varnish/wiki/Server-Runtime-Parameters)**\n\n```js\n{\n  auto_restart: {\n    value: 'on',\n    unit: 'bool',\n    default: 'on [bool]',\n    desc: 'Restart child process automatically if it dies.'\n  },\n  cli_buffer: {\n    value: '8192',\n    unit: 'bytes',\n    default: '8192 [bytes]',\n    desc: 'Size of buffer for CLI input. You may need to increase this if you have big VCL files and use the vcl.inline CLI command. NB: Must be specified with -p to have effect.'\n  },\n  cli_timeout: {\n    value: '10',\n    unit: 'seconds',\n    default: '10 [seconds]',\n    desc: 'Timeout for the childs replies to CLI requests from the master.'\n  }\n}\n```\n\n### Admin.set(parameter, new, callback)\n\n  Set a parameter\n  \n```js\n\nadmin.set('cli_timeout', 20, function(err){\n  \n});\n\n```\n\n### Admin.panic(callback)\n\n  Check for latest panic\n\n### Admin.clear(callback)\n\n  Clears the last panic\n\n### Admin.storage(callback)\n\n  Get list of current storage w/ type\n\n```js\n\nadmin.storage(function(err, devices){\n\tconsole.log(devices);\n\t/* {\n    \"storage.Transient\": \"malloc\",\n    \"storage.s0\": \"malloc\"\n  } */\n})\n\n```\n\n### Admin.backend(callback)\n\n  List of all backend currently referenced in loaded VCLs\n  \n  __Backend__:\n\n- name {String}\n- host {String}\n- port {String}\n- refs {String} number of vcls pointing at backend\n- admin {String}\n- status {String}\n- passed {String}\n- window {String}\n\n```js\n\napp.backend(function(err, backends){\n\tconsole.log(backends);\n\t\n\t /* [\n    {\n      \"name\": \"prod\",\n      \"host\": \"108.166.39.30\",\n      \"port\": \"80\",\n      \"refs\": \"1\",\n      \"admin\": \"probe\",\n      \"status\": \"Sick\",\n      \"passed\": \"1\",\n      \"window\": \"5\"\n    },\n    {\n      \"name\": \"api\",\n      \"host\": \"198.61.245.73\",\n      \"port\": \"80\",\n      \"refs\": \"6\",\n      \"admin\": \"probe\",\n      \"status\": \"Healthy\",\n      \"passed\": \"5\",\n      \"window\": \"5\"\n    }\n  ] */\n\t\n})\n\n```\n\n### Admin.ban(url, callback)\n\n  Ban urls/rules from cache\n\n<a name=\"a7\"/>\n## VCL()\n\nA chain-able interface that allows vcl files to be written in javascript.\n\n\n\n\n<a name=\"a8\"/>\n## Stat\n\n\n  Stats client for `varnishstat`\n\n\n```js\n\nvar varnish = require('varnish')\n  , stat = new varnish.Stat(options);\n```\n\n  __Options__:\n\n- `fields` {Array} array of varnish fields to collect stats on\n- `every` sample rate in `second` units.\n- `name` instance of varnish to listen for\n\n\n### Events\n\n- `data`: stats object\n  - timestamp: {Date} object normalized to current timezone.\n  - fields: each field passed in options will be available. Each will have the following properties.\n    - `value`: the current value of the field\n    - `persec`: the normalized value over the last sec\n    - `description`: description about the field\n- `exit`: when connection to stats has been closed.\n- `error`: any data received on stderr. This is not an `Error` object. It is a `Buffer`.\n\n\n### Stat.list(callback) _static_\n\n```js\n\nStat.list(function(err, list){\n  console.log(list);\n  /*\n  {\n    client_conn: \"Client connections accepted\"\n  , client_drop: \"Connection dropped, no sess/wrk\"\n  , client_req: \"Client requests recieved\"\n  , cache_hit: \"Cache hits\"\n  // truncated \n  }\n  */\n})\n\n```\n\n**[Complete List of Stat Fields](https://github.com/triplecrown/varnish/wiki/Stat-Fields)**\n\n\n### Stat.kill(callback)\n\n\n\n\n<a name=\"a9\"/>\n## Top\n\n<a name=\"a10\"/>\n## Log\n\n<a name=\"a11\"/>\n## Resources\n\n\n![varnish](http://nw.is.s3.amazonaws.com/varnish.jpg)\n\n\n<a name=\"a12\"/>\n## Licence\n\n(The MIT License)\n\nCopyright (c) 2013 Nathan White <nw@nwhite.net>\n\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n'Software'), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\nIN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\nCLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\nTORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\nSOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n\n\n\n\n", "maintainers": [{"name": "nw", "email": "nw@nwhite.net"}], "time": {"modified": "2022-06-28T09:09:13.395Z", "created": "2013-03-27T20:34:08.128Z", "0.0.1": "2013-03-27T20:34:09.101Z"}, "author": {"name": "Nathan White", "email": "nw@nwhite.net"}}}