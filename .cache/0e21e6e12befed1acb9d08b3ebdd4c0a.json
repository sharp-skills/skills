{"d": [{"url": "https://api.github.com/repos/fastapi/fastapi/issues/9630", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/9630/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/9630/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/9630/events", "html_url": "https://github.com/fastapi/fastapi/pull/9630", "id": 1744378642, "node_id": "PR_kwDOCZduT85SVTxx", "number": 9630, "title": "\ud83d\udc1b Ensure that `app.include_router` merges nested lifespans", "user": {"login": "Lancetnik", "id": 44573917, "node_id": "MDQ6VXNlcjQ0NTczOTE3", "avatar_url": "https://avatars.githubusercontent.com/u/44573917?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Lancetnik", "html_url": "https://github.com/Lancetnik", "followers_url": "https://api.github.com/users/Lancetnik/followers", "following_url": "https://api.github.com/users/Lancetnik/following{/other_user}", "gists_url": "https://api.github.com/users/Lancetnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/Lancetnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Lancetnik/subscriptions", "organizations_url": "https://api.github.com/users/Lancetnik/orgs", "repos_url": "https://api.github.com/users/Lancetnik/repos", "events_url": "https://api.github.com/users/Lancetnik/events{/privacy}", "received_events_url": "https://api.github.com/users/Lancetnik/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 6426915236, "node_id": "LA_kwDOCZduT88AAAABfxLxpA", "url": "https://api.github.com/repos/fastapi/fastapi/labels/p1", "name": "p1", "color": "9AFC8E", "default": false, "description": ""}], "state": "closed", "locked": true, "assignees": [], "milestone": null, "comments": 52, "created_at": "2023-06-06T18:31:59Z", "updated_at": "2024-08-24T19:09:52Z", "closed_at": "2024-08-24T19:09:52Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": "spam", "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/9630", "html_url": "https://github.com/fastapi/fastapi/pull/9630", "diff_url": "https://github.com/fastapi/fastapi/pull/9630.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/9630.patch", "merged_at": "2024-08-24T19:09:52Z"}, "body": "I am working on my own [Propan](https://github.com/Lancetnik/Propan) library and as a part of it I implemented a custom **FastAPI** router with the following behavior.\r\n\r\n```python\r\nfrom fastapi import FastAPI\r\nfrom propan.fastapi import RabbitRouter\r\n\r\nrouter = RabbitRouter(\"amqp://guest:guest@localhost:5672\")\r\napp = FastAPI()\r\napp.include_router(router)\r\n```\r\n\r\nTo connect RabbitMQ at **FastAPI** startup I used `router.on_startup` events and all worked fine, but now it is deprecated. So I migrate to `lifespan` and now **FastAPI** doesn't run router lifespan at the code above.\r\n\r\nI suppose it was missed cuz the original `include_router` method includes all nested `on_startup` and `on_shutdown` deprecated events [here](https://github.com/tiangolo/fastapi/blob/master/fastapi/routing.py#L1307), but doesn't includes a router lifespan.\r\n\r\nSo, the following code doesn't work\r\n\r\n```python\r\nfrom contextlib import asynccontextmanager\r\nfrom fastapi import FastAPI, APIRouter\r\n\r\n@asynccontextmanager\r\nasync def router_lifespan(app):\r\n    print('router start')\r\n    yield\r\n    print('router shutdown')\r\n\r\nrouter = APIRouter(lifespan=router_lifespan)\r\napp = FastAPI()\r\napp.include_router(router)\r\n```\r\n\r\nThe current PR fixes the original framework miss.\r\nAll original test and lint.sh checks works fine.", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/9630/reactions", "total_count": 45, "+1": 45, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/9630/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/4573", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/4573/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/4573/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/4573/events", "html_url": "https://github.com/fastapi/fastapi/pull/4573", "id": 1137421410, "node_id": "PR_kwDOCZduT84yytZl", "number": 4573, "title": "\ud83d\udd27 Keep description when endpoint depends schema", "user": {"login": "jujumilk3", "id": 41659814, "node_id": "MDQ6VXNlcjQxNjU5ODE0", "avatar_url": "https://avatars.githubusercontent.com/u/41659814?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jujumilk3", "html_url": "https://github.com/jujumilk3", "followers_url": "https://api.github.com/users/jujumilk3/followers", "following_url": "https://api.github.com/users/jujumilk3/following{/other_user}", "gists_url": "https://api.github.com/users/jujumilk3/gists{/gist_id}", "starred_url": "https://api.github.com/users/jujumilk3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jujumilk3/subscriptions", "organizations_url": "https://api.github.com/users/jujumilk3/orgs", "repos_url": "https://api.github.com/users/jujumilk3/repos", "events_url": "https://api.github.com/users/jujumilk3/events{/privacy}", "received_events_url": "https://api.github.com/users/jujumilk3/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 6426871392, "node_id": "LA_kwDOCZduT88AAAABfxJGYA", "url": "https://api.github.com/repos/fastapi/fastapi/labels/p2", "name": "p2", "color": "958029", "default": false, "description": ""}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 29, "created_at": "2022-02-14T14:55:29Z", "updated_at": "2025-09-20T15:28:46Z", "closed_at": "2025-09-20T15:28:46Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/4573", "html_url": "https://github.com/fastapi/fastapi/pull/4573", "diff_url": "https://github.com/fastapi/fastapi/pull/4573.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/4573.patch", "merged_at": null}, "body": "When endpoint depends schema, Field's descriptions are gone Because when custom schema class extends `pydantic.BaseModel`, class's members turn into `pydantic.fields.ModelField`. So descriptions are omitted from schema class members.\r\n\r\nThis commit keep their descriptions when it uses as query parameters.", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/4573/reactions", "total_count": 15, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 10, "rocket": 1, "eyes": 4}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/4573/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/12972", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/12972/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/12972/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/12972/events", "html_url": "https://github.com/fastapi/fastapi/pull/12972", "id": 2683498273, "node_id": "PR_kwDOCZduT86C06yG", "number": 12972, "title": "\ud83d\udc1b Add missing `ValidationException.__str__` functionality", "user": {"login": "tamird", "id": 1535036, "node_id": "MDQ6VXNlcjE1MzUwMzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1535036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tamird", "html_url": "https://github.com/tamird", "followers_url": "https://api.github.com/users/tamird/followers", "following_url": "https://api.github.com/users/tamird/following{/other_user}", "gists_url": "https://api.github.com/users/tamird/gists{/gist_id}", "starred_url": "https://api.github.com/users/tamird/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tamird/subscriptions", "organizations_url": "https://api.github.com/users/tamird/orgs", "repos_url": "https://api.github.com/users/tamird/repos", "events_url": "https://api.github.com/users/tamird/events{/privacy}", "received_events_url": "https://api.github.com/users/tamird/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 9229492097, "node_id": "LA_kwDOCZduT88AAAACJh7fgQ", "url": "https://api.github.com/repos/fastapi/fastapi/labels/conflicts", "name": "conflicts", "color": "ec4af9", "default": false, "description": "Automatically generated when a PR has a merge conflict"}], "state": "closed", "locked": false, "assignees": [{"login": "YuriiMotov", "id": 109919500, "node_id": "U_kgDOBo09DA", "avatar_url": "https://avatars.githubusercontent.com/u/109919500?v=4", "gravatar_id": "", "url": "https://api.github.com/users/YuriiMotov", "html_url": "https://github.com/YuriiMotov", "followers_url": "https://api.github.com/users/YuriiMotov/followers", "following_url": "https://api.github.com/users/YuriiMotov/following{/other_user}", "gists_url": "https://api.github.com/users/YuriiMotov/gists{/gist_id}", "starred_url": "https://api.github.com/users/YuriiMotov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/YuriiMotov/subscriptions", "organizations_url": "https://api.github.com/users/YuriiMotov/orgs", "repos_url": "https://api.github.com/users/YuriiMotov/repos", "events_url": "https://api.github.com/users/YuriiMotov/events{/privacy}", "received_events_url": "https://api.github.com/users/YuriiMotov/received_events", "type": "User", "user_view_type": "public", "site_admin": false}], "milestone": null, "comments": 19, "created_at": "2024-11-22T15:06:39Z", "updated_at": "2025-12-10T13:16:52Z", "closed_at": "2025-12-10T13:16:52Z", "assignee": {"login": "YuriiMotov", "id": 109919500, "node_id": "U_kgDOBo09DA", "avatar_url": "https://avatars.githubusercontent.com/u/109919500?v=4", "gravatar_id": "", "url": "https://api.github.com/users/YuriiMotov", "html_url": "https://github.com/YuriiMotov", "followers_url": "https://api.github.com/users/YuriiMotov/followers", "following_url": "https://api.github.com/users/YuriiMotov/following{/other_user}", "gists_url": "https://api.github.com/users/YuriiMotov/gists{/gist_id}", "starred_url": "https://api.github.com/users/YuriiMotov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/YuriiMotov/subscriptions", "organizations_url": "https://api.github.com/users/YuriiMotov/orgs", "repos_url": "https://api.github.com/users/YuriiMotov/repos", "events_url": "https://api.github.com/users/YuriiMotov/events{/privacy}", "received_events_url": "https://api.github.com/users/YuriiMotov/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/12972", "html_url": "https://github.com/fastapi/fastapi/pull/12972", "diff_url": "https://github.com/fastapi/fastapi/pull/12972.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/12972.patch", "merged_at": null}, "body": "Fixes https://github.com/fastapi/fastapi/discussions/12125.\r\n\r\n**UPD YuriiMotov:**\r\nThe issue is: the code example [in docs](https://fastapi.tiangolo.com/tutorial/handling-errors/#override-request-validation-exceptions) should show text version\r\n```\r\n1 validation error\r\npath -> item_id\r\nvalue is not a valid integer (type=type_error.integer)\r\n```\r\nBut it shows JSON\r\n```\r\n[{'type': 'int_parsing', 'loc': ('path', 'item_id'), 'msg': 'Input should be a valid integer, unable to parse string as an integer', 'input': 'foo'}]\r\n```", "closed_by": {"login": "tamird", "id": 1535036, "node_id": "MDQ6VXNlcjE1MzUwMzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1535036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tamird", "html_url": "https://github.com/tamird", "followers_url": "https://api.github.com/users/tamird/followers", "following_url": "https://api.github.com/users/tamird/following{/other_user}", "gists_url": "https://api.github.com/users/tamird/gists{/gist_id}", "starred_url": "https://api.github.com/users/tamird/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tamird/subscriptions", "organizations_url": "https://api.github.com/users/tamird/orgs", "repos_url": "https://api.github.com/users/tamird/repos", "events_url": "https://api.github.com/users/tamird/events{/privacy}", "received_events_url": "https://api.github.com/users/tamird/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/12972/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/12972/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/11143", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/11143/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/11143/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/11143/events", "html_url": "https://github.com/fastapi/fastapi/issues/11143", "id": 2133918476, "node_id": "I_kwDOCZduT85_MQMM", "number": 11143, "title": "Context managers in `Depends` are broken after 0.106", "user": {"login": "Kludex", "id": 7353520, "node_id": "MDQ6VXNlcjczNTM1MjA=", "avatar_url": "https://avatars.githubusercontent.com/u/7353520?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kludex", "html_url": "https://github.com/Kludex", "followers_url": "https://api.github.com/users/Kludex/followers", "following_url": "https://api.github.com/users/Kludex/following{/other_user}", "gists_url": "https://api.github.com/users/Kludex/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kludex/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kludex/subscriptions", "organizations_url": "https://api.github.com/users/Kludex/orgs", "repos_url": "https://api.github.com/users/Kludex/repos", "events_url": "https://api.github.com/users/Kludex/events{/privacy}", "received_events_url": "https://api.github.com/users/Kludex/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 41, "created_at": "2024-02-14T09:37:11Z", "updated_at": "2025-09-29T03:50:19Z", "closed_at": "2025-09-29T03:50:19Z", "assignee": null, "author_association": "MEMBER", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "### Discussed in https://github.com/tiangolo/fastapi/discussions/11107\r\n\r\n<div type='discussions-op-text'>\r\n\r\n<sup>Originally posted by **FeeeeK** February  7, 2024</sup>\r\n### First Check\r\n\r\n- [X] I added a very descriptive title here.\r\n- [X] I used the GitHub search to find a similar question and didn't find it.\r\n- [X] I searched the FastAPI documentation, with the integrated search.\r\n- [X] I already searched in Google \"How to X in FastAPI\" and didn't find any information.\r\n- [X] I already read and followed all the tutorial in the docs and didn't find an answer.\r\n- [X] I already checked if it is not related to FastAPI but to [Pydantic](https://github.com/pydantic/pydantic).\r\n- [X] I already checked if it is not related to FastAPI but to [Swagger UI](https://github.com/swagger-api/swagger-ui).\r\n- [X] I already checked if it is not related to FastAPI but to [ReDoc](https://github.com/Redocly/redoc).\r\n\r\n### Commit to Help\r\n\r\n- [X] I commit to help with one of those options \ud83d\udc46\r\n\r\n### Example Code\r\n\r\n```python\r\nfrom fastapi import Depends, FastAPI, Request\r\n\r\napp = FastAPI()\r\n\r\n\r\nclass Session:\r\n    def __init__(self):\r\n        print(\"creating session\")\r\n\r\n    async def __aenter__(self):\r\n        print(\"opening session\")\r\n        return self\r\n\r\n    async def __aexit__(self, exc_type, exc, tb):\r\n        print(\"closing session\")\r\n\r\n    async def commit(self):\r\n        print(\"committing session\")\r\n\r\n    async def rollback(self):\r\n        print(\"rolling back session\")\r\n\r\n\r\n@app.middleware(\"http\")\r\nasync def commit_session(request: Request, call_next):\r\n    # minimalistic middleware for example, my code uses ASGI middleware\r\n    response = await call_next(request)\r\n    db_session = request.scope.get(\"db_session\")\r\n    if not db_session:\r\n        return response\r\n\r\n    if response.status_code // 200 != 1:\r\n        await db_session.rollback()\r\n    else:\r\n        await db_session.commit()\r\n\r\n    return response\r\n\r\n\r\nasync def get_db_session(request: Request):\r\n    async with Session() as session:\r\n        request.scope[\"db_session\"] = session\r\n        yield session\r\n\r\n\r\n@app.get(\"/\")\r\nasync def root(session: Session = Depends(get_db_session)):\r\n    return {\"message\": \"Hello World\"}\r\n\r\n\r\n# Pre 0.106 behaviour:\r\n\r\n# creating session\r\n# opening session\r\n# committing session\r\n# closing session\r\n\r\n# Post 0.106 behaviour:\r\n# creating session\r\n# opening session\r\n# closing session\r\n# committing session\r\n\r\n# The session is not committed, because it's closed before the middleware is called.\r\n```\r\n\r\n\r\n### Description\r\n\r\nBefore `0.106`, Depends execution after yield was after middlewares, which allowed to access resources created for a route (e.g. sessions) and do something with them depending on the response (which cannot be done with Depends), but after 0.106, the behavior has changed and this feature is no longer available. The documentation only talks about background tasks, but not a word about middlewares. Was this behavior change intentional?\r\n\r\n### Operating System\r\n\r\nWindows\r\n\r\n### Operating System Details\r\n\r\n_No response_\r\n\r\n### FastAPI Version\r\n\r\n0.109.2\r\n\r\n### Pydantic Version\r\n\r\n2.4.2\r\n\r\n### Python Version\r\n\r\n3.11.1\r\n\r\n### Additional Context\r\n\r\n_No response_</div>", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/11143/reactions", "total_count": 28, "+1": 28, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/11143/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/98", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/98/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/98/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/98/events", "html_url": "https://github.com/fastapi/fastapi/issues/98", "id": 424564890, "node_id": "MDU6SXNzdWU0MjQ1NjQ4OTA=", "number": 98, "title": "Websocket Routes Only Work on FastAPI, not APIRouter", "user": {"login": "iwoloschin", "id": 6474586, "node_id": "MDQ6VXNlcjY0NzQ1ODY=", "avatar_url": "https://avatars.githubusercontent.com/u/6474586?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iwoloschin", "html_url": "https://github.com/iwoloschin", "followers_url": "https://api.github.com/users/iwoloschin/followers", "following_url": "https://api.github.com/users/iwoloschin/following{/other_user}", "gists_url": "https://api.github.com/users/iwoloschin/gists{/gist_id}", "starred_url": "https://api.github.com/users/iwoloschin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iwoloschin/subscriptions", "organizations_url": "https://api.github.com/users/iwoloschin/orgs", "repos_url": "https://api.github.com/users/iwoloschin/repos", "events_url": "https://api.github.com/users/iwoloschin/events{/privacy}", "received_events_url": "https://api.github.com/users/iwoloschin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 5182257681, "node_id": "LA_kwDOCZduT88AAAABNOL6EQ", "url": "https://api.github.com/repos/fastapi/fastapi/labels/reviewed", "name": "reviewed", "color": "BFD4F2", "default": false, "description": ""}], "state": "closed", "locked": true, "assignees": [], "milestone": null, "comments": 37, "created_at": "2019-03-24T01:51:32Z", "updated_at": "2023-12-15T13:47:59Z", "closed_at": "2019-03-24T20:00:11Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": "resolved", "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "**Describe the bug**\r\nWebsocket routes appear to only work on the main FastAPI object, not on APIRouter objects.  When the same function is copied from a FastAPI object to an APIRouter object instead of working properly it just throws a 403.\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. The following works as expected:\r\n```python\r\nfrom fastapi import FastAPI\r\napp = FastAPI()\r\n\r\n@app.websocket_route(\"/hello\")\r\nasync def hello(websocket):\r\n    await websocket.accept()\r\n    await websocket.send_text(\"Hello!\")\r\n    response = await websocket.receive_text()\r\n    print(response)\r\n    await websocket.close()\r\n    print(\"Closed\")\r\n```\r\n2. Moving `hello` to an APIRouter fails:\r\n```python\r\n# main.py\r\nfrom fastapi import FastAPI\r\nimport other\r\napp = FastAPI()\r\napp.include_router(other.router)\r\n```\r\n\r\n```python\r\n# other.py\r\nfrom fastapi import APIRouter\r\nrouter = APIRouter()\r\n\r\n@router.websocket_route(\"/routerhello\")\r\nasync def hello(websocket):\r\n    await websocket.accept()\r\n    await websocket.send_text(\"Router Hello!\")\r\n    response = await websocket.receive_text()\r\n    print(response)\r\n    await websocket.close()\r\n    print(\"Router Closed\")\r\n```\r\n**Expected behavior**\r\nI expect a websocket route to work on both a FastAPI and APIRouter object.\r\n\r\n**Screenshots**\r\nNot applicable.\r\n\r\n**Environment:**\r\n - OS: macOS 10.14.3\r\n - FastAPI Version: 0.9.0\r\n\r\n- Python version, get it with: 3.7.2\r\n\r\n**Additional context**\r\nTesting websocket client side with `websocat`.", "closed_by": {"login": "iwoloschin", "id": 6474586, "node_id": "MDQ6VXNlcjY0NzQ1ODY=", "avatar_url": "https://avatars.githubusercontent.com/u/6474586?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iwoloschin", "html_url": "https://github.com/iwoloschin", "followers_url": "https://api.github.com/users/iwoloschin/followers", "following_url": "https://api.github.com/users/iwoloschin/following{/other_user}", "gists_url": "https://api.github.com/users/iwoloschin/gists{/gist_id}", "starred_url": "https://api.github.com/users/iwoloschin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iwoloschin/subscriptions", "organizations_url": "https://api.github.com/users/iwoloschin/orgs", "repos_url": "https://api.github.com/users/iwoloschin/repos", "events_url": "https://api.github.com/users/iwoloschin/events{/privacy}", "received_events_url": "https://api.github.com/users/iwoloschin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/98/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/98/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/11306", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/11306/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/11306/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/11306/events", "html_url": "https://github.com/fastapi/fastapi/pull/11306", "id": 2190686349, "node_id": "PR_kwDOCZduT85p3JOc", "number": 11306, "title": "Support Pydantic root model as query parameter", "user": {"login": "MarkusSintonen", "id": 12939780, "node_id": "MDQ6VXNlcjEyOTM5Nzgw", "avatar_url": "https://avatars.githubusercontent.com/u/12939780?v=4", "gravatar_id": "", "url": "https://api.github.com/users/MarkusSintonen", "html_url": "https://github.com/MarkusSintonen", "followers_url": "https://api.github.com/users/MarkusSintonen/followers", "following_url": "https://api.github.com/users/MarkusSintonen/following{/other_user}", "gists_url": "https://api.github.com/users/MarkusSintonen/gists{/gist_id}", "starred_url": "https://api.github.com/users/MarkusSintonen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/MarkusSintonen/subscriptions", "organizations_url": "https://api.github.com/users/MarkusSintonen/orgs", "repos_url": "https://api.github.com/users/MarkusSintonen/repos", "events_url": "https://api.github.com/users/MarkusSintonen/events{/privacy}", "received_events_url": "https://api.github.com/users/MarkusSintonen/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 6426871392, "node_id": "LA_kwDOCZduT88AAAABfxJGYA", "url": "https://api.github.com/repos/fastapi/fastapi/labels/p2", "name": "p2", "color": "958029", "default": false, "description": ""}, {"id": 9229492097, "node_id": "LA_kwDOCZduT88AAAACJh7fgQ", "url": "https://api.github.com/repos/fastapi/fastapi/labels/conflicts", "name": "conflicts", "color": "ec4af9", "default": false, "description": "Automatically generated when a PR has a merge conflict"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 15, "created_at": "2024-03-17T14:01:00Z", "updated_at": "2026-02-05T18:48:51Z", "closed_at": "2026-02-05T18:48:51Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/11306", "html_url": "https://github.com/fastapi/fastapi/pull/11306", "diff_url": "https://github.com/fastapi/fastapi/pull/11306.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/11306.patch", "merged_at": null}, "body": "Fixes https://github.com/tiangolo/fastapi/issues/11134\r\n\r\nAdds support for Pydantic root model in query/path parameters. Supports PydaticV2 `RootModel[X]` and PydanticV1 `BaseModel.__root__`. This is a non breaking change as previously root models usage threw errors on route initialization when they were not used as bodies.\r\n\r\nAdds plenty of root model related tests.", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/11306/reactions", "total_count": 18, "+1": 18, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/11306/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/2939", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/2939/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/2939/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/2939/events", "html_url": "https://github.com/fastapi/fastapi/pull/2939", "id": 830337016, "node_id": "MDExOlB1bGxSZXF1ZXN0NTkxODY0MzMw", "number": 2939, "title": "\ud83d\udc1b Ensure that `HTTPDigest` only raises an exception when `auto_error is True`", "user": {"login": "arthurio", "id": 950449, "node_id": "MDQ6VXNlcjk1MDQ0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/950449?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arthurio", "html_url": "https://github.com/arthurio", "followers_url": "https://api.github.com/users/arthurio/followers", "following_url": "https://api.github.com/users/arthurio/following{/other_user}", "gists_url": "https://api.github.com/users/arthurio/gists{/gist_id}", "starred_url": "https://api.github.com/users/arthurio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arthurio/subscriptions", "organizations_url": "https://api.github.com/users/arthurio/orgs", "repos_url": "https://api.github.com/users/arthurio/repos", "events_url": "https://api.github.com/users/arthurio/events{/privacy}", "received_events_url": "https://api.github.com/users/arthurio/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 6426871392, "node_id": "LA_kwDOCZduT88AAAABfxJGYA", "url": "https://api.github.com/repos/fastapi/fastapi/labels/p2", "name": "p2", "color": "958029", "default": false, "description": ""}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 23, "created_at": "2021-03-12T17:59:47Z", "updated_at": "2025-02-27T16:53:44Z", "closed_at": "2025-02-27T12:29:20Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/2939", "html_url": "https://github.com/fastapi/fastapi/pull/2939", "diff_url": "https://github.com/fastapi/fastapi/pull/2939.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/2939.patch", "merged_at": "2025-02-27T12:29:20Z"}, "body": "I believe `HTTPDigest` should follow the same pattern as other authentication mechanisms and raise an exception only if `auto_error` is True.", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/2939/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/2939/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/4791", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/4791/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/4791/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/4791/events", "html_url": "https://github.com/fastapi/fastapi/pull/4791", "id": 1202310305, "node_id": "PR_kwDOCZduT842IFVB", "number": 4791, "title": "\ud83d\udc1b fix APIKey scheme name default", "user": {"login": "BilalAlpaslan", "id": 47563997, "node_id": "MDQ6VXNlcjQ3NTYzOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/47563997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/BilalAlpaslan", "html_url": "https://github.com/BilalAlpaslan", "followers_url": "https://api.github.com/users/BilalAlpaslan/followers", "following_url": "https://api.github.com/users/BilalAlpaslan/following{/other_user}", "gists_url": "https://api.github.com/users/BilalAlpaslan/gists{/gist_id}", "starred_url": "https://api.github.com/users/BilalAlpaslan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/BilalAlpaslan/subscriptions", "organizations_url": "https://api.github.com/users/BilalAlpaslan/orgs", "repos_url": "https://api.github.com/users/BilalAlpaslan/repos", "events_url": "https://api.github.com/users/BilalAlpaslan/events{/privacy}", "received_events_url": "https://api.github.com/users/BilalAlpaslan/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 6430361839, "node_id": "LA_kwDOCZduT88AAAABf0eI7w", "url": "https://api.github.com/repos/fastapi/fastapi/labels/p3", "name": "p3", "color": "4D3CC8", "default": false, "description": ""}, {"id": 7433382063, "node_id": "LA_kwDOCZduT88AAAABuxBorw", "url": "https://api.github.com/repos/fastapi/fastapi/labels/waiting", "name": "waiting", "color": "157B97", "default": false, "description": ""}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 21, "created_at": "2022-04-12T19:42:43Z", "updated_at": "2025-08-08T22:20:35Z", "closed_at": "2025-08-08T22:20:35Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/4791", "html_url": "https://github.com/fastapi/fastapi/pull/4791", "diff_url": "https://github.com/fastapi/fastapi/pull/4791.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/4791.patch", "merged_at": null}, "body": "```py\r\nfrom fastapi import FastAPI, Security\r\nfrom fastapi.security import api_key\r\n\r\napp = FastAPI()\r\n\r\napi_key_header_a = api_key.APIKeyHeader(name='key_a')\r\napi_key_header_b = api_key.APIKeyHeader(name='key_b')\r\n\r\n\r\n@app.get(\"/a\")\r\nasync def a(auth_token: str = Security(api_key_header_a)):\r\n    pass\r\n\r\n\r\n@app.get('/b')\r\nasync def b(auth_token: str = Security(api_key_header_b)):\r\n    pass\r\n```\r\nbefore schema name default is class name and second APIKey crush firsth APIKey ", "closed_by": {"login": "github-actions[bot]", "id": 41898282, "node_id": "MDM6Qm90NDE4OTgyODI=", "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4", "gravatar_id": "", "url": "https://api.github.com/users/github-actions%5Bbot%5D", "html_url": "https://github.com/apps/github-actions", "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers", "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos", "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events", "type": "Bot", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/4791/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/4791/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/13533", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/13533/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/13533/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/13533/events", "html_url": "https://github.com/fastapi/fastapi/issues/13533", "id": 2942725856, "node_id": "I_kwDOCZduT86vZm7g", "number": 13533, "title": "Multiple regressions in the handling of forms & form validation", "user": {"login": "MarinPostma", "id": 28804882, "node_id": "MDQ6VXNlcjI4ODA0ODgy", "avatar_url": "https://avatars.githubusercontent.com/u/28804882?v=4", "gravatar_id": "", "url": "https://api.github.com/users/MarinPostma", "html_url": "https://github.com/MarinPostma", "followers_url": "https://api.github.com/users/MarinPostma/followers", "following_url": "https://api.github.com/users/MarinPostma/following{/other_user}", "gists_url": "https://api.github.com/users/MarinPostma/gists{/gist_id}", "starred_url": "https://api.github.com/users/MarinPostma/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/MarinPostma/subscriptions", "organizations_url": "https://api.github.com/users/MarinPostma/orgs", "repos_url": "https://api.github.com/users/MarinPostma/repos", "events_url": "https://api.github.com/users/MarinPostma/events{/privacy}", "received_events_url": "https://api.github.com/users/MarinPostma/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 23, "created_at": "2025-03-24T10:13:27Z", "updated_at": "2025-12-02T04:41:06Z", "closed_at": "2025-12-02T04:39:57Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "\n\n### Issue Content\n\nWe have found at least 2 regression in the way forms are handled while trying to migrate to v0.115.11 from version v0.112.4. After investigation we were able to identify 2 commits that introduce 2 separate bugs that break the handling of default values in both `x-form-urlencoded` and `mutlipart` froms. Partial fixes have been proposed that also address a CVE, but the PR has been hanging since october 24.\n\n# Breaking in the handling of default value in `x-url-encoded` forms\n\nThis bug has been introduced in https://github.com/fastapi/fastapi/pull/12134.\n\nMRE:\n```python\napp = FastAPI()\n\n\n@app.post(\"/\")\ndef root(\n    name: Annotated[Optional[str], Form(embed=True)] = None,\n):\n    print(name)\n    return name\n```\n\nwith the following request:\n```\n\u276f http post -v --form localhost:8888 name=\"\"\nPOST / HTTP/1.1\nAccept: */*\nAccept-Encoding: gzip, deflate, br, zstd\nConnection: keep-alive\nContent-Length: 5\nContent-Type: application/x-www-form-urlencoded\nHost: localhost:8888\nUser-Agent: xh/0.24.0\n\nname=\n\nHTTP/1.1 200 OK\nContent-Length: 2\nContent-Type: application/json\nDate: Sun, 23 Mar 2025 21:01:49 GMT\nServer: uvicorn\n\n\"\"\n```\nThe expected result is that `None` is printed, but instead `\"\"` is printed.\n\nthis is the offending bit from the linked PR:\n```\ndiff --git a/fastapi/dependencies/utils.py b/fastapi/dependencies/utils.py\nindex 6083b731..db7eedba 100644\n--- a/fastapi/dependencies/utils.py\n+++ b/fastapi/dependencies/utils.py\n@@ -789,9 +789,9 @@ async def _extract_form_body(\n             value = serialize_sequence_value(field=field, value=results)\n         if value is not None:\n             values[field.name] = value\n-    for key, value in received_body.items():\n-        if key not in values:\n-            values[key] = value\n+    # for key, value in received_body.items():\n+    #     if key not in values:\n+    #         values[key] = value\n     return values\n```\nThis patch solves the x-form-urlencoded  case. So we indeed have two different regressions.\nThis _get_multi_dict_value  gets called for all fields in the schema: https://github.com/fastapi/fastapi/blob/4633b1bca933e68dac5c3bcce797ff5963debe2a/fastapi/dependencies/utils.py#L765-L765\nwe see here the special case for empty fields: https://github.com/fastapi/fastapi/blob/4633b1bca933e68dac5c3bcce797ff5963debe2a/fastapi/dependencies/utils.py#L695-L700\nThis bit here just blindly re-adds all fields from the body:    https://github.com/fastapi/fastapi/blob/4633b1bca933e68dac5c3bcce797ff5963debe2a/fastapi/dependencies/utils.py#L794-L796\n\nThis would be partially fixed by https://github.com/fastapi/fastapi/pull/12502/files, but also requires that ignored fields are not re-added to the form.\n\n\n# Breaking in the handling of default value in `multipart` forms\n\nThe breaking of multipart form originates from https://github.com/fastapi/fastapi/pull/12117 where the check for empty field was dropped https://github.com/fastapi/fastapi/pull/12117/files#diff-aef3dac481b68359f4edd6974fa3a047cfde595254a4567a560cebc9ccb0673fR669\n\nMRE:\n```python\napp = FastAPI()\n\n\n@app.post(\"/\")\ndef root(\n     file: Annotated[Optional[bytes], File()] = None,\n    name: Annotated[Optional[str], Form(embed=True)] = None,\n):\n    print(name)\n    print(file)\n    return name\n```\n\nThe same request as the previous bug yields name printing an empty string.\n\n\nBoth commits were identified by bisecting using the MREs in this issue\n\nThis also solves https://github.com/fastapi/fastapi/discussions/13255, but scanning through the issues of the repo it seems that there's a bunch of issue related to handling of default values in forms that I suspect may be linked to this issue.", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/13533/reactions", "total_count": 3, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 3, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/13533/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/11355", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/11355/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/11355/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/11355/events", "html_url": "https://github.com/fastapi/fastapi/pull/11355", "id": 2209810017, "node_id": "PR_kwDOCZduT85q4CDe", "number": 11355, "title": "\ud83d\udc1b Fix evaluating stringified annotations in Python 3.10", "user": {"login": "chaen", "id": 3728211, "node_id": "MDQ6VXNlcjM3MjgyMTE=", "avatar_url": "https://avatars.githubusercontent.com/u/3728211?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chaen", "html_url": "https://github.com/chaen", "followers_url": "https://api.github.com/users/chaen/followers", "following_url": "https://api.github.com/users/chaen/following{/other_user}", "gists_url": "https://api.github.com/users/chaen/gists{/gist_id}", "starred_url": "https://api.github.com/users/chaen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chaen/subscriptions", "organizations_url": "https://api.github.com/users/chaen/orgs", "repos_url": "https://api.github.com/users/chaen/repos", "events_url": "https://api.github.com/users/chaen/events{/privacy}", "received_events_url": "https://api.github.com/users/chaen/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 6426871392, "node_id": "LA_kwDOCZduT88AAAABfxJGYA", "url": "https://api.github.com/repos/fastapi/fastapi/labels/p2", "name": "p2", "color": "958029", "default": false, "description": ""}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 15, "created_at": "2024-03-27T04:13:14Z", "updated_at": "2025-12-10T12:11:47Z", "closed_at": "2025-12-04T08:18:32Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/11355", "html_url": "https://github.com/fastapi/fastapi/pull/11355", "diff_url": "https://github.com/fastapi/fastapi/pull/11355.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/11355.patch", "merged_at": "2025-12-04T08:18:32Z"}, "body": "I've bumped into the exact same issue as https://github.com/tiangolo/typer/discussions/598 so I solved it like https://github.com/tiangolo/typer/pull/721  :smile: \r\n\r\nI'll try to add tests soon but if you can do it faster, please feel free !!", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/11355/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/11355/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/10007", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/10007/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/10007/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/10007/events", "html_url": "https://github.com/fastapi/fastapi/issues/10007", "id": 1837139184, "node_id": "I_kwDOCZduT85tgITw", "number": 10007, "title": "Pydantic v2, dataclasses, UUID, and `__annotations__`", "user": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 23, "created_at": "2023-08-04T17:54:46Z", "updated_at": "2025-12-09T11:14:05Z", "closed_at": "2025-12-09T11:14:04Z", "assignee": null, "author_association": "MEMBER", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "### Privileged issue\n\n- [X] I'm @tiangolo or he asked me directly to create an issue here.\n\n### Issue Content\n\nThe combination of using:\r\n\r\n* Pydantic v2\r\n* dataclasses (instead of Pydantic models)\r\n* UUIDs\r\n* `from future import __annotations__`\r\n\r\nseems to break in a strange way.\r\n\r\nThis was original reported in this discussion by @sanzoghenzo: https://github.com/tiangolo/fastapi/discussions/9709#discussioncomment-6449458\r\n\r\nIn particular the comment by @raddevon with the minimal example by @fantix:\r\n\r\n```Python\r\nfrom __future__ import annotations\r\n\r\nimport uuid\r\nfrom dataclasses import dataclass, field\r\nfrom typing import List, Union\r\n\r\nfrom fastapi import FastAPI\r\n\r\n\r\n@dataclass\r\nclass Item:\r\n    id: uuid.UUID\r\n    name: str\r\n    price: float\r\n    tags: List[str] = field(default_factory=list)\r\n    description: Union[str, None] = None\r\n    tax: Union[float, None] = None\r\n\r\n\r\napp = FastAPI()\r\n\r\n\r\n@app.get(\"/items/next\", response_model=Item)\r\nasync def read_next_item():\r\n    return {\r\n        \"name\": \"Island In The Moon\",\r\n        \"price\": 12.99,\r\n        \"description\": \"A place to be be playin' and havin' fun\",\r\n        \"tags\": [\"breater\"],\r\n    }\r\n```\r\n\r\nStarting FastAPI with that breaks with an error of:\r\n\r\n<details>\r\n<summary>log</summary>\r\n\r\n```\r\nuvicorn main:app\r\nTraceback (most recent call last):\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/type_adapter.py\", line 165, in __init__\r\n    core_schema = _getattr_no_parents(type, '__pydantic_core_schema__')\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/type_adapter.py\", line 97, in _getattr_no_parents\r\n    raise AttributeError(attribute)\r\nAttributeError: __pydantic_core_schema__\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 625, in _resolve_forward_ref\r\n    obj = _typing_extra.evaluate_fwd_ref(obj, globalns=self._types_namespace)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_typing_extra.py\", line 423, in evaluate_fwd_ref\r\n    return ref._evaluate(globalns=globalns, localns=localns, recursive_guard=frozenset())\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/typing.py\", line 694, in _evaluate\r\n    eval(self.__forward_code__, globalns, localns),\r\n  File \"<string>\", line 1, in <module>\r\nNameError: name 'uuid' is not defined\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/user/code/fastapi/env3.10/bin/uvicorn\", line 8, in <module>\r\n    sys.exit(main())\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/click/core.py\", line 1130, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/click/core.py\", line 1055, in main\r\n    rv = self.invoke(ctx)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/click/core.py\", line 1404, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/click/core.py\", line 760, in invoke\r\n    return __callback(*args, **kwargs)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/uvicorn/main.py\", line 410, in main\r\n    run(\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/uvicorn/main.py\", line 578, in run\r\n    server.run()\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/uvicorn/server.py\", line 61, in run\r\n    return asyncio.run(self.serve(sockets=sockets))\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/asyncio/runners.py\", line 44, in run\r\n    return loop.run_until_complete(main)\r\n  File \"uvloop/loop.pyx\", line 1517, in uvloop.loop.Loop.run_until_complete\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/uvicorn/server.py\", line 68, in serve\r\n    config.load()\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/uvicorn/config.py\", line 473, in load\r\n    self.loaded_app = import_from_string(self.app)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/uvicorn/importer.py\", line 21, in import_from_string\r\n    module = importlib.import_module(module_str)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/importlib/__init__.py\", line 126, in import_module\r\n    return _bootstrap._gcd_import(name[level:], package, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1050, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 1027, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 1006, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 688, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 883, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\r\n  File \"/Users/user/code/fastapi/main.py\", line 24, in <module>\r\n    async def read_next_item():\r\n  File \"/Users/user/code/fastapi/fastapi/routing.py\", line 706, in decorator\r\n    self.add_api_route(\r\n  File \"/Users/user/code/fastapi/fastapi/routing.py\", line 645, in add_api_route\r\n    route = route_class(\r\n  File \"/Users/user/code/fastapi/fastapi/routing.py\", line 448, in __init__\r\n    self.response_field = create_response_field(\r\n  File \"/Users/user/code/fastapi/fastapi/utils.py\", line 99, in create_response_field\r\n    return ModelField(**kwargs)  # type: ignore[arg-type]\r\n  File \"<string>\", line 6, in __init__\r\n  File \"/Users/user/code/fastapi/fastapi/_compat.py\", line 101, in __post_init__\r\n    self._type_adapter: TypeAdapter[Any] = TypeAdapter(\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/type_adapter.py\", line 167, in __init__\r\n    core_schema = _get_schema(type, config_wrapper, parent_depth=_parent_depth + 1)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/type_adapter.py\", line 80, in _get_schema\r\n    schema = gen.generate_schema(type_)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 425, in generate_schema\r\n    return self._annotated_schema(obj)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 1464, in _annotated_schema\r\n    schema = self._apply_annotations(source_type, annotations)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 1586, in _apply_annotations\r\n    schema = get_inner_schema(source_type)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_schema_generation_shared.py\", line 82, in __call__\r\n    schema = self._handler(__source_type)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 1679, in new_handler\r\n    schema = metadata_get_schema(source, get_inner_schema)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 1675, in <lambda>\r\n    lambda source, handler: handler(source)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_schema_generation_shared.py\", line 82, in __call__\r\n    schema = self._handler(__source_type)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 1550, in inner_handler\r\n    schema = self._generate_schema(obj)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 689, in _generate_schema\r\n    return self.match_type(obj)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 763, in match_type\r\n    return self._dataclass_schema(obj, None)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 1317, in _dataclass_schema\r\n    args = sorted(\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 1318, in <genexpr>\r\n    (self._generate_dc_field_schema(k, v, decorators) for k, v in fields.items()),\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 865, in _generate_dc_field_schema\r\n    common_field = self._common_field_schema(name, field_info, decorators)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 900, in _common_field_schema\r\n    schema = self._apply_annotations(\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 1586, in _apply_annotations\r\n    schema = get_inner_schema(source_type)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_schema_generation_shared.py\", line 82, in __call__\r\n    schema = self._handler(__source_type)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 1550, in inner_handler\r\n    schema = self._generate_schema(obj)\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 679, in _generate_schema\r\n    return self.generate_schema(self._resolve_forward_ref(obj))\r\n  File \"/Users/user/code/fastapi/env3.10/lib/python3.10/site-packages/pydantic/_internal/_generate_schema.py\", line 627, in _resolve_forward_ref\r\n    raise PydanticUndefinedAnnotation.from_name_error(e) from e\r\npydantic.errors.PydanticUndefinedAnnotation: name 'uuid' is not defined\r\n\r\nFor further information visit https://errors.pydantic.dev/2.1.1/u/undefined-annotation\r\n```\r\n\r\n</summary>\r\n\r\nI still don't know if it's about which of these multiple interacting parts, I'm creating this issue to keep track of it.", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/10007/reactions", "total_count": 7, "+1": 6, "-1": 0, "laugh": 0, "hooray": 1, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/10007/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/2832", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/2832/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/2832/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/2832/events", "html_url": "https://github.com/fastapi/fastapi/issues/2832", "id": 811058719, "node_id": "MDU6SXNzdWU4MTEwNTg3MTk=", "number": 2832, "title": "FastAPI always returns content, even if 204 no content status code is set.", "user": {"login": "aviramha", "id": 41201924, "node_id": "MDQ6VXNlcjQxMjAxOTI0", "avatar_url": "https://avatars.githubusercontent.com/u/41201924?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aviramha", "html_url": "https://github.com/aviramha", "followers_url": "https://api.github.com/users/aviramha/followers", "following_url": "https://api.github.com/users/aviramha/following{/other_user}", "gists_url": "https://api.github.com/users/aviramha/gists{/gist_id}", "starred_url": "https://api.github.com/users/aviramha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aviramha/subscriptions", "organizations_url": "https://api.github.com/users/aviramha/orgs", "repos_url": "https://api.github.com/users/aviramha/repos", "events_url": "https://api.github.com/users/aviramha/events{/privacy}", "received_events_url": "https://api.github.com/users/aviramha/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 2109805297, "node_id": "MDU6TGFiZWwyMTA5ODA1Mjk3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/answered", "name": "answered", "color": "f6f6f6", "default": false, "description": ""}, {"id": 5182257681, "node_id": "LA_kwDOCZduT88AAAABNOL6EQ", "url": "https://api.github.com/repos/fastapi/fastapi/labels/reviewed", "name": "reviewed", "color": "BFD4F2", "default": false, "description": ""}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 23, "created_at": "2021-02-18T12:33:31Z", "updated_at": "2023-02-22T16:35:17Z", "closed_at": "2022-09-14T00:18:15Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "### First check\r\n\r\n* [x] I added a very descriptive title to this issue.\r\n* [x] I used the GitHub search to find a similar issue and didn't find it.\r\n* [x] I searched the FastAPI documentation, with the integrated search.\r\n* [x] I already searched in Google \"How to X in FastAPI\" and didn't find any information.\r\n* [x] I already read and followed all the tutorial in the docs and didn't find an answer.\r\n* [x] I already checked if it is not related to FastAPI but to [Pydantic](https://github.com/samuelcolvin/pydantic).\r\n* [x] I already checked if it is not related to FastAPI but to [Swagger UI](https://github.com/swagger-api/swagger-ui).\r\n* [x] I already checked if it is not related to FastAPI but to [ReDoc](https://github.com/Redocly/redoc).\r\n* [x] After submitting this, I commit to one of:\r\n    * Read open issues with questions until I find 2 issues where I can help someone and add a comment to help there.\r\n    * I already hit the \"watch\" button in this repository to receive notifications and I commit to help at least 2 people that ask questions in the future.\r\n    * Implement a Pull Request for a confirmed bug.\r\n### Example\r\n\r\n```Python\r\nfrom fastapi import FastAPI\r\nfrom starlette.status import HTTP_204_NO_CONTENT\r\napp = FastAPI()\r\n\r\n\r\n@app.get(\"/\", status_code=HTTP_204_NO_CONTENT)\r\ndef read_root():\r\n    print(\"d\")\r\n```\r\n\r\n\r\n\r\n### Description\r\n\r\nSend a request with any HTTP Client, observe the traffic using tcpdump/wireshark - you'll see that you get null as a response (content-length will be 4). This is extremely notable as this caused this issue https://github.com/encode/httpx/issues/1474 (The client doesn't expect any data in that case)\r\nI would expect FastAPI to not return null when response is None.\r\n\r\n### Environment\r\n\r\n* OS: macOS\r\n* FastAPI Version [e.g. 0.3.0]: 0.63.0\r\n* Python version: 0.63.0", "closed_by": {"login": "github-actions[bot]", "id": 41898282, "node_id": "MDM6Qm90NDE4OTgyODI=", "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4", "gravatar_id": "", "url": "https://api.github.com/users/github-actions%5Bbot%5D", "html_url": "https://github.com/apps/github-actions", "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers", "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos", "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events", "type": "Bot", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/2832/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/2832/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/12502", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/12502/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/12502/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/12502/events", "html_url": "https://github.com/fastapi/fastapi/pull/12502", "id": 2602012354, "node_id": "PR_kwDOCZduT85_Sy11", "number": 12502, "title": "\ud83d\udc1b Fix support for nullable form fields", "user": {"login": "maxclaey", "id": 17512341, "node_id": "MDQ6VXNlcjE3NTEyMzQx", "avatar_url": "https://avatars.githubusercontent.com/u/17512341?v=4", "gravatar_id": "", "url": "https://api.github.com/users/maxclaey", "html_url": "https://github.com/maxclaey", "followers_url": "https://api.github.com/users/maxclaey/followers", "following_url": "https://api.github.com/users/maxclaey/following{/other_user}", "gists_url": "https://api.github.com/users/maxclaey/gists{/gist_id}", "starred_url": "https://api.github.com/users/maxclaey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/maxclaey/subscriptions", "organizations_url": "https://api.github.com/users/maxclaey/orgs", "repos_url": "https://api.github.com/users/maxclaey/repos", "events_url": "https://api.github.com/users/maxclaey/events{/privacy}", "received_events_url": "https://api.github.com/users/maxclaey/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 7433382063, "node_id": "LA_kwDOCZduT88AAAABuxBorw", "url": "https://api.github.com/repos/fastapi/fastapi/labels/waiting", "name": "waiting", "color": "157B97", "default": false, "description": ""}, {"id": 9229492097, "node_id": "LA_kwDOCZduT88AAAACJh7fgQ", "url": "https://api.github.com/repos/fastapi/fastapi/labels/conflicts", "name": "conflicts", "color": "ec4af9", "default": false, "description": "Automatically generated when a PR has a merge conflict"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 15, "created_at": "2024-10-21T09:58:25Z", "updated_at": "2026-02-01T16:44:55Z", "closed_at": "2026-01-12T10:51:39Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/12502", "html_url": "https://github.com/fastapi/fastapi/pull/12502", "diff_url": "https://github.com/fastapi/fastapi/pull/12502.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/12502.patch", "merged_at": null}, "body": "Fix support for nullable form fields, differentiate between unspecified and specified as None. See related bug ticket https://github.com/fastapi/fastapi/issues/12245", "closed_by": {"login": "github-actions[bot]", "id": 41898282, "node_id": "MDM6Qm90NDE4OTgyODI=", "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4", "gravatar_id": "", "url": "https://api.github.com/users/github-actions%5Bbot%5D", "html_url": "https://github.com/apps/github-actions", "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers", "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos", "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events", "type": "Bot", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/12502/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/12502/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/14582", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/14582/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/14582/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/14582/events", "html_url": "https://github.com/fastapi/fastapi/pull/14582", "id": 3751224668, "node_id": "PR_kwDOCZduT866AmnL", "number": 14582, "title": "Also dump v2 models in `_prepare_response_content`", "user": {"login": "johnslavik", "id": 64036239, "node_id": "MDQ6VXNlcjY0MDM2MjM5", "avatar_url": "https://avatars.githubusercontent.com/u/64036239?v=4", "gravatar_id": "", "url": "https://api.github.com/users/johnslavik", "html_url": "https://github.com/johnslavik", "followers_url": "https://api.github.com/users/johnslavik/followers", "following_url": "https://api.github.com/users/johnslavik/following{/other_user}", "gists_url": "https://api.github.com/users/johnslavik/gists{/gist_id}", "starred_url": "https://api.github.com/users/johnslavik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/johnslavik/subscriptions", "organizations_url": "https://api.github.com/users/johnslavik/orgs", "repos_url": "https://api.github.com/users/johnslavik/repos", "events_url": "https://api.github.com/users/johnslavik/events{/privacy}", "received_events_url": "https://api.github.com/users/johnslavik/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 20, "created_at": "2025-12-21T14:59:36Z", "updated_at": "2025-12-22T19:34:00Z", "closed_at": "2025-12-22T19:10:46Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/14582", "html_url": "https://github.com/fastapi/fastapi/pull/14582", "diff_url": "https://github.com/fastapi/fastapi/pull/14582.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/14582.patch", "merged_at": null}, "body": "Corrects #14575 to also dump Pydantic v2 models in `_prepare_response_content`, fixing the regression.", "closed_by": {"login": "johnslavik", "id": 64036239, "node_id": "MDQ6VXNlcjY0MDM2MjM5", "avatar_url": "https://avatars.githubusercontent.com/u/64036239?v=4", "gravatar_id": "", "url": "https://api.github.com/users/johnslavik", "html_url": "https://github.com/johnslavik", "followers_url": "https://api.github.com/users/johnslavik/followers", "following_url": "https://api.github.com/users/johnslavik/following{/other_user}", "gists_url": "https://api.github.com/users/johnslavik/gists{/gist_id}", "starred_url": "https://api.github.com/users/johnslavik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/johnslavik/subscriptions", "organizations_url": "https://api.github.com/users/johnslavik/orgs", "repos_url": "https://api.github.com/users/johnslavik/repos", "events_url": "https://api.github.com/users/johnslavik/events{/privacy}", "received_events_url": "https://api.github.com/users/johnslavik/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/14582/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/14582/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/14616", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/14616/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/14616/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/14616/events", "html_url": "https://github.com/fastapi/fastapi/pull/14616", "id": 3765540745, "node_id": "PR_kwDOCZduT866u5hb", "number": 14616, "title": "\ud83d\udc1b Fix using `Json[list[str]]` type (issue #10997)", "user": {"login": "mkanetsuna", "id": 156692516, "node_id": "U_kgDOCVbwJA", "avatar_url": "https://avatars.githubusercontent.com/u/156692516?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mkanetsuna", "html_url": "https://github.com/mkanetsuna", "followers_url": "https://api.github.com/users/mkanetsuna/followers", "following_url": "https://api.github.com/users/mkanetsuna/following{/other_user}", "gists_url": "https://api.github.com/users/mkanetsuna/gists{/gist_id}", "starred_url": "https://api.github.com/users/mkanetsuna/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mkanetsuna/subscriptions", "organizations_url": "https://api.github.com/users/mkanetsuna/orgs", "repos_url": "https://api.github.com/users/mkanetsuna/repos", "events_url": "https://api.github.com/users/mkanetsuna/events{/privacy}", "received_events_url": "https://api.github.com/users/mkanetsuna/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 3, "created_at": "2025-12-28T10:25:02Z", "updated_at": "2026-02-09T17:20:59Z", "closed_at": "2026-02-05T18:41:43Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/14616", "html_url": "https://github.com/fastapi/fastapi/pull/14616", "diff_url": "https://github.com/fastapi/fastapi/pull/14616.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/14616.patch", "merged_at": "2026-02-05T18:41:43Z"}, "body": "Fixes Form() not working with Pydantic `Json[T]` types when T is a sequence type (list, set, tuple).\r\n\r\nCloses #10997\r\n\r\nWhen using `Form()` with `Json[list[str]]`, FastAPI incorrectly treated it as a sequence field and used `getlist()`, wrapping the JSON string in a list. This caused Pydantic to fail parsing with:\r\n```\r\nTypeError: JSON input should be string, bytes or bytearray\r\n```\r\n\r\n**Before fix:**\r\n```python\r\n# Client sends\r\ndata = {\"items\": '[\"abc\", \"def\"]'}  # JSON string\r\n\r\n# FastAPI incorrectly does\r\nvalue = values.getlist(\"items\")  # ['[\"abc\", \"def\"]']  \u274c\r\n```\r\n\r\n**After fix:**\r\n```python\r\n# FastAPI correctly does\r\nvalue = values.get(\"items\")  # '[\"abc\", \"def\"]'  \u2705\r\n```\r\n\r\nThis fix enables legitimate use cases like file uploads with JSON metadata:\r\n\r\n```python\r\n@app.post(\"/upload\")\r\ndef upload(\r\n    file: UploadFile,\r\n    tags: Annotated[Json[list[str]], Form()]\r\n):\r\n    return {\"file\": file.filename, \"tags\": tags}\r\n```\r\n\r\nPydantic v1 support for `Json[T]` with `Form()` is not included in this PR because `metadata` attribute does not exist in Pydantic v1's `FieldInfo`.\r\n\r\n## Related\r\n- Issue #10997", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/14616/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/14616/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/5861", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/5861/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/5861/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/5861/events", "html_url": "https://github.com/fastapi/fastapi/issues/5861", "id": 1525365311, "node_id": "I_kwDOCZduT85a6zo_", "number": 5861, "title": "fastapi.exceptions.FastAPIError: Invalid args for response field! Hint: check that <class 'starlette.responses.JSONResponse'> is a valid pydantic field type", "user": {"login": "zadigus", "id": 8761254, "node_id": "MDQ6VXNlcjg3NjEyNTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/8761254?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zadigus", "html_url": "https://github.com/zadigus", "followers_url": "https://api.github.com/users/zadigus/followers", "following_url": "https://api.github.com/users/zadigus/following{/other_user}", "gists_url": "https://api.github.com/users/zadigus/gists{/gist_id}", "starred_url": "https://api.github.com/users/zadigus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zadigus/subscriptions", "organizations_url": "https://api.github.com/users/zadigus/orgs", "repos_url": "https://api.github.com/users/zadigus/repos", "events_url": "https://api.github.com/users/zadigus/events{/privacy}", "received_events_url": "https://api.github.com/users/zadigus/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 2109805297, "node_id": "MDU6TGFiZWwyMTA5ODA1Mjk3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/answered", "name": "answered", "color": "f6f6f6", "default": false, "description": ""}, {"id": 5182257681, "node_id": "LA_kwDOCZduT88AAAABNOL6EQ", "url": "https://api.github.com/repos/fastapi/fastapi/labels/reviewed", "name": "reviewed", "color": "BFD4F2", "default": false, "description": ""}], "state": "closed", "locked": true, "assignees": [], "milestone": null, "comments": 18, "created_at": "2023-01-09T11:05:37Z", "updated_at": "2023-09-27T12:34:32Z", "closed_at": "2023-02-06T11:08:59Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": "resolved", "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "### First Check\n\n- [X] I added a very descriptive title to this issue.\n- [X] I used the GitHub search to find a similar issue and didn't find it.\n- [X] I searched the FastAPI documentation, with the integrated search.\n- [X] I already searched in Google \"How to X in FastAPI\" and didn't find any information.\n- [X] I already read and followed all the tutorial in the docs and didn't find an answer.\n- [X] I already checked if it is not related to FastAPI but to [Pydantic](https://github.com/samuelcolvin/pydantic).\n- [X] I already checked if it is not related to FastAPI but to [Swagger UI](https://github.com/swagger-api/swagger-ui).\n- [X] I already checked if it is not related to FastAPI but to [ReDoc](https://github.com/Redocly/redoc).\n\n### Commit to Help\n\n- [X] I commit to help with one of those options \ud83d\udc46\n\n### Example Code\n\n```python\nimport logging\r\n\r\nfrom fastapi import APIRouter\r\nfrom fastapi.responses import JSONResponse\r\n\r\nliveness = True\r\n\r\nrouter = APIRouter()\r\n\r\n\r\n@router.get(\r\n    \"/livez\",\r\n    summary=\"Liveness probe\",\r\n    description=\"Returns 200 if the service is alive\",\r\n)\r\nasync def get_liveness() -> JSONResponse:\r\n    logging.debug(\"GET /livez\")\r\n    if liveness:\r\n        return JSONResponse(status_code=200, content={\"status\": \"ok\"})\r\n    else:\r\n        return JSONResponse(status_code=500, content={\"status\": \"not ok\"})\n```\n\n\n### Description\n\nWith version 0.88.0, my unit tests run fine, I get no error. With version 0.89.0, I get the following error:\r\n\r\n```\r\n/root/.pyenv/versions/3.8/lib/python3.8/importlib/__init__.py:127: in import_module\r\n    return _bootstrap._gcd_import(name[level:], package, level)\r\n<frozen importlib._bootstrap>:1014: in _gcd_import\r\n    ???\r\n<frozen importlib._bootstrap>:991: in _find_and_load\r\n    ???\r\n<frozen importlib._bootstrap>:975: in _find_and_load_unlocked\r\n    ???\r\n<frozen importlib._bootstrap>:671: in _load_unlocked\r\n    ???\r\n/root/.pyenv/versions/3.8/lib/python3.8/site-packages/_pytest/assertion/rewrite.py:168: in exec_module\r\n    exec(co, module.__dict__)\r\ntests/models/conftest.py:7: in <module>\r\n    from my_sample_lib.main import app\r\nmy_sample_lib/main.py:10: in <module>\r\n    from my_sample_lib.health.router import router as health_router\r\nmy_sample_lib/health/router.py:24: in <module>\r\n    async def get_liveness() -> JSONResponse:\r\n/root/.pyenv/versions/3.8/lib/python3.8/site-packages/fastapi/routing.py:633: in decorator\r\n    self.add_api_route(\r\n/root/.pyenv/versions/3.8/lib/python3.8/site-packages/fastapi/routing.py:572: in add_api_route\r\n    route = route_class(\r\n/root/.pyenv/versions/3.8/lib/python3.8/site-packages/fastapi/routing.py:400: in __init__\r\n    self.response_field = create_response_field(\r\n/root/.pyenv/versions/3.8/lib/python3.8/site-packages/fastapi/utils.py:90: in create_response_field\r\n    raise fastapi.exceptions.FastAPIError(\r\nE   fastapi.exceptions.FastAPIError: Invalid args for response field! Hint: check that <class 'starlette.responses.JSONResponse'> is a valid pydantic field type\r\n```\r\n\r\nThe only way I found to get rid of the error is to remove the type hint, which I don't really want. Also, I tried to follow the guidelines provided in [your documentation](https://fastapi.tiangolo.com/advanced/response-directly/) without success. \r\n\r\nInterestingly, the whole thing works fine (with the type hint and fastapi 0.89.0) under Windows 10. Under Ubuntu 22.10, it doesn't work at all (i.e. it provides the above message).\n\n### Operating System\n\nLinux\n\n### Operating System Details\n\nUnder Windows 10, it works like a charm. Under Ubuntu 22.10, it fails with the provided error above.\n\n### FastAPI Version\n\n0.89.0\n\n### Python Version\n\n3.8.12\n\n### Additional Context\n\nIt is also failing with python 3.9, and 3.10.", "closed_by": {"login": "github-actions[bot]", "id": 41898282, "node_id": "MDM6Qm90NDE4OTgyODI=", "avatar_url": "https://avatars.githubusercontent.com/in/15368?v=4", "gravatar_id": "", "url": "https://api.github.com/users/github-actions%5Bbot%5D", "html_url": "https://github.com/apps/github-actions", "followers_url": "https://api.github.com/users/github-actions%5Bbot%5D/followers", "following_url": "https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/github-actions%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/github-actions%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/github-actions%5Bbot%5D/repos", "events_url": "https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/github-actions%5Bbot%5D/received_events", "type": "Bot", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/5861/reactions", "total_count": 10, "+1": 8, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 2}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/5861/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/5823", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/5823/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/5823/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/5823/events", "html_url": "https://github.com/fastapi/fastapi/pull/5823", "id": 1514865576, "node_id": "PR_kwDOCZduT85GaGSv", "number": 5823, "title": "\ud83d\udc1b Preserve traceback when an exception is raised in sync dependency with `yield`", "user": {"login": "sombek", "id": 20394589, "node_id": "MDQ6VXNlcjIwMzk0NTg5", "avatar_url": "https://avatars.githubusercontent.com/u/20394589?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sombek", "html_url": "https://github.com/sombek", "followers_url": "https://api.github.com/users/sombek/followers", "following_url": "https://api.github.com/users/sombek/following{/other_user}", "gists_url": "https://api.github.com/users/sombek/gists{/gist_id}", "starred_url": "https://api.github.com/users/sombek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sombek/subscriptions", "organizations_url": "https://api.github.com/users/sombek/orgs", "repos_url": "https://api.github.com/users/sombek/repos", "events_url": "https://api.github.com/users/sombek/events{/privacy}", "received_events_url": "https://api.github.com/users/sombek/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 14, "created_at": "2022-12-30T21:46:35Z", "updated_at": "2024-12-03T22:45:46Z", "closed_at": "2024-12-03T22:37:12Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/5823", "html_url": "https://github.com/fastapi/fastapi/pull/5823", "diff_url": "https://github.com/fastapi/fastapi/pull/5823.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/5823.patch", "merged_at": "2024-12-03T22:37:12Z"}, "body": "There is a missing of traceback when an exception raised in contextmanager_in_threadpool\r\nHappens on Python 3.11 \r\n\r\nI noticed the exception.traceback gets flushed after exiting the context manager.\r\n\r\nThere is an issue is opened #5740 \r\n\r\nEdit by @Kludex : \r\n- Closes https://github.com/fastapi/fastapi/issues/13022", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/5823/reactions", "total_count": 16, "+1": 9, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 3, "rocket": 4, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/5823/timeline", "performed_via_github_app": null, "state_reason": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/4939", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/4939/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/4939/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/4939/events", "html_url": "https://github.com/fastapi/fastapi/issues/4939", "id": 1244915501, "node_id": "I_kwDOCZduT85KM-ct", "number": 4939, "title": "Response content longer than Content-Length error for DELETE and NoContent", "user": {"login": "myslak71", "id": 43068450, "node_id": "MDQ6VXNlcjQzMDY4NDUw", "avatar_url": "https://avatars.githubusercontent.com/u/43068450?v=4", "gravatar_id": "", "url": "https://api.github.com/users/myslak71", "html_url": "https://github.com/myslak71", "followers_url": "https://api.github.com/users/myslak71/followers", "following_url": "https://api.github.com/users/myslak71/following{/other_user}", "gists_url": "https://api.github.com/users/myslak71/gists{/gist_id}", "starred_url": "https://api.github.com/users/myslak71/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/myslak71/subscriptions", "organizations_url": "https://api.github.com/users/myslak71/orgs", "repos_url": "https://api.github.com/users/myslak71/repos", "events_url": "https://api.github.com/users/myslak71/events{/privacy}", "received_events_url": "https://api.github.com/users/myslak71/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 2109805297, "node_id": "MDU6TGFiZWwyMTA5ODA1Mjk3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/answered", "name": "answered", "color": "f6f6f6", "default": false, "description": ""}, {"id": 5182257681, "node_id": "LA_kwDOCZduT88AAAABNOL6EQ", "url": "https://api.github.com/repos/fastapi/fastapi/labels/reviewed", "name": "reviewed", "color": "BFD4F2", "default": false, "description": ""}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 18, "created_at": "2022-05-23T10:05:51Z", "updated_at": "2024-08-05T03:03:28Z", "closed_at": "2022-09-03T16:40:39Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "### First Check\r\n\r\n- [X] I added a very descriptive title to this issue.\r\n- [X] I used the GitHub search to find a similar issue and didn't find it.\r\n- [X] I searched the FastAPI documentation, with the integrated search.\r\n- [X] I already searched in Google \"How to X in FastAPI\" and didn't find any information.\r\n- [X] I already read and followed all the tutorial in the docs and didn't find an answer.\r\n- [X] I already checked if it is not related to FastAPI but to [Pydantic](https://github.com/samuelcolvin/pydantic).\r\n- [X] I already checked if it is not related to FastAPI but to [Swagger UI](https://github.com/swagger-api/swagger-ui).\r\n- [X] I already checked if it is not related to FastAPI but to [ReDoc](https://github.com/Redocly/redoc).\r\n\r\n### Commit to Help\r\n\r\n- [X] I commit to help with one of those options \ud83d\udc46\r\n\r\n### Example Code\r\n\r\n```python\r\nfrom fastapi import FastAPI, status\r\n\r\napp = FastAPI()\r\n\r\n\r\n@app.delete(\"/\", status_code=status.HTTP_204_NO_CONTENT)\r\ndef read_root():\r\n    return None\r\n```\r\n\r\n\r\n### Description\r\n\r\nUpon requesting above code I got expected response but my logs shows that there is an error in uvicorn. The problem exists for DELETE method and NoContent response status code (for HEAD there is no such problem)\r\n\r\n```INFO:     127.0.0.1:46932 - \"DELETE / HTTP/1.1\" 204 No Content\r\nERROR:    Exception in ASGI application\r\nTraceback (most recent call last):\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/uvicorn/protocols/http/httptools_impl.py\", line 372, in run_asgi\r\n    result = await app(self.scope, self.receive, self.send)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py\", line 75, in __call__\r\n    return await self.app(scope, receive, send)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/fastapi/applications.py\", line 269, in __call__\r\n    await super().__call__(scope, receive, send)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/applications.py\", line 124, in __call__\r\n    await self.middleware_stack(scope, receive, send)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/middleware/errors.py\", line 184, in __call__\r\n    raise exc\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/middleware/errors.py\", line 162, in __call__\r\n    await self.app(scope, receive, _send)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/exceptions.py\", line 93, in __call__\r\n    raise exc\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/exceptions.py\", line 82, in __call__\r\n    await self.app(scope, receive, sender)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py\", line 21, in __call__\r\n    raise e\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\r\n    await self.app(scope, receive, send)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/routing.py\", line 670, in __call__\r\n    await route.handle(scope, receive, send)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/routing.py\", line 266, in handle\r\n    await self.app(scope, receive, send)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/routing.py\", line 68, in app\r\n    await response(scope, receive, send)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/responses.py\", line 162, in __call__\r\n    await send({\"type\": \"http.response.body\", \"body\": self.body})\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/exceptions.py\", line 79, in sender\r\n    await send(message)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/starlette/middleware/errors.py\", line 159, in _send\r\n    await send(message)\r\n  File \"/home/user/PycharmProjects/sample_app/venv/lib/python3.9/site-packages/uvicorn/protocols/http/httptools_impl.py\", line 501, in send\r\n    raise RuntimeError(\"Response content longer than Content-Length\")\r\nRuntimeError: Response content longer than Content-Length```\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### Operating System Details\r\n\r\n_No response_\r\n\r\n### FastAPI Version\r\n\r\n0.78.0\r\n\r\n### Python Version\r\n\r\n3.10\r\n\r\n### Additional Context\r\n\r\n_No response_", "closed_by": {"login": "myslak71", "id": 43068450, "node_id": "MDQ6VXNlcjQzMDY4NDUw", "avatar_url": "https://avatars.githubusercontent.com/u/43068450?v=4", "gravatar_id": "", "url": "https://api.github.com/users/myslak71", "html_url": "https://github.com/myslak71", "followers_url": "https://api.github.com/users/myslak71/followers", "following_url": "https://api.github.com/users/myslak71/following{/other_user}", "gists_url": "https://api.github.com/users/myslak71/gists{/gist_id}", "starred_url": "https://api.github.com/users/myslak71/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/myslak71/subscriptions", "organizations_url": "https://api.github.com/users/myslak71/orgs", "repos_url": "https://api.github.com/users/myslak71/repos", "events_url": "https://api.github.com/users/myslak71/events{/privacy}", "received_events_url": "https://api.github.com/users/myslak71/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/4939/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/4939/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/829", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/829/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/829/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/829/events", "html_url": "https://github.com/fastapi/fastapi/issues/829", "id": 545810676, "node_id": "MDU6SXNzdWU1NDU4MTA2NzY=", "number": 829, "title": "OpenAPI routes do not acknowledge root_path", "user": {"login": "sm-Fifteen", "id": 516999, "node_id": "MDQ6VXNlcjUxNjk5OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/516999?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sm-Fifteen", "html_url": "https://github.com/sm-Fifteen", "followers_url": "https://api.github.com/users/sm-Fifteen/followers", "following_url": "https://api.github.com/users/sm-Fifteen/following{/other_user}", "gists_url": "https://api.github.com/users/sm-Fifteen/gists{/gist_id}", "starred_url": "https://api.github.com/users/sm-Fifteen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sm-Fifteen/subscriptions", "organizations_url": "https://api.github.com/users/sm-Fifteen/orgs", "repos_url": "https://api.github.com/users/sm-Fifteen/repos", "events_url": "https://api.github.com/users/sm-Fifteen/events{/privacy}", "received_events_url": "https://api.github.com/users/sm-Fifteen/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 2109805297, "node_id": "MDU6TGFiZWwyMTA5ODA1Mjk3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/answered", "name": "answered", "color": "f6f6f6", "default": false, "description": ""}, {"id": 5182257681, "node_id": "LA_kwDOCZduT88AAAABNOL6EQ", "url": "https://api.github.com/repos/fastapi/fastapi/labels/reviewed", "name": "reviewed", "color": "BFD4F2", "default": false, "description": ""}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 18, "created_at": "2020-01-06T16:16:15Z", "updated_at": "2023-12-06T16:49:34Z", "closed_at": "2020-07-11T17:19:57Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Also raised on https://github.com/tiangolo/fastapi/pull/26#issuecomment-562755647. See also #544.\r\n\r\n### Describe the bug\r\n\r\nWrite here a clear and concise description of what the bug is.\r\n\r\n### To Reproduce\r\n\r\nReplace each part with your own scenario:\r\n\r\n1. Create a file with:\r\n\r\n```Python\r\nfrom fastapi import FastAPI\r\n\r\napp = FastAPI()\r\n\r\n@app.get(\"/app\")\r\ndef read_root():\r\n    return {\"Hello\": \"World\"}\r\n```\r\n\r\n2. Launch it using `uvicorn --root-path=\"bar\" test_app:app`\r\n3. Open the browser and go to `http://127.0.0.1:8000/docs`.\r\n4. From the documentation, call the `GET /app` route.\r\n5. The doc page calls `/app` and succeeds.\r\n\r\n### Expected behavior\r\n\r\nThe above test should fail after having called `/bar/app`, since `root_path` is supposed to prefix all generated URLs in case the application is served behind a reverse-proxy, among ther things. FastAPI only acknowledges `openapi_prefix` for the API doc.\r\n\r\n### Environment\r\n\r\n- OS: Windows\r\n- FastAPI Version: 0.45.0\r\n- Python version: 3.8.0\r\n\r\n### Additional context\r\n\r\nA similar issue applies to sub-applications:\r\n\r\n```py\r\nfrom fastapi import FastAPI\r\n\r\napp = FastAPI()\r\n\r\n\r\n@app.get(\"/app\")\r\ndef read_main():\r\n    return {\"message\": \"Hello World from main app\"}\r\n\r\n\r\n#subapi = FastAPI(openapi_prefix=\"/subapi\")\r\nsubapi = FastAPI()\r\n\r\n@subapi.get(\"/sub\")\r\ndef read_sub(request: Request):\r\n    return {\r\n        \"root_path\": request.scope['root_path'],\r\n        \"raw_path\": request.scope['raw_path'],\r\n        \"path\": request.scope['path'],\r\n        \"app_url_for\": app.url_path_for(\"read_sub\"),\r\n        \"subapp_url_for\": subapi.url_path_for(\"read_sub\"),\r\n    }\r\n\r\napp.mount(\"/subapi\", subapi)\r\n```\r\n\r\n```json\r\n{\r\n  \"root_path\":\"bar/subapi\",\r\n  \"raw_path\":\"/subapi/sub\",\r\n  \"path\":\"/sub\",\r\n  \"app_url_for\":\"/subapi/sub\",\r\n  \"subapp_url_for\":\"/sub\"\r\n}\r\n```\r\n\r\n(`url_for` not being prefixed with `root_path` is fixed upstream by encode/starlette#699)\r\n\r\nUnless `openapi_prefix=\"/subapi\"` is passed when creating the subapplication, both `http://127.0.0.1:8000/docs` and `http://127.0.0.1:8000/subapi/docs` will point towards `http://127.0.0.1:8000/openapi.json`, which goes against the point of having isolated subapplications.\r\n\r\n`openapi_prefix` should probably just be deprecated and assumed to match `root_path` if absent.\r\n", "closed_by": {"login": "sm-Fifteen", "id": 516999, "node_id": "MDQ6VXNlcjUxNjk5OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/516999?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sm-Fifteen", "html_url": "https://github.com/sm-Fifteen", "followers_url": "https://api.github.com/users/sm-Fifteen/followers", "following_url": "https://api.github.com/users/sm-Fifteen/following{/other_user}", "gists_url": "https://api.github.com/users/sm-Fifteen/gists{/gist_id}", "starred_url": "https://api.github.com/users/sm-Fifteen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sm-Fifteen/subscriptions", "organizations_url": "https://api.github.com/users/sm-Fifteen/orgs", "repos_url": "https://api.github.com/users/sm-Fifteen/repos", "events_url": "https://api.github.com/users/sm-Fifteen/events{/privacy}", "received_events_url": "https://api.github.com/users/sm-Fifteen/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/829/reactions", "total_count": 19, "+1": 19, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/829/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/fastapi/fastapi/issues/12197", "repository_url": "https://api.github.com/repos/fastapi/fastapi", "labels_url": "https://api.github.com/repos/fastapi/fastapi/issues/12197/labels{/name}", "comments_url": "https://api.github.com/repos/fastapi/fastapi/issues/12197/comments", "events_url": "https://api.github.com/repos/fastapi/fastapi/issues/12197/events", "html_url": "https://github.com/fastapi/fastapi/pull/12197", "id": 2524776673, "node_id": "PR_kwDOCZduT857boSv", "number": 12197, "title": "\ud83d\udc1b Remove `Required` shadowing from fastapi using Pydantic v2", "user": {"login": "pachewise", "id": 2257119, "node_id": "MDQ6VXNlcjIyNTcxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2257119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pachewise", "html_url": "https://github.com/pachewise", "followers_url": "https://api.github.com/users/pachewise/followers", "following_url": "https://api.github.com/users/pachewise/following{/other_user}", "gists_url": "https://api.github.com/users/pachewise/gists{/gist_id}", "starred_url": "https://api.github.com/users/pachewise/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pachewise/subscriptions", "organizations_url": "https://api.github.com/users/pachewise/orgs", "repos_url": "https://api.github.com/users/pachewise/repos", "events_url": "https://api.github.com/users/pachewise/events{/privacy}", "received_events_url": "https://api.github.com/users/pachewise/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 1154536357, "node_id": "MDU6TGFiZWwxMTU0NTM2MzU3", "url": "https://api.github.com/repos/fastapi/fastapi/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 11, "created_at": "2024-09-13T12:53:02Z", "updated_at": "2024-10-15T17:37:28Z", "closed_at": "2024-10-12T09:36:32Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "draft": false, "pull_request": {"url": "https://api.github.com/repos/fastapi/fastapi/pulls/12197", "html_url": "https://github.com/fastapi/fastapi/pull/12197", "diff_url": "https://github.com/fastapi/fastapi/pull/12197.diff", "patch_url": "https://github.com/fastapi/fastapi/pull/12197.patch", "merged_at": "2024-10-12T09:36:32Z"}, "body": "Re:\r\n* https://github.com/vllm-project/vllm/issues/8212\r\n* https://github.com/vllm-project/vllm/issues/8450\r\n* https://github.com/fastapi/fastapi/discussions/11952\r\n\r\n(and potentially others)\r\n\r\nI think I found the underlying cause. We're still supporting `pydantic.Required` in FastAPI, which has the possibility to shadow the new `Required` type. To me, this seems like a Pydantic + fastapi bug. Here's how 0.113.0 introduced it:\r\n\r\n1. `fastapi` has the new `get_model_fields()` function, which deals with `TypeAdapter()`, and is called for every field\r\n2. TypeAdapter gets a `globalns` from the `sys._getframe()`, meaning it gets the ns from `_compat`. This is important because pydantic bases their type evaluations from that `globalns`. Why they are doing this is a question for later.\r\n3. Because `Required = PydanticUndefined` is in _compat.py, we are getting that value set in the `globalns`\r\n4. Independently, `openai` uses `TypedDict` with the `Required` annotations in its fields.\r\n4. `vllm` (and potentially other libs) uses `fastapi` + `pydantic` + `openai` TypedDict classes\r\n\r\nThe smoking gun was: `TypeError: 'pydantic_core._pydantic_core.PydanticUndefinedType' object is not subscriptable`\r\n\r\nFocusing on https://github.com/vllm-project/vllm/issues/8450, the offending type annotation was `Required[Union[str, Iterable[X]]`. It needed to have been `Required` that was a `PydanticUndefinedType`, otherwise it would be complaining about `Union[str, Iterable[X]]`, or some other annotation. I ran the snippet [here](https://github.com/fastapi/fastapi/issues/12133#issuecomment-2342858880) using `fastapi 0.114.1, pydantic 2.9.0, vllm 0.6.1, python = 3.8.20`, and was able to reproduce the issue again. Using `pdb.pm()`, I was able to inspect the globalns and connect the dots.\r\n\r\n# How to test\r\n\r\nRun the code example in [this](https://github.com/fastapi/fastapi/issues/12133#issuecomment-2342858880) comment Python 3.8. It will fail without the changes, and pass with the changes. \r\n\r\n", "closed_by": {"login": "tiangolo", "id": 1326112, "node_id": "MDQ6VXNlcjEzMjYxMTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1326112?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tiangolo", "html_url": "https://github.com/tiangolo", "followers_url": "https://api.github.com/users/tiangolo/followers", "following_url": "https://api.github.com/users/tiangolo/following{/other_user}", "gists_url": "https://api.github.com/users/tiangolo/gists{/gist_id}", "starred_url": "https://api.github.com/users/tiangolo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tiangolo/subscriptions", "organizations_url": "https://api.github.com/users/tiangolo/orgs", "repos_url": "https://api.github.com/users/tiangolo/repos", "events_url": "https://api.github.com/users/tiangolo/events{/privacy}", "received_events_url": "https://api.github.com/users/tiangolo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/fastapi/fastapi/issues/12197/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/fastapi/fastapi/issues/12197/timeline", "performed_via_github_app": null, "state_reason": null}]}