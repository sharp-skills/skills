{"d": [{"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/310", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/310/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/310/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/310/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/310", "id": 3113121006, "node_id": "I_kwDOB-MyFM65jnTu", "number": 310, "title": "DynamoDB TTL Experience: \"get\" method must return null when item has expired", "user": {"login": "hffmnn", "id": 352753, "node_id": "MDQ6VXNlcjM1Mjc1Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/352753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hffmnn", "html_url": "https://github.com/hffmnn", "followers_url": "https://api.github.com/users/hffmnn/followers", "following_url": "https://api.github.com/users/hffmnn/following{/other_user}", "gists_url": "https://api.github.com/users/hffmnn/gists{/gist_id}", "starred_url": "https://api.github.com/users/hffmnn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hffmnn/subscriptions", "organizations_url": "https://api.github.com/users/hffmnn/orgs", "repos_url": "https://api.github.com/users/hffmnn/repos", "events_url": "https://api.github.com/users/hffmnn/events{/privacy}", "received_events_url": "https://api.github.com/users/hffmnn/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 11, "created_at": "2025-06-03T09:11:51Z", "updated_at": "2025-12-13T10:05:03Z", "closed_at": "2025-12-13T10:05:03Z", "assignee": null, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Hi,\n\nI am trying to add a rate limiter to an app with the `RateLimiterDynamo` class. The `key` and `expire` get written to the table but expired items don't get deleted. When searching for TTL and DynamoDB it brings up a lot of threads that say, that one shouldn't rely on TTL values of DynamoDB, e.g. [this on Stackoverflow](https://stackoverflow.com/a/77316267).\n\n\nI wonder:\n- if anyone else has experienced the same and found a workaround\n- is anyone useing `RateLimiterDynamo` in production", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/310/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/310/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/238", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/238/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/238/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/238/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/238", "id": 2021642836, "node_id": "I_kwDOB-MyFM54f9JU", "number": 238, "title": "RateLimiterMemory msBeforeNext is negative in Vercel edge function", "user": {"login": "leo-cheron", "id": 418965, "node_id": "MDQ6VXNlcjQxODk2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/418965?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leo-cheron", "html_url": "https://github.com/leo-cheron", "followers_url": "https://api.github.com/users/leo-cheron/followers", "following_url": "https://api.github.com/users/leo-cheron/following{/other_user}", "gists_url": "https://api.github.com/users/leo-cheron/gists{/gist_id}", "starred_url": "https://api.github.com/users/leo-cheron/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leo-cheron/subscriptions", "organizations_url": "https://api.github.com/users/leo-cheron/orgs", "repos_url": "https://api.github.com/users/leo-cheron/repos", "events_url": "https://api.github.com/users/leo-cheron/events{/privacy}", "received_events_url": "https://api.github.com/users/leo-cheron/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [{"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}], "milestone": null, "comments": 8, "created_at": "2023-12-01T22:01:34Z", "updated_at": "2024-04-19T15:35:06Z", "closed_at": "2023-12-11T13:48:41Z", "assignee": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "I've been testing this lib on a nextjs edge middleware hosted on Vercel, and I'm facing an issue where `msBeforeNext` would not be reset when its value is < 0, or randomly after waiting for a bit (probably edge function being cold?). The value will continue being decremented under 0 and point won't be reset.\r\n\r\nHere's a simplified version of the middleware:\r\n\r\n```js\r\nconst rateLimiter = new RateLimiterMemory({\r\n\tpoints: 20,\r\n\tduration: 5,\r\n})\r\n\r\nexport const middleware = async (req: NextRequest) => {\r\n\ttry {\r\n\t\tconst res = await rateLimiter.consume(req.ip, 1)\r\n\t} catch (error) {\r\n\t\treturn NextResponse.rewrite(new URL('/429', req.url), {status: 429})\r\n\t}\r\n\r\n\treturn NextResponse.next()\r\n}\r\n```\r\n\r\nCatched error would return an object like:\r\n\r\n```js\r\n{\r\n  _remainingPoints: 15,\r\n  _msBeforeNext: -2009,\r\n  _consumedPoints: 5,\r\n  _isFirstInDuration: false\r\n}\r\n```", "closed_by": {"login": "leo-cheron", "id": 418965, "node_id": "MDQ6VXNlcjQxODk2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/418965?v=4", "gravatar_id": "", "url": "https://api.github.com/users/leo-cheron", "html_url": "https://github.com/leo-cheron", "followers_url": "https://api.github.com/users/leo-cheron/followers", "following_url": "https://api.github.com/users/leo-cheron/following{/other_user}", "gists_url": "https://api.github.com/users/leo-cheron/gists{/gist_id}", "starred_url": "https://api.github.com/users/leo-cheron/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/leo-cheron/subscriptions", "organizations_url": "https://api.github.com/users/leo-cheron/orgs", "repos_url": "https://api.github.com/users/leo-cheron/repos", "events_url": "https://api.github.com/users/leo-cheron/events{/privacy}", "received_events_url": "https://api.github.com/users/leo-cheron/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/238/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/238/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/226", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/226/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/226/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/226/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/226", "id": 1949844098, "node_id": "I_kwDOB-MyFM50OEKC", "number": 226, "title": "Unable to use table with schema name", "user": {"login": "paulsc54", "id": 100230730, "node_id": "U_kgDOBflmSg", "avatar_url": "https://avatars.githubusercontent.com/u/100230730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/paulsc54", "html_url": "https://github.com/paulsc54", "followers_url": "https://api.github.com/users/paulsc54/followers", "following_url": "https://api.github.com/users/paulsc54/following{/other_user}", "gists_url": "https://api.github.com/users/paulsc54/gists{/gist_id}", "starred_url": "https://api.github.com/users/paulsc54/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/paulsc54/subscriptions", "organizations_url": "https://api.github.com/users/paulsc54/orgs", "repos_url": "https://api.github.com/users/paulsc54/repos", "events_url": "https://api.github.com/users/paulsc54/events{/privacy}", "received_events_url": "https://api.github.com/users/paulsc54/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 7, "created_at": "2023-10-18T14:04:46Z", "updated_at": "2023-10-20T08:30:01Z", "closed_at": "2023-10-20T08:24:39Z", "assignee": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Hi there,\r\n\r\nWe are using your library with the postgres driver and a table defined in a different schema (not public). As introduced by this [commit](https://github.com/animir/node-rate-limiter-flexible/commit/b98a9a504036771ab5a3005627da4aba57d437ae) you are using quotations for the table name parameter which makes it impossible to work for a table prefixed with the schema name.\r\n\r\nSee our implementation below:\r\n\r\n` new RateLimiterPostgres(\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t// Database config\r\n\t\t\t\t\t\tstoreType: 'knex',\r\n\t\t\t\t\t\ttableCreated: true,\r\n\t\t\t\t\t\ttableName: 'server.rate_limiters',\r\n\t\t\t\t\t\t// Limiter config\r\n\t\t\t\t\t\tkeyPrefix: name,\r\n\t\t\t\t\t\tpoints,\r\n\t\t\t\t\t\tduration,\r\n\t\t\t\t\t},`", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/226/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/226/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/329", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/329/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/329/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/329/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/329", "id": 3449747230, "node_id": "I_kwDOB-MyFM7Nnvce", "number": 329, "title": "`_isRedisReady` Check not working with `node-redis` v5", "user": {"login": "Neumann-Nils", "id": 8270077, "node_id": "MDQ6VXNlcjgyNzAwNzc=", "avatar_url": "https://avatars.githubusercontent.com/u/8270077?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Neumann-Nils", "html_url": "https://github.com/Neumann-Nils", "followers_url": "https://api.github.com/users/Neumann-Nils/followers", "following_url": "https://api.github.com/users/Neumann-Nils/following{/other_user}", "gists_url": "https://api.github.com/users/Neumann-Nils/gists{/gist_id}", "starred_url": "https://api.github.com/users/Neumann-Nils/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Neumann-Nils/subscriptions", "organizations_url": "https://api.github.com/users/Neumann-Nils/orgs", "repos_url": "https://api.github.com/users/Neumann-Nils/repos", "events_url": "https://api.github.com/users/Neumann-Nils/events{/privacy}", "received_events_url": "https://api.github.com/users/Neumann-Nils/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 6, "created_at": "2025-09-24T14:42:28Z", "updated_at": "2025-10-12T14:34:51Z", "closed_at": "2025-10-12T14:34:51Z", "assignee": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "I am using the newest version of the [node-redis ](https://github.com/redis/node-redis) v5.8.2 with the newest version of the node-rate-limiter-flexible v7.4.0.\n\nI am using [`RateLimiterRedis`](https://github.com/animir/node-rate-limiter-flexible/wiki/Redis) with an [`RateLimiterMemory`](https://github.com/animir/node-rate-limiter-flexible/wiki/Memory) as an [`insuranceLimiter`](https://github.com/animir/node-rate-limiter-flexible/wiki/Options#insurancelimiter):\n\n```js\nconst redisClient = createClient(clientConfig);\nconst rateLimiterInMemory = new RateLimiterMemory({\n  keyPrefix: 'standard',\n  points: 10,\n  duration: 1,\n});\nconst rateLimiterRedis = new RateLimiterRedis({\n  storeClient: redisClient,\n  useRedisPackage: true,\n  rejectIfRedisNotReady: true,\n  points: 10,\n  duration: 1,\n  insuranceLimiter: rateLimiterInMemory,\n});\n```\n\nI have noticed that when the redis is unavailable that the [`_isRedisReady`](https://github.com/animir/node-rate-limiter-flexible/blob/master/lib/RateLimiterRedis.js#L42-L62) is not working correctly. When the `RateLimiterRedis` checks if the node-redis client is ready, it checks if `this.client.isReady` is a function and returns a truthy value:\n\n```js\n    // node-redis client\n    if (typeof this.client.isReady === 'function' && !this.client.isReady()) {\n      return false;\n    }\n```\n\nHowever, with the newest version `this.client.isReady` does not seem to be a function anymore but a simple property. In the [documentation](https://github.com/redis/node-redis?tab=readme-ov-file#basic-example) they state:\n\n```txt\nTo check if the the client is connected and ready to send commands, use client.isReady which returns a boolean. client.isOpen is also available. This returns true when the client's underlying socket is open, and false when it isn't (for example when the client is still connecting or reconnecting after a network error).\n```\n\nThere also is an [usage example](https://github.com/redis/node-redis/blob/master/examples/check-connection-status.js):\n\n```js\n// isOpen will return False here as the client's socket is not open yet.\n// isReady will return False here, client is not yet ready to use.\nconsole.log(`client.isOpen: ${client.isOpen}, client.isReady: ${client.isReady}`);\n```\n\nAt this point, the fix sounds easy: Just directly check the property `this.client.isReady`.\nHowever, I also tested the behavior with a cluster client and found out that this does not have an `isReady` property, but only the `isOpen` property. The actual clients of the cluster still seem to have the `isReady` property.", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/329/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/329/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/121", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/121/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/121/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/121/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/121", "id": 947612861, "node_id": "MDU6SXNzdWU5NDc2MTI4NjE=", "number": 121, "title": "undefined is not iterable on mongoDB backend", "user": {"login": "vdiez", "id": 13798307, "node_id": "MDQ6VXNlcjEzNzk4MzA3", "avatar_url": "https://avatars.githubusercontent.com/u/13798307?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vdiez", "html_url": "https://github.com/vdiez", "followers_url": "https://api.github.com/users/vdiez/followers", "following_url": "https://api.github.com/users/vdiez/following{/other_user}", "gists_url": "https://api.github.com/users/vdiez/gists{/gist_id}", "starred_url": "https://api.github.com/users/vdiez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vdiez/subscriptions", "organizations_url": "https://api.github.com/users/vdiez/orgs", "repos_url": "https://api.github.com/users/vdiez/repos", "events_url": "https://api.github.com/users/vdiez/events{/privacy}", "received_events_url": "https://api.github.com/users/vdiez/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 924270287, "node_id": "MDU6TGFiZWw5MjQyNzAyODc=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/question", "name": "question", "color": "d876e3", "default": true, "description": "Further information is requested"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 5, "created_at": "2021-07-19T12:42:06Z", "updated_at": "2021-07-24T07:14:45Z", "closed_at": "2021-07-24T07:14:45Z", "assignee": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "I'm encountering this error from time to time:\r\n\r\n```\r\nundefined` is not iterable (cannot read property Symbol(Symbol.iterator)) TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))\r\n    at RateLimiterMongo._getRateLimiterRes (C:\\www\\projects\\uefa_app\\node_modules\\rate-limiter-flexible\\lib\\RateLimiterMongo.js:117:15)\r\n    at RateLimiterMongo._afterConsume (C:\\www\\projects\\uefa_app\\node_modules\\rate-limiter-flexible\\lib\\RateLimiterStoreAbstract.js:51:22)\r\n    at C:\\www\\projects\\uefa_app\\node_modules\\rate-limiter-flexible\\lib\\RateLimiterStoreAbstract.js:205:16\r\n    at runMicrotasks (<anonymous>)\r\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n```\r\n\r\nhttps://github.com/animir/node-rate-limiter-flexible/blob/184d1d883583c53a5aff47726bc10afb6de3e4e9/lib/RateLimiterMongo.js#L116\r\n\r\nOriginally the issue seems to come from Mongo driver 4 as they have [removed the ops attribute](https://github.com/mongodb/node-mongodb-native/blob/4.0/HISTORY.md#-breaking-changes-1), needed when [using replaceOne](https://github.com/animir/node-rate-limiter-flexible/blob/184d1d883583c53a5aff47726bc10afb6de3e4e9/lib/RateLimiterMongo.js#L211)", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/121/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/121/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/33", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/33/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/33/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/33/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/33", "id": 465632877, "node_id": "MDU6SXNzdWU0NjU2MzI4Nzc=", "number": 33, "title": "Maximum call stack size exceeded on unavailable memcached", "user": {"login": "OndroNR", "id": 978340, "node_id": "MDQ6VXNlcjk3ODM0MA==", "avatar_url": "https://avatars.githubusercontent.com/u/978340?v=4", "gravatar_id": "", "url": "https://api.github.com/users/OndroNR", "html_url": "https://github.com/OndroNR", "followers_url": "https://api.github.com/users/OndroNR/followers", "following_url": "https://api.github.com/users/OndroNR/following{/other_user}", "gists_url": "https://api.github.com/users/OndroNR/gists{/gist_id}", "starred_url": "https://api.github.com/users/OndroNR/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/OndroNR/subscriptions", "organizations_url": "https://api.github.com/users/OndroNR/orgs", "repos_url": "https://api.github.com/users/OndroNR/repos", "events_url": "https://api.github.com/users/OndroNR/events{/privacy}", "received_events_url": "https://api.github.com/users/OndroNR/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 5, "created_at": "2019-07-09T08:06:06Z", "updated_at": "2019-07-09T11:21:13Z", "closed_at": "2019-07-09T10:30:18Z", "assignee": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "When memcached is unavailable, I get \"Maximum call stack size exceeded\" Error on line https://github.com/animir/node-rate-limiter-flexible/blob/master/lib/RateLimiterMemcache.js#L31\r\ncalled from https://github.com/animir/node-rate-limiter-flexible/blob/master/lib/RateLimiterMemcache.js#L59 .\r\n\r\n`attemptNumber` is never increased, which results in never ending loop. I believe `attemptNumber` should be increased on this line https://github.com/animir/node-rate-limiter-flexible/blob/master/lib/RateLimiterMemcache.js#L57\r\n\r\nReproduction code, memcached must be unavailable\r\n```js\r\n'use strict';\r\n\r\nconst {RateLimiterMemcache} = require('rate-limiter-flexible');\r\nconst Memcached = require('memcached');\r\n\r\nconst memcacheRateLimiterOpts = {\r\n    points: 100, // 100 same events\r\n    duration: 3600, // per 1 hour\r\n    storeClient: new Memcached('127.0.0.1:12345', {timeout: 500, failures: 2, retries: 2})\r\n};\r\n\r\nconst rateLimiter = new RateLimiterMemcache(memcacheRateLimiterOpts);\r\n\r\nasync function foobar() {\r\n    await rateLimiter.consume('aaa');\r\n}\r\n\r\nfoobar();\r\n```", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/33/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/33/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/95", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/95/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/95/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/95/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/95", "id": 766339886, "node_id": "MDU6SXNzdWU3NjYzMzk4ODY=", "number": 95, "title": "Using RateLimiterPostgres + knex.js yields wrong data in db", "user": {"login": "noamackerman-monday", "id": 72454104, "node_id": "MDQ6VXNlcjcyNDU0MTA0", "avatar_url": "https://avatars.githubusercontent.com/u/72454104?v=4", "gravatar_id": "", "url": "https://api.github.com/users/noamackerman-monday", "html_url": "https://github.com/noamackerman-monday", "followers_url": "https://api.github.com/users/noamackerman-monday/followers", "following_url": "https://api.github.com/users/noamackerman-monday/following{/other_user}", "gists_url": "https://api.github.com/users/noamackerman-monday/gists{/gist_id}", "starred_url": "https://api.github.com/users/noamackerman-monday/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/noamackerman-monday/subscriptions", "organizations_url": "https://api.github.com/users/noamackerman-monday/orgs", "repos_url": "https://api.github.com/users/noamackerman-monday/repos", "events_url": "https://api.github.com/users/noamackerman-monday/events{/privacy}", "received_events_url": "https://api.github.com/users/noamackerman-monday/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 3, "created_at": "2020-12-14T11:46:44Z", "updated_at": "2020-12-20T21:49:06Z", "closed_at": "2020-12-19T05:05:54Z", "assignee": null, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Hi,\r\nWhen using the RateLimiterPostgres + knex.js, i'm seeing wrong results written to the db when the points limit is exceeded. \r\n\r\nCode:\r\n` const {RateLimiterPostgres} = require('rate-limiter-flexible');`\r\n`let options = { storeClient: connection, storeType: `knex`,\r\n                points: 2,\r\n                duration: 0, \r\n                blockDuration: 60 * 60 * 24 * 365, \r\n                tableName: 'downloads_rate_limiter', \r\n                keyPrefix: 'downloadsrl',\r\n                inmemoryBlockOnConsumed: 2,\r\n                inmemoryBlockDuration: 60 * 60 * 24 * 365,\r\n                tableCreated: true\r\n              };`\r\n\r\n`const rateLimiter = new RateLimiterPostgres(options);`\r\n\r\napp.get('/hello', async (req, res) => {\r\n`  try\r\n  {\r\n    await rateLimiter.consume(obj, 1);\r\n     doSomeOperation();\r\n  }\r\n  catch (error) {\r\n      if (error instanceof Error) {\r\n        // Some Postgres error\r\n        // Never happen if `insuranceLimiter` set up\r\n        res.writeHead(500)\r\n      } else {\r\n        // Can't consume\r\n         res.writeHead(429);\r\n      }\r\n      res.end(error.toString())\r\n    }`\r\n});\r\n\r\nNow let's say i'm calling the 'hello' endpoint 3 times and looking the at points column in the db. After the first 2 times i will see the value 2, which is expected, but at the 3rd time and on i will start to see some random value, jumping from 2 to 6, then to 9 and 12 etc.\r\n\r\nCan you please help me understand what is the reason for this behaviour? Seems like a bug.\r\n\r\nThanks!\r\nNoam", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/95/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/95/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/36", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/36/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/36/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/36/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/36", "id": 470326796, "node_id": "MDU6SXNzdWU0NzAzMjY3OTY=", "number": 36, "title": "MySQL databases with a dash in the name cause a ER_PARSE_ERROR failure", "user": {"login": "mattandrews", "id": 394376, "node_id": "MDQ6VXNlcjM5NDM3Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/394376?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mattandrews", "html_url": "https://github.com/mattandrews", "followers_url": "https://api.github.com/users/mattandrews/followers", "following_url": "https://api.github.com/users/mattandrews/following{/other_user}", "gists_url": "https://api.github.com/users/mattandrews/gists{/gist_id}", "starred_url": "https://api.github.com/users/mattandrews/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mattandrews/subscriptions", "organizations_url": "https://api.github.com/users/mattandrews/orgs", "repos_url": "https://api.github.com/users/mattandrews/repos", "events_url": "https://api.github.com/users/mattandrews/events{/privacy}", "received_events_url": "https://api.github.com/users/mattandrews/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 3, "created_at": "2019-07-19T13:33:05Z", "updated_at": "2019-07-23T07:42:46Z", "closed_at": "2019-07-23T04:20:35Z", "assignee": null, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "I use suffixes like `-dev`, `-test` etc for my databases. When I try to initialise this library with a `dbName` of `website-dev` etc I get this error:\r\n\r\n```\r\n{ Error: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for \r\nthe right syntax to use near '-dev' at line 1\r\n    at Packet.asError (/Users/matt/dev/myapp/node_modules/mysql2/lib/packets/packet.js:714:13)\r\n    at Query.Command.execute (/Users/matt/dev/myapp/node_modules/mysql2/lib/commands/command.js:28:22)\r\n    at Connection.handlePacket (/Users/matt/dev/myapp/node_modules/mysql2/lib/connection.js:513:28)\r\n    at PacketParser.onPacket (/Users/matt/dev/myapp/node_modules/mysql2/lib/connection.js:81:16)\r\n    at PacketParser.executeStart (/Users/matt/dev/myapp/node_modules/mysql2/lib/packet_parser.js:76:14)\r\n    at Socket.<anonymous> (/Users/matt/dev/myapp/node_modules/mysql2/lib/connection.js:89:29)\r\n    at Socket.emit (events.js:198:13)\r\n    at Socket.EventEmitter.emit (domain.js:448:20)\r\n    at addChunk (_stream_readable.js:288:12)\r\n    at readableAddChunk (_stream_readable.js:269:11)\r\n    at Socket.Readable.push (_stream_readable.js:224:10)\r\n    at TCP.onStreamRead [as onread] (internal/stream_base_commons.js:94:17)\r\n  code: 'ER_PARSE_ERROR',\r\n  errno: 1064,\r\n  sqlState: '42000'\r\n}\r\n```\r\n\r\nI tried wrapping the database name in backticks which seemed to work (eg. it created the table in the `website-dev` database), but the middleware I created (from [here](https://github.com/animir/node-rate-limiter-flexible/wiki/Express-Middleware)) only returned failures (eg. the 429 error) and did not insert anything into the database.", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/36/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/36/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/337", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/337/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/337/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/337/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/337", "id": 3625115228, "node_id": "I_kwDOB-MyFM7YEt5c", "number": 337, "title": "PR  #335 Timeout wrapper broke insurance strategies", "user": {"login": "Choobz", "id": 15648192, "node_id": "MDQ6VXNlcjE1NjQ4MTky", "avatar_url": "https://avatars.githubusercontent.com/u/15648192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Choobz", "html_url": "https://github.com/Choobz", "followers_url": "https://api.github.com/users/Choobz/followers", "following_url": "https://api.github.com/users/Choobz/following{/other_user}", "gists_url": "https://api.github.com/users/Choobz/gists{/gist_id}", "starred_url": "https://api.github.com/users/Choobz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Choobz/subscriptions", "organizations_url": "https://api.github.com/users/Choobz/orgs", "repos_url": "https://api.github.com/users/Choobz/repos", "events_url": "https://api.github.com/users/Choobz/events{/privacy}", "received_events_url": "https://api.github.com/users/Choobz/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 2, "created_at": "2025-11-14T11:02:58Z", "updated_at": "2025-11-15T23:49:26Z", "closed_at": "2025-11-15T23:49:26Z", "assignee": null, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Hello,\n\nI noticed an issue with [insurance strategies](https://github.com/animir/node-rate-limiter-flexible/wiki/Overall-example#setup-insurance-strategy-for-store-limiters) in the latest release (8.2.0).\n\nThis [specific code change ](https://github.com/animir/node-rate-limiter-flexible/pull/335/files#diff-5bf97ee1de5d0c8e988ee17450c4734ac2880f72474fa9efd93a1bc225698838R44) brings a subtle change in the workflow and catch **every** rejection from an underlying limiter. Including the rejection due to a limit being exceeded. The previous code did not catch those errors, only underlying storage issues.\n\nThis subtle change does have a massive effect on any limiter using insurance:\n* Before: Insurance limiter only getting called for storage issues\n* Now: Insurance limiter called for storage issues AND limit exhaustion\n\n\nPretty simple test:\n```javascript\nconst insuranceLimiter = new RateLimiterMemory({\n  points: 100,\n  duration: 1\n})\nconst rateLimiter = new RateLimiterRedis({\n    useRedisPackage: true,\n    storeClient: redisClient,\n    insuranceLimiter,\n    points: 2,\n    duration: 1\n  }\nawait limiter.consume(\"\", 3) // <= This will never throw since the insuranceLimiter is set up to 100 / s\n```\nI may have misunderstood the initial goals of insurance strategies but I thought it was about **storage** issues and unrelated to the main limiter capacities.\n\nThanks a lot!", "closed_by": {"login": "Choobz", "id": 15648192, "node_id": "MDQ6VXNlcjE1NjQ4MTky", "avatar_url": "https://avatars.githubusercontent.com/u/15648192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Choobz", "html_url": "https://github.com/Choobz", "followers_url": "https://api.github.com/users/Choobz/followers", "following_url": "https://api.github.com/users/Choobz/following{/other_user}", "gists_url": "https://api.github.com/users/Choobz/gists{/gist_id}", "starred_url": "https://api.github.com/users/Choobz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Choobz/subscriptions", "organizations_url": "https://api.github.com/users/Choobz/orgs", "repos_url": "https://api.github.com/users/Choobz/repos", "events_url": "https://api.github.com/users/Choobz/events{/privacy}", "received_events_url": "https://api.github.com/users/Choobz/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/337/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/337/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/214", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/214/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/214/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/214/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/214", "id": 1823376945, "node_id": "I_kwDOB-MyFM5sroYx", "number": 214, "title": "BurstyRateLimiter.get( key ) throws error when key doesn't exist yet", "user": {"login": "krazydanny", "id": 22056203, "node_id": "MDQ6VXNlcjIyMDU2MjAz", "avatar_url": "https://avatars.githubusercontent.com/u/22056203?v=4", "gravatar_id": "", "url": "https://api.github.com/users/krazydanny", "html_url": "https://github.com/krazydanny", "followers_url": "https://api.github.com/users/krazydanny/followers", "following_url": "https://api.github.com/users/krazydanny/following{/other_user}", "gists_url": "https://api.github.com/users/krazydanny/gists{/gist_id}", "starred_url": "https://api.github.com/users/krazydanny/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/krazydanny/subscriptions", "organizations_url": "https://api.github.com/users/krazydanny/orgs", "repos_url": "https://api.github.com/users/krazydanny/repos", "events_url": "https://api.github.com/users/krazydanny/events{/privacy}", "received_events_url": "https://api.github.com/users/krazydanny/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 2, "created_at": "2023-07-26T23:56:43Z", "updated_at": "2023-07-27T16:38:11Z", "closed_at": "2023-07-27T16:38:11Z", "assignee": null, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Hi :)\r\n\r\nThe API documentation says .get( key ) method can return Promise<null> when key does not exists but the BurstyRateLimiter throws the following error instead:\r\n\r\nTypeError: Cannot read properties of null (reading 'remainingPoints')\r\n      at BurstyRateLimiter._combineRes (/usr/src/app/node_modules/rate-limiter-flexible/lib/BurstyRateLimiter.js:21:13)\r\n      at /usr/src/app/node_modules/rate-limiter-flexible/lib/BurstyRateLimiter.js:67:19\r\n      at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\r\n      \r\n![Screenshot from 2023-07-26 20-51-40](https://github.com/animir/node-rate-limiter-flexible/assets/22056203/5a0a7322-c89b-4b98-9b66-bec6113265ce)\r\n\r\nhope it helps!\r\nThanks!\r\n\r\n", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/214/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/214/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/169", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/169/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/169/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/169/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/169", "id": 1261056100, "node_id": "I_kwDOB-MyFM5LKjBk", "number": 169, "title": "key column length (256 chars) makes problem in long key rate limitation in postgres ", "user": {"login": "KeyvanArj", "id": 15213923, "node_id": "MDQ6VXNlcjE1MjEzOTIz", "avatar_url": "https://avatars.githubusercontent.com/u/15213923?v=4", "gravatar_id": "", "url": "https://api.github.com/users/KeyvanArj", "html_url": "https://github.com/KeyvanArj", "followers_url": "https://api.github.com/users/KeyvanArj/followers", "following_url": "https://api.github.com/users/KeyvanArj/following{/other_user}", "gists_url": "https://api.github.com/users/KeyvanArj/gists{/gist_id}", "starred_url": "https://api.github.com/users/KeyvanArj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/KeyvanArj/subscriptions", "organizations_url": "https://api.github.com/users/KeyvanArj/orgs", "repos_url": "https://api.github.com/users/KeyvanArj/repos", "events_url": "https://api.github.com/users/KeyvanArj/events{/privacy}", "received_events_url": "https://api.github.com/users/KeyvanArj/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 924270283, "node_id": "MDU6TGFiZWw5MjQyNzAyODM=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/enhancement", "name": "enhancement", "color": "a2eeef", "default": true, "description": "New feature or request"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 2, "created_at": "2022-06-05T13:57:24Z", "updated_at": "2022-08-06T21:53:51Z", "closed_at": "2022-08-06T21:53:51Z", "assignee": null, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "The `key` column in the generated table by `RateLimiterPostgres` is defined in this way:\r\n\r\n```\r\ncharacter varying (256)\r\n```\r\n\r\nSo when the length of selected key is bigger than 256 characters, it fails, without any log and just returns 429!!! \r\n\r\nI've used SHA-256 hash function to create 256 characters-key to make sure that it never fails", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/169/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/169/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/125", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/125/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/125/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/125/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/125", "id": 970757938, "node_id": "MDU6SXNzdWU5NzA3NTc5Mzg=", "number": 125, "title": "RateLimiterQueue: getTokensRemaining broken for RateLimiterPostgres after key expires", "user": {"login": "jhurwitz", "id": 591990, "node_id": "MDQ6VXNlcjU5MTk5MA==", "avatar_url": "https://avatars.githubusercontent.com/u/591990?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jhurwitz", "html_url": "https://github.com/jhurwitz", "followers_url": "https://api.github.com/users/jhurwitz/followers", "following_url": "https://api.github.com/users/jhurwitz/following{/other_user}", "gists_url": "https://api.github.com/users/jhurwitz/gists{/gist_id}", "starred_url": "https://api.github.com/users/jhurwitz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jhurwitz/subscriptions", "organizations_url": "https://api.github.com/users/jhurwitz/orgs", "repos_url": "https://api.github.com/users/jhurwitz/repos", "events_url": "https://api.github.com/users/jhurwitz/events{/privacy}", "received_events_url": "https://api.github.com/users/jhurwitz/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 2, "created_at": "2021-08-13T23:05:53Z", "updated_at": "2021-11-21T03:05:24Z", "closed_at": "2021-11-21T03:05:24Z", "assignee": null, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "I believe this should repro the error:\r\n```\r\nconst rateLimiter = new RateLimiterPostgres(\r\n  {\r\n    points: 5,\r\n    duration: 1,\r\n    storeClient: <CLIENT>,\r\n    storeType: 'knex',\r\n    tableName: '<TABLE_NAME>',\r\n    keyPrefix: '',\r\n    tableCreated: true,\r\n  },\r\n);\r\nconst queue = new RateLimiterQueue(rateLimiter);\r\n\r\nawait queue.getTokensRemaining('key');\r\nawait queue.removeTokens(1, 'key');\r\nawait queue.getTokensRemaining('key');\r\nawait new Promise((resolve) => setTimeout(resolve, 3000));\r\nawait queue.getTokensRemaining('key');\r\n```\r\n\r\nThe first two calls to `getTokensRemaining` succeed, but the third fails with: `Cannot read property 'remainingPoints' of null`\r\n\r\nBased on debugging this, I think the root cause is this: On the third call, the `expire` value stored in postgres is in the past, so the `_get` method of `RateLimiterPostgres` returns null.", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/125/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/125/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/266", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/266/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/266/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/266/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/266", "id": 2319267096, "node_id": "I_kwDOB-MyFM6KPTUY", "number": 266, "title": "Sequelize v7 issue", "user": {"login": "axeldvp", "id": 83970864, "node_id": "MDQ6VXNlcjgzOTcwODY0", "avatar_url": "https://avatars.githubusercontent.com/u/83970864?v=4", "gravatar_id": "", "url": "https://api.github.com/users/axeldvp", "html_url": "https://github.com/axeldvp", "followers_url": "https://api.github.com/users/axeldvp/followers", "following_url": "https://api.github.com/users/axeldvp/following{/other_user}", "gists_url": "https://api.github.com/users/axeldvp/gists{/gist_id}", "starred_url": "https://api.github.com/users/axeldvp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/axeldvp/subscriptions", "organizations_url": "https://api.github.com/users/axeldvp/orgs", "repos_url": "https://api.github.com/users/axeldvp/repos", "events_url": "https://api.github.com/users/axeldvp/events{/privacy}", "received_events_url": "https://api.github.com/users/axeldvp/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 1, "created_at": "2024-05-27T14:14:06Z", "updated_at": "2026-02-07T16:00:30Z", "closed_at": "2026-02-07T16:00:30Z", "assignee": null, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Since sequelize updated to v7.0.0-alpha.40 rate limiter does not work. \r\n\r\nEverything was working fine until v7.0.0-alpha.39.\r\n\r\n```\r\nError: Accessing the connection manager is unlikely to be necessary anymore.\r\nIf you need to access the pool, you can access it directly through `sequelize.pool`.\r\nIf you really need to access the connection manager, access it through `sequelize.dialect.connectionManager`.\r\n```\r\n", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/266/reactions", "total_count": 1, "+1": 1, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/266/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/251", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/251/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/251/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/251/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/251", "id": 2101556415, "node_id": "I_kwDOB-MyFM59QzS_", "number": 251, "title": "RateLimiterMongo TypeError: Cannot read properties of null (reading 'value')", "user": {"login": "o-ali", "id": 27753135, "node_id": "MDQ6VXNlcjI3NzUzMTM1", "avatar_url": "https://avatars.githubusercontent.com/u/27753135?v=4", "gravatar_id": "", "url": "https://api.github.com/users/o-ali", "html_url": "https://github.com/o-ali", "followers_url": "https://api.github.com/users/o-ali/followers", "following_url": "https://api.github.com/users/o-ali/following{/other_user}", "gists_url": "https://api.github.com/users/o-ali/gists{/gist_id}", "starred_url": "https://api.github.com/users/o-ali/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/o-ali/subscriptions", "organizations_url": "https://api.github.com/users/o-ali/orgs", "repos_url": "https://api.github.com/users/o-ali/repos", "events_url": "https://api.github.com/users/o-ali/events{/privacy}", "received_events_url": "https://api.github.com/users/o-ali/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 1, "created_at": "2024-01-26T03:52:53Z", "updated_at": "2024-01-26T08:58:08Z", "closed_at": "2024-01-26T08:58:07Z", "assignee": null, "author_association": "CONTRIBUTOR", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "              jumping on this question because im seeing a similar issue and was wondering if it had to do with buffering. \r\n\r\nI see error `Cannot read properties of null (reading 'value')`  when the first call is made, and every call after succeeds as long as the entry in the database hasnt been deleted for that key.\r\n\r\nIs this a bug with the rate limiter that isnt handling null from the value properly on the first call, it should expect that the first call will not have any entry in the database.\r\n\r\nedit: adding context\r\n\r\n```\r\nTypeError: Cannot read properties of null (reading 'value')\r\n    at RateLimiterMongo._getRateLimiterRes (node_modules\\rate-limiter-flexible\\lib\\RateLimiterMongo.js:118:23)\r\n    at RateLimiterMongo._afterConsume (node_modules\\rate-limiter-flexible\\lib\\RateLimiterStoreAbstract.js:51:22)\r\n    at node_modules\\rate-limiter-flexible\\lib\\RateLimiterStoreAbstract.js:205:16\r\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\r\n```\r\n\r\nusing rate limiter with the following setup\r\n\r\n```\r\n        const opts: IRateLimiterMongoOptions = {\r\n            storeClient: db, // await mongoose.connect(uri).then((res) => res.connection)\r\n            points: 3, \r\n            duration: 5, \r\n            tableName: 'rate-limiter',\r\n        };\r\n        rateLimiter = new RateLimiterMongo(opts);\r\n```\r\n\r\n```\r\n    \"mongoose\": \"^8.0.1\",\r\n    \"mongodb\": \"^6.2.0\",\r\n```\r\n\r\n_Originally posted by @o-ali in https://github.com/animir/node-rate-limiter-flexible/issues/216#issuecomment-1907606108_\r\n\r\nI've traced the issue to the way the rate limiter tries to fetch the version which is erroring here https://github.com/animir/node-rate-limiter-flexible/blob/master/lib/RateLimiterMongo.js#L13 because `topology` is undefined, this results in assuming a version 0 and calls findoneandupdate without returning a result due to it not setting `upsertOptions.returnDocument = 'after';` \r\n\r\nNot sure if mongoose or mongodb recently changed the format of the mongoclient class, but it may be more reliable to instead fetch the client info from `client.client.options.metadata` which gives an object that looks like this\r\n\r\n```\r\n{\r\n  driver: { name: 'nodejs|Mongoose', version: '6.2.0|8.0.1' },\r\n  platform: 'Node.js v20.10.0, LE',\r\n...\r\n```\r\n            ", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/251/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/251/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/74", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/74/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/74/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/74/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/74", "id": 619862451, "node_id": "MDU6SXNzdWU2MTk4NjI0NTE=", "number": 74, "title": "Express, Koa and Hapi wiki update", "user": {"login": "angelod1as", "id": 13950513, "node_id": "MDQ6VXNlcjEzOTUwNTEz", "avatar_url": "https://avatars.githubusercontent.com/u/13950513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/angelod1as", "html_url": "https://github.com/angelod1as", "followers_url": "https://api.github.com/users/angelod1as/followers", "following_url": "https://api.github.com/users/angelod1as/following{/other_user}", "gists_url": "https://api.github.com/users/angelod1as/gists{/gist_id}", "starred_url": "https://api.github.com/users/angelod1as/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/angelod1as/subscriptions", "organizations_url": "https://api.github.com/users/angelod1as/orgs", "repos_url": "https://api.github.com/users/angelod1as/repos", "events_url": "https://api.github.com/users/angelod1as/events{/privacy}", "received_events_url": "https://api.github.com/users/angelod1as/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}, {"id": 924270287, "node_id": "MDU6TGFiZWw5MjQyNzAyODc=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/question", "name": "question", "color": "d876e3", "default": true, "description": "Further information is requested"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 1, "created_at": "2020-05-18T02:25:15Z", "updated_at": "2020-05-18T03:05:55Z", "closed_at": "2020-05-18T03:05:37Z", "assignee": null, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "In Express, Koa and Hapi wiki, the `new RateLimiterRedis` has a wrong property: `redis`.\r\n\r\n```javascript\r\nconst rateLimiter = new RateLimiterRedis({\r\n  redis: redisClient,\r\n  keyPrefix: 'middleware',\r\n  points: 10, // 10 requests\r\n  duration: 1, // per 1 second by IP\r\n});\r\n```\r\n\r\nIt's supposed to be `storeClient`.\r\n\r\n```javascript\r\nconst rateLimiter = new RateLimiterRedis({\r\n  storeClient: redisClient,\r\n  keyPrefix: 'middleware',\r\n  points: 10, // 10 requests\r\n  duration: 1, // per 1 second by IP\r\n});\r\n```\r\n\r\nTested locally and it works like a charm\r\n\r\nI can't seem to find a way to make a pull request of these needed updates.\r\n(I'm kinda new to GitHub so if there's a better way to report this, I'd love to know)", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/74/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/74/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/9", "repository_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible", "labels_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/9/labels{/name}", "comments_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/9/comments", "events_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/9/events", "html_url": "https://github.com/animir/node-rate-limiter-flexible/issues/9", "id": 369537320, "node_id": "MDU6SXNzdWUzNjk1MzczMjA=", "number": 9, "title": "RateLimiterRedis not working with ioredis", "user": {"login": "loris", "id": 8362, "node_id": "MDQ6VXNlcjgzNjI=", "avatar_url": "https://avatars.githubusercontent.com/u/8362?v=4", "gravatar_id": "", "url": "https://api.github.com/users/loris", "html_url": "https://github.com/loris", "followers_url": "https://api.github.com/users/loris/followers", "following_url": "https://api.github.com/users/loris/following{/other_user}", "gists_url": "https://api.github.com/users/loris/gists{/gist_id}", "starred_url": "https://api.github.com/users/loris/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/loris/subscriptions", "organizations_url": "https://api.github.com/users/loris/orgs", "repos_url": "https://api.github.com/users/loris/repos", "events_url": "https://api.github.com/users/loris/events{/privacy}", "received_events_url": "https://api.github.com/users/loris/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 924270281, "node_id": "MDU6TGFiZWw5MjQyNzAyODE=", "url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/labels/bug", "name": "bug", "color": "d73a4a", "default": true, "description": "Something isn't working"}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 1, "created_at": "2018-10-12T12:49:44Z", "updated_at": "2018-10-14T10:52:49Z", "closed_at": "2018-10-14T10:50:49Z", "assignee": null, "author_association": "NONE", "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Not sure if due to recent changes in ioredis, but RateLimiterRedis is not working with ioredis 4.x.\r\nThe issue is how iosredis result format is handled in `RateLimiterRedis.js`\r\n\r\n```\r\n  _get(rlKey) {\r\n    return new Promise((resolve, reject) => {\r\n      this.client.multi()\r\n        .get(rlKey)\r\n        .pttl(rlKey)\r\n        .exec((err, res) => {\r\n          if (err) {\r\n            reject(err);\r\n          } else {\r\n            const [points] = res;\r\n            if (points === null) {\r\n              res = null;\r\n            } else {\r\n              res.unshift('GET');\r\n            }\r\n            resolve(res);\r\n          }\r\n        });\r\n    });\r\n  }\r\n```\r\n\r\nA typical `res` value returned by ioredis would look like that: `[ [ null, '5' ], [ null, 275680 ] ]`\r\nThus in the code above, `points` will always be null.\r\nIn addition, the `res.unshift('GET')` is also incorrect, since the code in the `_getRateLimiterRes` method is expecting the first parameter to be an array in order to get recognize as an ioredis result format: \r\n\r\n```\r\n _getRateLimiterRes(rlKey, changedPoints, result) {\r\n    let [resSet, consumed, resTtlMs] = result;\r\n    // Support ioredis results format\r\n    if (Array.isArray(resSet)) {\r\n      [, resSet] = resSet;\r\n      [, consumed] = consumed;\r\n      [, resTtlMs] = resTtlMs;\r\n    }\r\n...\r\n```\r\n\r\nFix is easy, but I am not sure how to PR without breaking non-ioredis redis clients.\r\nIn the meantime I fixed my code using this wrapping class:\r\n\r\n```\r\nclass RateLimiterIoRedis extends RateLimiterRedis {\r\n  async _get(rlKey) {\r\n    const res = await this.client\r\n      .multi()\r\n      .get(rlKey)\r\n      .pttl(rlKey)\r\n      .exec();\r\n\r\n    if (res[0][1] === null) {\r\n      return null;\r\n    }\r\n\r\n    return [[null, 'GET'], ...res];\r\n  }\r\n}\r\n\r\nconst rateLimiter = new RateLimiterIoRedis();\r\n```", "closed_by": {"login": "animir", "id": 4623196, "node_id": "MDQ6VXNlcjQ2MjMxOTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4623196?v=4", "gravatar_id": "", "url": "https://api.github.com/users/animir", "html_url": "https://github.com/animir", "followers_url": "https://api.github.com/users/animir/followers", "following_url": "https://api.github.com/users/animir/following{/other_user}", "gists_url": "https://api.github.com/users/animir/gists{/gist_id}", "starred_url": "https://api.github.com/users/animir/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/animir/subscriptions", "organizations_url": "https://api.github.com/users/animir/orgs", "repos_url": "https://api.github.com/users/animir/repos", "events_url": "https://api.github.com/users/animir/events{/privacy}", "received_events_url": "https://api.github.com/users/animir/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/9/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/animir/node-rate-limiter-flexible/issues/9/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}]}