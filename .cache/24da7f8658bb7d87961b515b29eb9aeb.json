{"d": [{"url": "https://api.github.com/repos/redis/ioredis/issues/918", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/918/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/918/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/918/events", "html_url": "https://github.com/redis/ioredis/issues/918", "id": 463396739, "node_id": "MDU6SXNzdWU0NjMzOTY3Mzk=", "number": 918, "title": " after upgraded ioredis from 4.10.0  to 4.11.1 Error: connect ETIMEDOUT ", "user": {"login": "p3x-robot", "id": 28588124, "node_id": "MDQ6VXNlcjI4NTg4MTI0", "avatar_url": "https://avatars.githubusercontent.com/u/28588124?v=4", "gravatar_id": "", "url": "https://api.github.com/users/p3x-robot", "html_url": "https://github.com/p3x-robot", "followers_url": "https://api.github.com/users/p3x-robot/followers", "following_url": "https://api.github.com/users/p3x-robot/following{/other_user}", "gists_url": "https://api.github.com/users/p3x-robot/gists{/gist_id}", "starred_url": "https://api.github.com/users/p3x-robot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/p3x-robot/subscriptions", "organizations_url": "https://api.github.com/users/p3x-robot/orgs", "repos_url": "https://api.github.com/users/p3x-robot/repos", "events_url": "https://api.github.com/users/p3x-robot/events{/privacy}", "received_events_url": "https://api.github.com/users/p3x-robot/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 1097240172, "node_id": "MDU6TGFiZWwxMDk3MjQwMTcy", "url": "https://api.github.com/repos/redis/ioredis/labels/released", "name": "released", "color": "ededed", "default": false, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 46, "created_at": "2019-07-02T19:26:14Z", "updated_at": "2019-07-15T03:20:20Z", "closed_at": "2019-07-13T16:47:09Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "error: \r\n```text\r\nJul 02 21:23:28 server boot[8665]: [2019/07/02 21:23:28.994] [MASTER] [PID: 008665]  [ERROR] [CORE] [SERVICE] [REDIS] error\r\nJul 02 21:23:28 server boot[8665]: [2019/07/02 21:23:28.996] [MASTER] [PID: 008665]  [ERROR] 7/2/2019, 9:23:28 PM unhandledRejection Error: connect ETIMEDOUT\r\nJul 02 21:23:28 server boot[8665]:     at Socket.<anonymous> (/var/p3x/server.patrikx3.com/node_modules/ioredis/built/redis/index.js:270:31)\r\nJul 02 21:23:28 server boot[8665]:     at Object.onceWrapper (events.js:288:20)\r\nJul 02 21:23:28 server boot[8665]:     at Socket.emit (events.js:200:13)\r\nJul 02 21:23:28 server boot[8665]:     at Socket._onTimeout (net.js:434:8)\r\nJul 02 21:23:28 server boot[8665]:     at listOnTimeout (internal/timers.js:531:17)\r\nJul 02 21:23:28 server boot[8665]:     at processTimers (internal/timers.js:475:7) {\r\nJul 02 21:23:28 server boot[8665]:   errorno: 'ETIMEDOUT',\r\nJul 02 21:23:28 server boot[8665]:   code: 'ETIMEDOUT',\r\nJul 02 21:23:28 server boot[8665]:   syscall: 'connect'\r\nJul 02 21:23:28 server boot[8665]: } Promise {\r\nJul 02 21:23:28 server boot[8665]:   <rejected> Error: connect ETIMEDOUT\r\nJul 02 21:23:28 server boot[8665]:       at Socket.<anonymous> (/var/p3x/server.patrikx3.com/node_modules/ioredis/built/redis/index.js:270:31)\r\nJul 02 21:23:28 server boot[8665]:       at Object.onceWrapper (events.js:288:20)\r\nJul 02 21:23:28 server boot[8665]:       at Socket.emit (events.js:200:13)\r\nJul 02 21:23:28 server boot[8665]:       at Socket._onTimeout (net.js:434:8)\r\nJul 02 21:23:28 server boot[8665]:       at listOnTimeout (internal/timers.js:531:17)\r\nJul 02 21:23:28 server boot[8665]:       at processTimers (internal/timers.js:475:7) {\r\nJul 02 21:23:28 server boot[8665]:     errorno: 'ETIMEDOUT',\r\nJul 02 21:23:28 server boot[8665]:     code: 'ETIMEDOUT',\r\nJul 02 21:23:28 server boot[8665]:     syscall: 'connect'\r\nJul 02 21:23:28 server boot[8665]:   }\r\nJul 02 21:23:28 server boot[8665]: }\r\n```\r\n\r\nWith 4.10.0 it works.\r\n\r\nHow I connect:\r\n```\r\nconst settings = {\r\n   \"url2\": \"redis://:password@127.0.0.1:6379/0\",\r\n   \"url\": \"redis+unix://:password@/var/run/redis/redis-server.sock?db=0\"\r\n}\r\nreturn new Redis(settings.url);\r\n```\r\n\r\nwith 4.10.0 i can connect either url, with 4.11.0 i get timeout.", "closed_by": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/918/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/918/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/977", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/977/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/977/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/977/events", "html_url": "https://github.com/redis/ioredis/issues/977", "id": 499216705, "node_id": "MDU6SXNzdWU0OTkyMTY3MDU=", "number": 977, "title": " Error: connect ETIMEDOUT ----use bluebird", "user": {"login": "fengyh13", "id": 15938493, "node_id": "MDQ6VXNlcjE1OTM4NDkz", "avatar_url": "https://avatars.githubusercontent.com/u/15938493?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fengyh13", "html_url": "https://github.com/fengyh13", "followers_url": "https://api.github.com/users/fengyh13/followers", "following_url": "https://api.github.com/users/fengyh13/following{/other_user}", "gists_url": "https://api.github.com/users/fengyh13/gists{/gist_id}", "starred_url": "https://api.github.com/users/fengyh13/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fengyh13/subscriptions", "organizations_url": "https://api.github.com/users/fengyh13/orgs", "repos_url": "https://api.github.com/users/fengyh13/repos", "events_url": "https://api.github.com/users/fengyh13/events{/privacy}", "received_events_url": "https://api.github.com/users/fengyh13/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 1097240172, "node_id": "MDU6TGFiZWwxMDk3MjQwMTcy", "url": "https://api.github.com/repos/redis/ioredis/labels/released", "name": "released", "color": "ededed", "default": false, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 19, "created_at": "2019-09-27T03:36:37Z", "updated_at": "2020-04-11T06:33:44Z", "closed_at": "2020-04-11T06:27:12Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "I use bluebird replace native promise, error happened!\r\n\r\n```\r\nioredis:redis status[172.31.15.99:5818]: [empty] -> connecting +0ms\r\n  ioredis:redis queue command[172.31.15.99:5818]: 2 -> set([ 'aaa', '1' ]) +5ms\r\n  ioredis:connection error: Error: connect ETIMEDOUT +0ms\r\nredisClient connect to db error: { Error: connect ETIMEDOUT\r\n    at Socket.<anonymous> (/opt/project/umichat/umichat_manage/node_modules/_ioredis@4.14.1@ioredis/built/redis/index.js:282:31)\r\n    at Object.onceWrapper (events.js:313:30)\r\n    at emitNone (events.js:106:13)\r\n    at Socket.emit (events.js:208:7)\r\n    at Socket._onTimeout (net.js:422:8)\r\n    at ontimeout (timers.js:498:11)\r\n    at tryOnTimeout (timers.js:323:5)\r\n    at Timer.listOnTimeout (timers.js:290:5) errorno: 'ETIMEDOUT', code: 'ETIMEDOUT', syscall: 'connect' }\r\n  ioredis:redis status[172.31.15.99:5818]: connecting -> close +10s\r\n  ioredis:connection reconnect in 50ms +3ms\r\n  ioredis:redis status[172.31.15.99:5818]: close -> reconnecting +1ms\r\n  ioredis:redis status[172.31.15.99:5818]: reconnecting -> connecting +50ms\r\n```\r\n\r\nenvriment:\r\n```\r\nnode: v8.16.0\r\nredis server: 5.0.5\r\nioredis: 4.14.1\r\nbluebird: 3.5.5\r\n```\r\n\r\nmy test code\r\n```\r\nconst bluebird = require('bluebird');\r\nglobal.Promise = bluebird;\r\nconst Redis = require('ioredis');\r\n\r\nconst instance = new Redis({\r\n  port: 6379,\r\n  host: 'localhost',\r\n  db: 2,\r\n});\r\n\r\ninstance.on('error', e => {\r\n  console.error(`redisClient connect to db error:`, e);\r\n});\r\n\r\ninstance.set(\"aaa\", 1)\r\n```\r\n\r\n\r\n", "closed_by": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/977/reactions", "total_count": 6, "+1": 6, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/977/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/56", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/56/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/56/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/56/events", "html_url": "https://github.com/redis/ioredis/issues/56", "id": 83809782, "node_id": "MDU6SXNzdWU4MzgwOTc4Mg==", "number": 56, "title": "[cluster mode] inconsistent errors", "user": {"login": "AVVS", "id": 1713617, "node_id": "MDQ6VXNlcjE3MTM2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1713617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AVVS", "html_url": "https://github.com/AVVS", "followers_url": "https://api.github.com/users/AVVS/followers", "following_url": "https://api.github.com/users/AVVS/following{/other_user}", "gists_url": "https://api.github.com/users/AVVS/gists{/gist_id}", "starred_url": "https://api.github.com/users/AVVS/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AVVS/subscriptions", "organizations_url": "https://api.github.com/users/AVVS/orgs", "repos_url": "https://api.github.com/users/AVVS/repos", "events_url": "https://api.github.com/users/AVVS/events{/privacy}", "received_events_url": "https://api.github.com/users/AVVS/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 19, "created_at": "2015-06-02T03:12:46Z", "updated_at": "2015-08-23T09:33:29Z", "closed_at": "2015-08-23T09:33:29Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Cluster is created and then destroyed before and after the tests. So test runs are idempotent.\n\nFor some reason, sometimes redis cluster client instance doesn't have `sendCommand` on it and sometimes it does. I assume that context can be rewritten on retry or smth and become 'undefined'\n\n``` sh\nVitalys-MacBook-Pro:mservice-users vitaly$ npm test\n\n> mservice-users@1.0.0 test /Users/vitaly/projects/mservice-users\n> BLUEBIRD_DEBUG=1 multi='list=- xunit=test-report.xml' ./node_modules/.bin/mocha -R mocha-multi --timeout 10000\n\n\n20:06:56 users: connected to rabbit@Vitalys-MacBook-Pro v3.5.2\n20:06:56 users: queue \"amq.gen-HS1YKx5rwxfoVL6TOyEKiA\" created\n20:06:56 users: queue \"amq.gen-HS1YKx5rwxfoVL6TOyEKiA\" binded to exchange \"test-mocha\" on route \"test.users.*\"\n  \u2024 actions#register() should fail on incorrect payload: 5ms\n  \u2024 actions#register() should create user, activate it, no captcha specified: 51ms\n  \u2024 actions#register() should reject creating user, because it already exists: 59ms\n  \u2024 actions#register() should fail when invalid captcha is passed: 36ms\n\n  4 passing (4s)\n\nVitalys-MacBook-Pro:mservice-users vitaly$ npm test\n\n> mservice-users@1.0.0 test /Users/vitaly/projects/mservice-users\n> BLUEBIRD_DEBUG=1 multi='list=- xunit=test-report.xml' ./node_modules/.bin/mocha -R mocha-multi --timeout 10000\n\n\n20:07:11 users: connected to rabbit@Vitalys-MacBook-Pro v3.5.2\n20:07:11 users: queue \"amq.gen-57pK5eobgqjeLt8s_IU7Cw\" created\n20:07:11 users: queue \"amq.gen-57pK5eobgqjeLt8s_IU7Cw\" binded to exchange \"test-mocha\" on route \"test.users.*\"\n  \u2024 actions#register() should fail on incorrect payload: 6ms\n  1) actions#register() should create user, activate it, no captcha specified\n  2) actions#register() should reject creating user, because it already exists\n  3) actions#register() should fail when invalid captcha is passed\n\n  1 passing (22s)\n  3 failing\n\n  1) actions#register() should create user, activate it, no captcha specified:\n     Uncaught TypeError: Cannot call method 'sendCommand' of undefined\n  ---------------------------------------------\n  ---------------------------------------------\n  ---------------------------------------------\n      at module.exports (lib/connectors/redis.js:12:21)\n      at module.exports (lib/service.js:106:9)\n      at Context.<anonymous> (test/register.js:56:52)\n      at exithandler (child_process.js:656:7)\n      at maybeClose (child_process.js:766:16)\n      at Socket.<anonymous> (child_process.js:979:11)\n      at Pipe.close (net.js:466:12)\n\n  2) actions#register() should reject creating user, because it already exists:\n     Error: timeout of 10000ms exceeded. Ensure the done() callback is being called in this test.\n\n\n  3) actions#register() should fail when invalid captcha is passed:\n     Error: timeout of 10000ms exceeded. Ensure the done() callback is being called in this test.\n```\n\n``` js\n// connectors/redis.js\n'use strict';\n\nvar redis = require('ioredis');\nvar instance;\n\nmodule.exports = function (config) {\n    if (instance) {\n        return instance;\n    }\n\n    instance = new redis.Cluster(config.redis.hosts, config.redis.options || {});\n    // forked version used with lazyConnect enabled\n    return instance.connect();\n};\n```\n", "closed_by": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/56/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/56/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/635", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/635/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/635/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/635/events", "html_url": "https://github.com/redis/ioredis/issues/635", "id": 327961599, "node_id": "MDU6SXNzdWUzMjc5NjE1OTk=", "number": 635, "title": "sentinel connect unhandled error", "user": {"login": "luckyscript", "id": 9391201, "node_id": "MDQ6VXNlcjkzOTEyMDE=", "avatar_url": "https://avatars.githubusercontent.com/u/9391201?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luckyscript", "html_url": "https://github.com/luckyscript", "followers_url": "https://api.github.com/users/luckyscript/followers", "following_url": "https://api.github.com/users/luckyscript/following{/other_user}", "gists_url": "https://api.github.com/users/luckyscript/gists{/gist_id}", "starred_url": "https://api.github.com/users/luckyscript/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luckyscript/subscriptions", "organizations_url": "https://api.github.com/users/luckyscript/orgs", "repos_url": "https://api.github.com/users/luckyscript/repos", "events_url": "https://api.github.com/users/luckyscript/events{/privacy}", "received_events_url": "https://api.github.com/users/luckyscript/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [{"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}], "milestone": {"url": "https://api.github.com/repos/redis/ioredis/milestones/5", "html_url": "https://github.com/redis/ioredis/milestone/5", "labels_url": "https://api.github.com/repos/redis/ioredis/milestones/5/labels", "id": 3446061, "node_id": "MDk6TWlsZXN0b25lMzQ0NjA2MQ==", "number": 5, "title": "v4", "description": "", "creator": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "open_issues": 1, "closed_issues": 9, "state": "open", "created_at": "2018-06-23T04:10:47Z", "updated_at": "2025-02-07T10:37:52Z", "due_on": null, "closed_at": null}, "comments": 16, "created_at": "2018-05-31T01:33:00Z", "updated_at": "2025-02-23T01:12:23Z", "closed_at": "2018-08-08T07:59:53Z", "assignee": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "```\r\nUnhandled error event: Error: All sentinels are unreachable. Retrying from scratch after 10ms.\r\n```\r\nbut I can reach all sentinels server,and all redis operator is ok.\r\n\r\nso, I dont understand why this error shown frequently.\r\n\r\nwish solutions, sincerely.", "closed_by": {"login": "stale[bot]", "id": 26384082, "node_id": "MDM6Qm90MjYzODQwODI=", "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stale%5Bbot%5D", "html_url": "https://github.com/apps/stale", "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers", "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos", "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events", "type": "Bot", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/635/reactions", "total_count": 7, "+1": 7, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/635/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/1888", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/1888/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/1888/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/1888/events", "html_url": "https://github.com/redis/ioredis/issues/1888", "id": 2264139430, "node_id": "I_kwDOAfwFLc6G9Aam", "number": 1888, "title": "BZPOPMIN will hang for ever when a short disconnection happens and the port is different from 6379", "user": {"login": "manast", "id": 95200, "node_id": "MDQ6VXNlcjk1MjAw", "avatar_url": "https://avatars.githubusercontent.com/u/95200?v=4", "gravatar_id": "", "url": "https://api.github.com/users/manast", "html_url": "https://github.com/manast", "followers_url": "https://api.github.com/users/manast/followers", "following_url": "https://api.github.com/users/manast/following{/other_user}", "gists_url": "https://api.github.com/users/manast/gists{/gist_id}", "starred_url": "https://api.github.com/users/manast/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/manast/subscriptions", "organizations_url": "https://api.github.com/users/manast/orgs", "repos_url": "https://api.github.com/users/manast/repos", "events_url": "https://api.github.com/users/manast/events{/privacy}", "received_events_url": "https://api.github.com/users/manast/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 14, "created_at": "2024-04-25T17:35:07Z", "updated_at": "2026-01-05T14:01:41Z", "closed_at": "2026-01-05T14:01:41Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "\r\nThis one was pretty weird but quite serious. If you issue a BZPOPMIN command, and there is a small disconnection while the command is blocking, then it will stay blocking forever, effectively hanging the app that uses the command. \r\n\r\nNow, one of the *insane* things about this issue is that to reproduce it you must use a port different than the standard 6379, and also use docker network disconnect, it is not enough to just stop the docker container running Redis:\r\n\r\nTry this code:\r\nbug.mjs:\r\n```ts\r\nimport Redis from \"ioredis\";\r\n\r\nconst connection = new Redis({\r\n    host: \"localhost\",\r\n    port: 6380,\r\n});\r\n\r\nconnection.on(\"connect\", () => console.log(\"Redis connected!\"));\r\nconnection.on(\"ready\", () => console.log(\"Redis ready!\"));\r\nconnection.on(\"error\", (err) => console.error(\"Redis error:\", err));\r\nconnection.on(\"end\", () => console.log(\"Redis connection ended\"));\r\nconnection.on(\"reconnecting\", () => console.log(\"Redis reconnecting...\"));\r\n\r\nasync function test() {\r\n    console.log(\"Gonna issue a BZPOPMIN command...\")\r\n    const result = await connection.bzpopmin(\"key\", 0)\r\n    console.log(\"Issued BZPOPMIN command!\", result)\r\n}\r\n\r\ntest().catch(console.error);\r\n```\r\n\r\ndocker-compose.yml:\r\n```yaml\r\nversion: \"3.7\"\r\nservices:\r\n  redis:\r\n    image: redis:alpine\r\n    ports:\r\n      - \"6380:6379\"\r\n```\r\n\r\nStart the docker container with:\r\n```\r\ndocker-compose up\r\n```\r\n\r\nRun the test with:\r\n```sh\r\nnode bug.mjs\r\n```\r\nResults in:\r\n```sh\r\nGonna issue a BZPOPMIN command...\r\nRedis connected!\r\nRedis ready!\r\n```\r\n\r\nNow in a different terminal, and depending on where you run the docker (I had my docker compose on directory ioredis-econnreset:\r\n```sh\r\ndocker network disconnect ioredis-econnreset_default ioredis-econnreset-redis-1\r\nsleep 3\r\ndocker network connect ioredis-econnreset_default ioredis-econnreset-redis-1\r\n```\r\n\r\nThe Redis network was disconnected and connected again after 3 seconds. Open a Redis cli:\r\n```sh\r\nredis-cli -p 6380\r\n> 127.0.0.1:6380> zadd key 10 test\r\n(integer) 1\r\n127.0.0.1:6380>\r\n```\r\n\r\nThe terminal with the node app will stay the same, with no error or nothing. If you restart the app and without disconnecting and reconnecting you try again to ZADD to the key you will get instead:\r\n```sh\r\nGonna issue a BZPOPMIN command...\r\nRedis connected!\r\nRedis ready!\r\nIssued BZPOPMIN command! [ 'key', 'test', '10' ]\r\n```\r\n\r\nLet me know if you need more information.\r\n", "closed_by": {"login": "PavelPashov", "id": 60297174, "node_id": "MDQ6VXNlcjYwMjk3MTc0", "avatar_url": "https://avatars.githubusercontent.com/u/60297174?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PavelPashov", "html_url": "https://github.com/PavelPashov", "followers_url": "https://api.github.com/users/PavelPashov/followers", "following_url": "https://api.github.com/users/PavelPashov/following{/other_user}", "gists_url": "https://api.github.com/users/PavelPashov/gists{/gist_id}", "starred_url": "https://api.github.com/users/PavelPashov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PavelPashov/subscriptions", "organizations_url": "https://api.github.com/users/PavelPashov/orgs", "repos_url": "https://api.github.com/users/PavelPashov/repos", "events_url": "https://api.github.com/users/PavelPashov/events{/privacy}", "received_events_url": "https://api.github.com/users/PavelPashov/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/1888/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/1888/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/2031", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/2031/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/2031/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/2031/events", "html_url": "https://github.com/redis/ioredis/issues/2031", "id": 3525633252, "node_id": "I_kwDOAfwFLc7SJOTk", "number": 2031, "title": "Default disableClientInfo: false causes connection failures with Redis servers < 7.2.x", "user": {"login": "vibhor1997a", "id": 29769218, "node_id": "MDQ6VXNlcjI5NzY5MjE4", "avatar_url": "https://avatars.githubusercontent.com/u/29769218?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vibhor1997a", "html_url": "https://github.com/vibhor1997a", "followers_url": "https://api.github.com/users/vibhor1997a/followers", "following_url": "https://api.github.com/users/vibhor1997a/following{/other_user}", "gists_url": "https://api.github.com/users/vibhor1997a/gists{/gist_id}", "starred_url": "https://api.github.com/users/vibhor1997a/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vibhor1997a/subscriptions", "organizations_url": "https://api.github.com/users/vibhor1997a/orgs", "repos_url": "https://api.github.com/users/vibhor1997a/repos", "events_url": "https://api.github.com/users/vibhor1997a/events{/privacy}", "received_events_url": "https://api.github.com/users/vibhor1997a/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [{"login": "PavelPashov", "id": 60297174, "node_id": "MDQ6VXNlcjYwMjk3MTc0", "avatar_url": "https://avatars.githubusercontent.com/u/60297174?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PavelPashov", "html_url": "https://github.com/PavelPashov", "followers_url": "https://api.github.com/users/PavelPashov/followers", "following_url": "https://api.github.com/users/PavelPashov/following{/other_user}", "gists_url": "https://api.github.com/users/PavelPashov/gists{/gist_id}", "starred_url": "https://api.github.com/users/PavelPashov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PavelPashov/subscriptions", "organizations_url": "https://api.github.com/users/PavelPashov/orgs", "repos_url": "https://api.github.com/users/PavelPashov/repos", "events_url": "https://api.github.com/users/PavelPashov/events{/privacy}", "received_events_url": "https://api.github.com/users/PavelPashov/received_events", "type": "User", "user_view_type": "public", "site_admin": false}], "milestone": null, "comments": 13, "created_at": "2025-10-17T11:03:05Z", "updated_at": "2025-11-08T14:21:26Z", "closed_at": "2025-10-28T08:09:35Z", "assignee": {"login": "PavelPashov", "id": 60297174, "node_id": "MDQ6VXNlcjYwMjk3MTc0", "avatar_url": "https://avatars.githubusercontent.com/u/60297174?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PavelPashov", "html_url": "https://github.com/PavelPashov", "followers_url": "https://api.github.com/users/PavelPashov/followers", "following_url": "https://api.github.com/users/PavelPashov/following{/other_user}", "gists_url": "https://api.github.com/users/PavelPashov/gists{/gist_id}", "starred_url": "https://api.github.com/users/PavelPashov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PavelPashov/subscriptions", "organizations_url": "https://api.github.com/users/PavelPashov/orgs", "repos_url": "https://api.github.com/users/PavelPashov/repos", "events_url": "https://api.github.com/users/PavelPashov/events{/privacy}", "received_events_url": "https://api.github.com/users/PavelPashov/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "## Description\n\n### Summary\n\nStarting from recent versions of ioredis, the default behaviour changed to send client information to Redis servers by setting `disableClientInfo: false` by default. This breaks compatibility with Redis servers older than version 7.2.x, as they don't support the `CLIENT SETINFO` command that ioredis attempts to use.\n\n### Environment\n\n- **ioredis version**: 5.8.1\n- **Redis server version**: < 5.0\n- **Node.js version**: 20.17.x\n- **Platform**: linux\n\n## Steps to Reproduce\n\n1. Install the latest ioredis version\n2. Connect to a Redis server with version < 7.2.x\n3. Attempt to perform any Redis operation\n4. Connection fails or commands are rejected\n\n## Expected Behaviour\n\nThe Redis client should successfully connect to and operate with Redis servers running versions before 7.2.x, maintaining backward compatibility.\n\n## Actual Behaviour\n\nThe connection fails because ioredis attempts to execute the `CLIENT SETINFO` command, which is only available in Redis 7.2.0+. This results in errors and broken functionality.\n\n## Error Messages\n\n```\n[IORedis] Redis connection error ReplyError: ERR unknown command `client`, with args beginning with: `SETINFO`, `LIB-VER`, `5.8.1`, \n\n```\n\n## Root Cause\n\nThe `disableClientInfo` option defaults to `false` in newer ioredis versions, causing the client to automatically send client metadata using `CLIENT SETINFO`, which was introduced in Redis 7.2.0. Older Redis servers don't recognise this command and reject it.\n\n## Workaround\n\nExplicitly set `disableClientInfo: true` when creating the Redis client:\n\n```javascript\nconst redis = new Redis({\n  host: 'your-redis-host',\n  port: 6379,\n  disableClientInfo: true, // Disable client info for Redis < 7.2\n});\n```\n\nOr pin ioredis to a version before this breaking change was introduced.\n\n## Proposed Solution\n\n1. **Option 1**: Default `disableClientInfo: true` to maintain backward compatibility\n2. **Option 2**: Add version detection and only enable client info for Redis >= 7.2\n3. **Option 3**: Add better error handling and automatic fallback when `CLIENT SETINFO` fails\n\n## Impact\n\nThis is a breaking change that affects all users running Redis servers older than 7.2.x, which includes:\n\n- Redis 6.x (still widely used in production)\n- Redis 5.x\n- Managed Redis services that haven't upgraded to 7.2+\n- AWS ElastiCache Redis (many instances still on 6.x)\n\n## Additional Context\n\nOur team encountered this issue in production and had to apply an emergency hotfix to pin the Redis client version to prevent automatic upgrades to the breaking version.", "closed_by": {"login": "PavelPashov", "id": 60297174, "node_id": "MDQ6VXNlcjYwMjk3MTc0", "avatar_url": "https://avatars.githubusercontent.com/u/60297174?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PavelPashov", "html_url": "https://github.com/PavelPashov", "followers_url": "https://api.github.com/users/PavelPashov/followers", "following_url": "https://api.github.com/users/PavelPashov/following{/other_user}", "gists_url": "https://api.github.com/users/PavelPashov/gists{/gist_id}", "starred_url": "https://api.github.com/users/PavelPashov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PavelPashov/subscriptions", "organizations_url": "https://api.github.com/users/PavelPashov/orgs", "repos_url": "https://api.github.com/users/PavelPashov/repos", "events_url": "https://api.github.com/users/PavelPashov/events{/privacy}", "received_events_url": "https://api.github.com/users/PavelPashov/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/2031/reactions", "total_count": 2, "+1": 2, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/2031/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/2025", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/2025/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/2025/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/2025/events", "html_url": "https://github.com/redis/ioredis/issues/2025", "id": 3497955924, "node_id": "I_kwDOAfwFLc7QfpJU", "number": 2025, "title": "\"Connection is closed\" during quit() when commandQueue has entries", "user": {"login": "SiebelsTim", "id": 1153003, "node_id": "MDQ6VXNlcjExNTMwMDM=", "avatar_url": "https://avatars.githubusercontent.com/u/1153003?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SiebelsTim", "html_url": "https://github.com/SiebelsTim", "followers_url": "https://api.github.com/users/SiebelsTim/followers", "following_url": "https://api.github.com/users/SiebelsTim/following{/other_user}", "gists_url": "https://api.github.com/users/SiebelsTim/gists{/gist_id}", "starred_url": "https://api.github.com/users/SiebelsTim/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SiebelsTim/subscriptions", "organizations_url": "https://api.github.com/users/SiebelsTim/orgs", "repos_url": "https://api.github.com/users/SiebelsTim/repos", "events_url": "https://api.github.com/users/SiebelsTim/events{/privacy}", "received_events_url": "https://api.github.com/users/SiebelsTim/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [{"login": "PavelPashov", "id": 60297174, "node_id": "MDQ6VXNlcjYwMjk3MTc0", "avatar_url": "https://avatars.githubusercontent.com/u/60297174?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PavelPashov", "html_url": "https://github.com/PavelPashov", "followers_url": "https://api.github.com/users/PavelPashov/followers", "following_url": "https://api.github.com/users/PavelPashov/following{/other_user}", "gists_url": "https://api.github.com/users/PavelPashov/gists{/gist_id}", "starred_url": "https://api.github.com/users/PavelPashov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PavelPashov/subscriptions", "organizations_url": "https://api.github.com/users/PavelPashov/orgs", "repos_url": "https://api.github.com/users/PavelPashov/repos", "events_url": "https://api.github.com/users/PavelPashov/events{/privacy}", "received_events_url": "https://api.github.com/users/PavelPashov/received_events", "type": "User", "user_view_type": "public", "site_admin": false}], "milestone": null, "comments": 10, "created_at": "2025-10-09T07:23:06Z", "updated_at": "2025-12-18T08:09:52Z", "closed_at": "2025-10-28T08:11:06Z", "assignee": {"login": "PavelPashov", "id": 60297174, "node_id": "MDQ6VXNlcjYwMjk3MTc0", "avatar_url": "https://avatars.githubusercontent.com/u/60297174?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PavelPashov", "html_url": "https://github.com/PavelPashov", "followers_url": "https://api.github.com/users/PavelPashov/followers", "following_url": "https://api.github.com/users/PavelPashov/following{/other_user}", "gists_url": "https://api.github.com/users/PavelPashov/gists{/gist_id}", "starred_url": "https://api.github.com/users/PavelPashov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PavelPashov/subscriptions", "organizations_url": "https://api.github.com/users/PavelPashov/orgs", "repos_url": "https://api.github.com/users/PavelPashov/repos", "events_url": "https://api.github.com/users/PavelPashov/events{/privacy}", "received_events_url": "https://api.github.com/users/PavelPashov/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "# Problem\n\n`await ioredis.quit()` throws an `Error` when there are still items on the `commandQueue`.\n\n```\nError: Connection is closed.\n    at close (./node_modules/ioredis/built/redis/event_handler.js:189:25)\n    at Socket.<anonymous> (./node_modules/ioredis/built/redis/event_handler.js:156:20)\n    at Object.onceWrapper (node:events:622:26)\n    at Socket.emit (node:events:507:28)\n    at TCP.<anonymous> (node:net:346:12)\n```\n\n## Version\nioredis 5.8.0\n\n# Context\n\nWe have code for a health check that connects and immediately disconnects using `await ioredis.quit()`.\n\nThe issue occurs often since https://github.com/redis/ioredis/pull/2011. I assume the reason for this is, that we now have entries on the `commandQueue` immediately.\n\n## Workaround\nThe issue does not occur anymore when I set `disableClientInfo` to `true`.\n\n# Reason\n\nUsually the `commandQueue` is empty and the connection terminates sucessfully. However, when the error occures, we have the following entries on the `commandQueue`\n\n```\n[\n  {\n    command: Command {\n      name: 'client',\n      inTransaction: false,\n      isResolved: false,\n      transformed: true,\n      replyEncoding: 'utf8',\n      errorStack: undefined,\n      args: [Array],\n      callback: undefined,\n      resolve: [Function (anonymous)],\n      reject: [Function (anonymous)],\n      promise: [Promise]\n    },\n    stream: undefined,\n    select: 0\n  },\n  {\n    command: Command {\n      name: 'quit',\n      inTransaction: false,\n      isResolved: false,\n      transformed: true,\n      replyEncoding: 'utf8',\n      errorStack: undefined,\n      args: [],\n      callback: undefined,\n      resolve: [Function (anonymous)],\n      reject: [Function (anonymous)],\n      promise: [Promise]\n    },\n    stream: undefined,\n    select: 0\n  }\n] \n```\n\nThe `closeHandler` flushes the queue with an error (https://github.com/redis/ioredis/blob/8dad79f9d05c8891d0c70336f484b065b9865ae2/lib/redis/event_handler.ts#L227). \nThus, `quit` can only ever complete successfully if the queue is empty.", "closed_by": {"login": "PavelPashov", "id": 60297174, "node_id": "MDQ6VXNlcjYwMjk3MTc0", "avatar_url": "https://avatars.githubusercontent.com/u/60297174?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PavelPashov", "html_url": "https://github.com/PavelPashov", "followers_url": "https://api.github.com/users/PavelPashov/followers", "following_url": "https://api.github.com/users/PavelPashov/following{/other_user}", "gists_url": "https://api.github.com/users/PavelPashov/gists{/gist_id}", "starred_url": "https://api.github.com/users/PavelPashov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PavelPashov/subscriptions", "organizations_url": "https://api.github.com/users/PavelPashov/orgs", "repos_url": "https://api.github.com/users/PavelPashov/repos", "events_url": "https://api.github.com/users/PavelPashov/events{/privacy}", "received_events_url": "https://api.github.com/users/PavelPashov/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/2025/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/2025/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/585", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/585/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/585/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/585/events", "html_url": "https://github.com/redis/ioredis/issues/585", "id": 296308322, "node_id": "MDU6SXNzdWUyOTYzMDgzMjI=", "number": 585, "title": "ioredis cluster doesn't discover newly added nodes", "user": {"login": "stephendeyoung", "id": 738733, "node_id": "MDQ6VXNlcjczODczMw==", "avatar_url": "https://avatars.githubusercontent.com/u/738733?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stephendeyoung", "html_url": "https://github.com/stephendeyoung", "followers_url": "https://api.github.com/users/stephendeyoung/followers", "following_url": "https://api.github.com/users/stephendeyoung/following{/other_user}", "gists_url": "https://api.github.com/users/stephendeyoung/gists{/gist_id}", "starred_url": "https://api.github.com/users/stephendeyoung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stephendeyoung/subscriptions", "organizations_url": "https://api.github.com/users/stephendeyoung/orgs", "repos_url": "https://api.github.com/users/stephendeyoung/repos", "events_url": "https://api.github.com/users/stephendeyoung/events{/privacy}", "received_events_url": "https://api.github.com/users/stephendeyoung/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 313824970, "node_id": "MDU6TGFiZWwzMTM4MjQ5NzA=", "url": "https://api.github.com/repos/redis/ioredis/labels/cluster", "name": "cluster", "color": "0052cc", "default": false, "description": null}], "state": "closed", "locked": false, "assignees": [{"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}], "milestone": null, "comments": 10, "created_at": "2018-02-12T09:24:17Z", "updated_at": "2022-09-01T03:26:50Z", "closed_at": "2018-05-27T15:52:01Z", "assignee": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "I'm finding that ioredis cluster doesn't discover newly added nodes. On my application startup all nodes in the cluster will be discovered but if I add another node later on ioredis doesn't see it.\r\n\r\nHere are my steps to reproduce:\r\n\r\n1. Start a set of redis instances with the redis `create-cluster` script: https://github.com/antirez/redis/tree/3.2.11/utils/create-cluster\r\n2. Create a cluster using the same script\r\n3. Start an ioredis client with this example script: https://gist.github.com/stephendeyoung/79910f6e2970ca163f9dd38d51776d6b. The script will seed Redis with 120000 keys that are distributed amongst the cluster. Then every five seconds it will count the number of keys across the whole cluster. Initially it counts the correct number of keys.\r\n4. Start a new redis-server like this: `redis-server --port 30007 --cluster-enabled yes --cluster-config-file nodes-30007.conf --cluster-node-timeout 2000 --appendonly yes --appendfilename appendonly-30007.aof --dbfilename dump-30007.rdb --logfile 30007.log --daemonize yes`\r\n5. Use the `redis-trib.rb` script to add the new node to the cluster: `redis-trib.rb add-node 127.0.0.1:30007 127.0.0.1:30001`\r\n6. Reshard the cluster: `redis-trib.rb reshard 127.0.0.1:30001`\r\n7. The script will continue to log the number of keys in the cluster but after resharding rather than counting 120000 keys it will count less than this\r\n\r\nMy expectation is that after adding the new node and resharding redis, ioredis will discover the new node and continue to count the correct number of keys.\r\n\r\nAm I correct in expecting this behaviour? Please let me know if I've done anything wrong here.", "closed_by": {"login": "stale[bot]", "id": 26384082, "node_id": "MDM6Qm90MjYzODQwODI=", "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stale%5Bbot%5D", "html_url": "https://github.com/apps/stale", "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers", "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos", "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events", "type": "Bot", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/585/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/585/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/1718", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/1718/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/1718/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/1718/events", "html_url": "https://github.com/redis/ioredis/issues/1718", "id": 1569796301, "node_id": "I_kwDOAfwFLc5dkTDN", "number": 1718, "title": "A very fast retry strategy hangs blocking commands forever", "user": {"login": "manast", "id": 95200, "node_id": "MDQ6VXNlcjk1MjAw", "avatar_url": "https://avatars.githubusercontent.com/u/95200?v=4", "gravatar_id": "", "url": "https://api.github.com/users/manast", "html_url": "https://github.com/manast", "followers_url": "https://api.github.com/users/manast/followers", "following_url": "https://api.github.com/users/manast/following{/other_user}", "gists_url": "https://api.github.com/users/manast/gists{/gist_id}", "starred_url": "https://api.github.com/users/manast/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/manast/subscriptions", "organizations_url": "https://api.github.com/users/manast/orgs", "repos_url": "https://api.github.com/users/manast/repos", "events_url": "https://api.github.com/users/manast/events{/privacy}", "received_events_url": "https://api.github.com/users/manast/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 1097240172, "node_id": "MDU6TGFiZWwxMDk3MjQwMTcy", "url": "https://api.github.com/repos/redis/ioredis/labels/released", "name": "released", "color": "ededed", "default": false, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 8, "created_at": "2023-02-03T12:52:12Z", "updated_at": "2023-02-12T02:14:25Z", "closed_at": "2023-02-12T00:36:41Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "I was debugging an issue reported to BullMQ related to reconnections and I found something really strange that somehow seems to also affect blocking connections (need to investigate this more though).\r\n\r\n## How to reproduce\r\n\r\nRun this simple code:\r\n```ts\r\nconst Redis = require(\"ioredis\");\r\n\r\nconst connection = new Redis({\r\n  maxRetriesPerRequest: null,\r\n  retryStrategy: function (times) {\r\n    return 10;\r\n  },\r\n});\r\nconnection.on(\"connect\", async () => {\r\n    console.log(\"Connected to Redis!\")\r\n    const result = await connection.set(\"test\", \"test\");   \r\n    console.log(\"OK, Command issued\", result);\r\n});\r\nconnection.on(\"error\", (err) => console.error(\"Redis error\", err.message));\r\nconnection.on(\"reconnecting\", () => console.log(\"Reconnecting to Redis!\"));\r\n```\r\n\r\nYou will get this output:\r\n```\r\nConnected to Redis!\r\nOK, Command issued OK\r\n```\r\n\r\nLeave the code running and just close your Redis instance, in my case since I am running docker:\r\n```\r\ndocker stop some-redis\r\n```\r\n\r\nWait a few seconds and then start it again:\r\n```\r\ndocker start some-redis\r\n```\r\n\r\nThe result would be:\r\n```\r\nRedis error connect ECONNREFUSED 127.0.0.1:6379\r\nReconnecting to Redis!\r\nRedis error connect ECONNREFUSED 127.0.0.1:6379\r\nReconnecting to Redis!\r\nRedis error connect ECONNREFUSED 127.0.0.1:6379\r\nReconnecting to Redis!\r\nConnected to Redis!\r\nReconnecting to Redis!\r\nConnected to Redis!\r\nOK, Command issued OK\r\nOK, Command issued OK\r\nOK, Command issued OK\r\nOK, Command issued OK\r\n```\r\nNotice that the output of 4 \"OK, Command issued OK\". Somehow the callback to the connect event was called 4 times instead of one. Now if we modify the code to retry once per second instead:\r\n\r\n```ts\r\nconst Redis = require(\"ioredis\");\r\n\r\nconst connection = new Redis({\r\n  maxRetriesPerRequest: null,\r\n  retryStrategy: function (times) {\r\n    return 1000;\r\n  },\r\n});\r\nconnection.on(\"connect\", async () => {\r\n    console.log(\"Connected to Redis!\")\r\n    const result = await connection.set(\"test\", \"test\");   \r\n    console.log(\"OK, Command issued\", result);\r\n});\r\nconnection.on(\"error\", (err) => console.error(\"Redis error\", err.message));\r\nconnection.on(\"reconnecting\", () => console.log(\"Reconnecting to Redis!\"));\r\n```\r\nAnd we do the same as we did above then we get the correct output, i.e. one single output of \"OK, Command issued OK\".\r\n\r\nIt seems like there is a small hazard that happens when the retries happen very close together. Not sure if this is completely harmless or not, since I am not done debugging my particular case, but I think this should be investigated and resolved if possible.\r\n\r\n\r\n", "closed_by": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/1718/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/1718/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/344", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/344/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/344/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/344/events", "html_url": "https://github.com/redis/ioredis/issues/344", "id": 163555179, "node_id": "MDU6SXNzdWUxNjM1NTUxNzk=", "number": 344, "title": ".quit() on cluster sometimes causes exceptions", "user": {"login": "AVVS", "id": 1713617, "node_id": "MDQ6VXNlcjE3MTM2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1713617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AVVS", "html_url": "https://github.com/AVVS", "followers_url": "https://api.github.com/users/AVVS/followers", "following_url": "https://api.github.com/users/AVVS/following{/other_user}", "gists_url": "https://api.github.com/users/AVVS/gists{/gist_id}", "starred_url": "https://api.github.com/users/AVVS/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AVVS/subscriptions", "organizations_url": "https://api.github.com/users/AVVS/orgs", "repos_url": "https://api.github.com/users/AVVS/repos", "events_url": "https://api.github.com/users/AVVS/events{/privacy}", "received_events_url": "https://api.github.com/users/AVVS/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 313824970, "node_id": "MDU6TGFiZWwzMTM4MjQ5NzA=", "url": "https://api.github.com/repos/redis/ioredis/labels/cluster", "name": "cluster", "color": "0052cc", "default": false, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 7, "created_at": "2016-07-03T09:49:34Z", "updated_at": "2017-10-30T18:45:24Z", "closed_at": "2017-10-30T18:45:24Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "When calling `cluster.quit()`\n\n```\n     Error: Connection is closed.\n      at close (node_modules/ioredis/lib/redis/event_handler.js:100:21)\n      at Socket.<anonymous> (node_modules/ioredis/lib/redis/event_handler.js:80:14)\n      at TCP._handle.close [as _onclose] (net.js:492:12)\n```\n", "closed_by": {"login": "stale[bot]", "id": 26384082, "node_id": "MDM6Qm90MjYzODQwODI=", "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stale%5Bbot%5D", "html_url": "https://github.com/apps/stale", "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers", "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos", "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events", "type": "Bot", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/344/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/344/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/277", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/277/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/277/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/277/events", "html_url": "https://github.com/redis/ioredis/issues/277", "id": 146034035, "node_id": "MDU6SXNzdWUxNDYwMzQwMzU=", "number": 277, "title": "[question] Disconnect from cluster", "user": {"login": "devnetf", "id": 4071282, "node_id": "MDQ6VXNlcjQwNzEyODI=", "avatar_url": "https://avatars.githubusercontent.com/u/4071282?v=4", "gravatar_id": "", "url": "https://api.github.com/users/devnetf", "html_url": "https://github.com/devnetf", "followers_url": "https://api.github.com/users/devnetf/followers", "following_url": "https://api.github.com/users/devnetf/following{/other_user}", "gists_url": "https://api.github.com/users/devnetf/gists{/gist_id}", "starred_url": "https://api.github.com/users/devnetf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/devnetf/subscriptions", "organizations_url": "https://api.github.com/users/devnetf/orgs", "repos_url": "https://api.github.com/users/devnetf/repos", "events_url": "https://api.github.com/users/devnetf/events{/privacy}", "received_events_url": "https://api.github.com/users/devnetf/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 7, "created_at": "2016-04-05T16:03:23Z", "updated_at": "2016-04-10T15:57:15Z", "closed_at": "2016-04-10T15:57:15Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Hello,\n         I have the following test code: \n        `cluster.get('status').then(function(res){\n     console.log(res);\n     console.log(cluster.status);\n     cluster.disconnect(); \n});\n\nsetInterval(function(){\n    console.log(cluster.status);\n}, 1000);`\n\nAfter cluster.disconnect(); is called, cluster.status still give me \"ready\". How should I disconnect from the cluster? \n\nThanks!\n", "closed_by": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/277/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/277/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/1498", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/1498/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/1498/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/1498/events", "html_url": "https://github.com/redis/ioredis/issues/1498", "id": 1119697552, "node_id": "I_kwDOAfwFLc5CvTqQ", "number": 1498, "title": "Node.js process crushes if a user has no permissions to run the 'monitor' command", "user": {"login": "artyom-podymov", "id": 28300948, "node_id": "MDQ6VXNlcjI4MzAwOTQ4", "avatar_url": "https://avatars.githubusercontent.com/u/28300948?v=4", "gravatar_id": "", "url": "https://api.github.com/users/artyom-podymov", "html_url": "https://github.com/artyom-podymov", "followers_url": "https://api.github.com/users/artyom-podymov/followers", "following_url": "https://api.github.com/users/artyom-podymov/following{/other_user}", "gists_url": "https://api.github.com/users/artyom-podymov/gists{/gist_id}", "starred_url": "https://api.github.com/users/artyom-podymov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/artyom-podymov/subscriptions", "organizations_url": "https://api.github.com/users/artyom-podymov/orgs", "repos_url": "https://api.github.com/users/artyom-podymov/repos", "events_url": "https://api.github.com/users/artyom-podymov/events{/privacy}", "received_events_url": "https://api.github.com/users/artyom-podymov/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 1097240172, "node_id": "MDU6TGFiZWwxMDk3MjQwMTcy", "url": "https://api.github.com/repos/redis/ioredis/labels/released", "name": "released", "color": "ededed", "default": false, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 6, "created_at": "2022-01-31T17:09:25Z", "updated_at": "2022-03-31T13:55:47Z", "closed_at": "2022-03-31T13:51:26Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "1. If create a user that has no permissions to run the `monitor` command\r\n```bash\r\n$ redis-cli \r\nlocalhost:6379> ACL SETUSER alice on nopass ~* &* +@all -monitor\r\nOK\r\n```\r\n2. Connect to Redis and call monitor function\r\n```javascript\r\nconst Redis = require(\"ioredis\");\r\n\r\nvar redis = new Redis({host: 'localhost', port: 6379, username: 'alice'});\r\n\r\nredis.on(\"connect\", () => {\r\n  console.log('Connected to DB \\n');\r\n  redis.monitor((err, monitor) => {\r\n    console.log('Error', err)\r\n    if (!err) {\r\n      monitor.on('monitor', (...args) => console.log(JSON.stringify(args)))\r\n    }\r\n  });\r\n});\r\n\r\n```\r\n3. As a result in the callback function we don't see any error and Node.js process just crushes (the same behavior for `async` function implementation)\r\n```\r\nConnected to DB \r\n\r\nError null                                                                                    \r\nnode_modules\\redis-parser\\lib\\parser.js:179    \r\n    return new ReplyError(string)                                                             \r\n           ^                                                                                  \r\n                                                                                              \r\nReplyError: NOPERM this user has no permissions to run the 'monitor' command or its subcommand\r\n    at parseError (node_modules\\redis-parser\\lib\\parser.js:179:12)\r\n    at parseType (node_modules\\redis-parser\\lib\\parser.js:302:14) {\r\n  command: { name: 'monitor', args: [] }\r\n}\r\n\r\n```\r\n\r\nIs it possible to handle such cases and properly throw errors without stopping the Node.js process?", "closed_by": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/1498/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/1498/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/383", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/383/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/383/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/383/events", "html_url": "https://github.com/redis/ioredis/issues/383", "id": 183039880, "node_id": "MDU6SXNzdWUxODMwMzk4ODA=", "number": 383, "title": "Crash in returnError() method (item is null).", "user": {"login": "markschmid", "id": 6959615, "node_id": "MDQ6VXNlcjY5NTk2MTU=", "avatar_url": "https://avatars.githubusercontent.com/u/6959615?v=4", "gravatar_id": "", "url": "https://api.github.com/users/markschmid", "html_url": "https://github.com/markschmid", "followers_url": "https://api.github.com/users/markschmid/followers", "following_url": "https://api.github.com/users/markschmid/following{/other_user}", "gists_url": "https://api.github.com/users/markschmid/gists{/gist_id}", "starred_url": "https://api.github.com/users/markschmid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/markschmid/subscriptions", "organizations_url": "https://api.github.com/users/markschmid/orgs", "repos_url": "https://api.github.com/users/markschmid/repos", "events_url": "https://api.github.com/users/markschmid/events{/privacy}", "received_events_url": "https://api.github.com/users/markschmid/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 6, "created_at": "2016-10-14T12:40:18Z", "updated_at": "2017-10-30T18:45:30Z", "closed_at": "2017-10-30T18:45:30Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "We're using version 2.4.0 and are seeing a crash in parser.js in the returnError() method.\nThis is probably because the variable `item` is not checked for null.\n\n```\n/<mypath>/node_modules/ioredis/lib/redis/parser.js:48\n    name: item.command.name,\n              ^\n\nTypeError: Cannot read property 'command' of undefined\n    at Redis.exports.returnError (/usr/local/tm/software/node_modules/ioredis/lib/redis/parser.js:48:15)\n    at HiredisReplyParser.replyParser.Parser.returnError (/usr/local/tm/software/node_modules/ioredis/lib/redis/parser.js:25:13)\n    at HiredisReplyParser.execute (/usr/local/tm/software/node_modules/ioredis/node_modules/redis-parser/lib/hiredis.js:28:18)\n    at Socket.<anonymous> (/usr/local/tm/software/node_modules/ioredis/lib/redis/event_handler.js:107:22)\n    at emitOne (events.js:77:13)\n    at Socket.emit (events.js:169:7)\n    at readableAddChunk (_stream_readable.js:146:16)\n    at Socket.Readable.push (_stream_readable.js:110:10)\n    at TCP.onread (net.js:523:20)\n[nodemon] app crashed\n```\n", "closed_by": {"login": "stale[bot]", "id": 26384082, "node_id": "MDM6Qm90MjYzODQwODI=", "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stale%5Bbot%5D", "html_url": "https://github.com/apps/stale", "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers", "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos", "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events", "type": "Bot", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/383/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/383/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/1643", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/1643/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/1643/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/1643/events", "html_url": "https://github.com/redis/ioredis/issues/1643", "id": 1355787735, "node_id": "I_kwDOAfwFLc5Qz63X", "number": 1643, "title": "unsubscribe failed when stringNumbers is True", "user": {"login": "qishibo", "id": 5136418, "node_id": "MDQ6VXNlcjUxMzY0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5136418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/qishibo", "html_url": "https://github.com/qishibo", "followers_url": "https://api.github.com/users/qishibo/followers", "following_url": "https://api.github.com/users/qishibo/following{/other_user}", "gists_url": "https://api.github.com/users/qishibo/gists{/gist_id}", "starred_url": "https://api.github.com/users/qishibo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/qishibo/subscriptions", "organizations_url": "https://api.github.com/users/qishibo/orgs", "repos_url": "https://api.github.com/users/qishibo/repos", "events_url": "https://api.github.com/users/qishibo/events{/privacy}", "received_events_url": "https://api.github.com/users/qishibo/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}, {"id": 1097240172, "node_id": "MDU6TGFiZWwxMDk3MjQwMTcy", "url": "https://api.github.com/repos/redis/ioredis/labels/released", "name": "released", "color": "ededed", "default": false, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 5, "created_at": "2022-08-30T13:37:17Z", "updated_at": "2023-01-25T16:28:48Z", "closed_at": "2023-01-25T14:39:26Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Hey luin, here is a bug on unsubscribe mode if set `stringNumbers: true`, code like this\r\n\r\n```javascript\r\nconst Redis = require(\"ioredis\");\r\n\r\n// const redis = new Redis({stringNumbers: false});\r\nconst redis = new Redis({stringNumbers: true});\r\n\r\nredis.subscribe('xxx', (err, count) => {\r\n  // unsubscribe\r\n  redis.unsubscribe().then(r => {\r\n    console.log('---unsub succ', r);\r\n  }).catch(e => {\r\n    console.log('===unsub fail', e);\r\n  })\r\n});\r\n```\r\nif `stringNumbers` is false, wverything goes well, `'---unsub succ'` will be logged, but if it is set to true, nothing will be logged and the promise will not be solved.\r\n", "closed_by": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/1643/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/1643/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/361", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/361/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/361/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/361/events", "html_url": "https://github.com/redis/ioredis/issues/361", "id": 172081328, "node_id": "MDU6SXNzdWUxNzIwODEzMjg=", "number": 361, "title": "Pipeline reuse", "user": {"login": "pavel", "id": 5321105, "node_id": "MDQ6VXNlcjUzMjExMDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5321105?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pavel", "html_url": "https://github.com/pavel", "followers_url": "https://api.github.com/users/pavel/followers", "following_url": "https://api.github.com/users/pavel/following{/other_user}", "gists_url": "https://api.github.com/users/pavel/gists{/gist_id}", "starred_url": "https://api.github.com/users/pavel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pavel/subscriptions", "organizations_url": "https://api.github.com/users/pavel/orgs", "repos_url": "https://api.github.com/users/pavel/repos", "events_url": "https://api.github.com/users/pavel/events{/privacy}", "received_events_url": "https://api.github.com/users/pavel/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 5, "created_at": "2016-08-19T08:35:03Z", "updated_at": "2017-02-02T02:38:06Z", "closed_at": "2017-02-02T02:38:06Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Consider the following example:\n\n``` javascript\nvar p1 = db.pipeline();\n\np1.echo(\"1\");\n\np1.exec().then(function(result) {\n  console.log(\"first\", result);\n  p1.echo(\"2\");\n  return p1.exec();\n}).then(function(result) {\n  console.log(\"second\", result);\n  return db.quit();\n});\n```\n\nResult is:\n\n```\nfirst [ [ null, 1 ] ]\nsecond [ [ null, 1 ] ]\n```\n\nWhile `MONITOR` on the Redis instance shows following:\n\n```\necho \"1\"\necho \"1\"\necho \"2\"\n```\n1. Result does not match commands executed.\n2. Command queue is not cleared up after `exec()` has sent commands.\n", "closed_by": {"login": "pavel", "id": 5321105, "node_id": "MDQ6VXNlcjUzMjExMDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5321105?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pavel", "html_url": "https://github.com/pavel", "followers_url": "https://api.github.com/users/pavel/followers", "following_url": "https://api.github.com/users/pavel/following{/other_user}", "gists_url": "https://api.github.com/users/pavel/gists{/gist_id}", "starred_url": "https://api.github.com/users/pavel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pavel/subscriptions", "organizations_url": "https://api.github.com/users/pavel/orgs", "repos_url": "https://api.github.com/users/pavel/repos", "events_url": "https://api.github.com/users/pavel/events{/privacy}", "received_events_url": "https://api.github.com/users/pavel/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/361/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/361/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/1629", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/1629/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/1629/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/1629/events", "html_url": "https://github.com/redis/ioredis/issues/1629", "id": 1331168681, "node_id": "I_kwDOAfwFLc5PWAWp", "number": 1629, "title": "Pub/Sub bug", "user": {"login": "KMatuszak", "id": 86327285, "node_id": "MDQ6VXNlcjg2MzI3Mjg1", "avatar_url": "https://avatars.githubusercontent.com/u/86327285?v=4", "gravatar_id": "", "url": "https://api.github.com/users/KMatuszak", "html_url": "https://github.com/KMatuszak", "followers_url": "https://api.github.com/users/KMatuszak/followers", "following_url": "https://api.github.com/users/KMatuszak/following{/other_user}", "gists_url": "https://api.github.com/users/KMatuszak/gists{/gist_id}", "starred_url": "https://api.github.com/users/KMatuszak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/KMatuszak/subscriptions", "organizations_url": "https://api.github.com/users/KMatuszak/orgs", "repos_url": "https://api.github.com/users/KMatuszak/repos", "events_url": "https://api.github.com/users/KMatuszak/events{/privacy}", "received_events_url": "https://api.github.com/users/KMatuszak/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 4, "created_at": "2022-08-08T00:29:21Z", "updated_at": "2022-08-08T12:24:47Z", "closed_at": "2022-08-08T12:24:47Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Subscribing to the same channel again after unsubscribing from it causes messages being received as many times as subscribed to that channel before.\r\n\r\n1. Subscribe\r\n// messages received only one (as expected)\r\n2. Unsubscribe\r\n// messages not received at all (as expected)\r\n3. Subscribe\r\n// messages received twice (expected only one)\r\n4. Unsubscribe\r\n// messages not received at all (as expected)\r\n5. Subscribe\r\n// messages received three times (expected only one)\r\netc...", "closed_by": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/1629/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/1629/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/1215", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/1215/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/1215/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/1215/events", "html_url": "https://github.com/redis/ioredis/issues/1215", "id": 729950404, "node_id": "MDU6SXNzdWU3Mjk5NTA0MDQ=", "number": 1215, "title": "`_addedScriptHashesCleanInterval` is not always cleared on `redis.quit()`", "user": {"login": "trentm", "id": 46866, "node_id": "MDQ6VXNlcjQ2ODY2", "avatar_url": "https://avatars.githubusercontent.com/u/46866?v=4", "gravatar_id": "", "url": "https://api.github.com/users/trentm", "html_url": "https://github.com/trentm", "followers_url": "https://api.github.com/users/trentm/followers", "following_url": "https://api.github.com/users/trentm/following{/other_user}", "gists_url": "https://api.github.com/users/trentm/gists{/gist_id}", "starred_url": "https://api.github.com/users/trentm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/trentm/subscriptions", "organizations_url": "https://api.github.com/users/trentm/orgs", "repos_url": "https://api.github.com/users/trentm/repos", "events_url": "https://api.github.com/users/trentm/events{/privacy}", "received_events_url": "https://api.github.com/users/trentm/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 4, "created_at": "2020-10-26T22:24:53Z", "updated_at": "2020-11-06T14:23:01Z", "closed_at": "2020-10-28T16:11:14Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Hi. I believe https://github.com/luin/ioredis/commit/3b22f8f89c3239fbbbc16da692651f6a35eca53a added a bug where the new `this._addedScriptHashesCleanInterval = setInterval(...)` (https://github.com/luin/ioredis/commit/3b22f8f89c3239fbbbc16da692651f6a35eca53a#diff-d3d9763dec19cf3dd977c437e0be3e6068b13161ee5a2b9b0bf225bddd2d83f8R188) isn't cleared via `clearInterval()` in all cases. This results in a dangling active handle that will hang a node process.\r\n\r\nHere is a repro:\r\n\r\n```js\r\nvar Redis = require('.'); // ioredis\r\nvar redis = new Redis();\r\nredis.on('ready', function () {\r\n    console.log('ready');\r\n    redis.quit();\r\n    console.log('done');\r\n});\r\n```\r\n\r\n```\r\n% node hang.js\r\nready\r\ndone\r\n<hangs here>\r\n```\r\n\r\nor with ioredis debug output:\r\n\r\n```\r\n% DEBUG=ioredis:* node hang.js\r\n  ioredis:redis status[localhost:6379]: [empty] -> connecting +0ms\r\n  ioredis:redis status[127.0.0.1:6379]: connecting -> connect +6ms\r\n  ioredis:redis write command[127.0.0.1:6379]: 0 -> info([]) +2ms\r\n  ioredis:redis status[127.0.0.1:6379]: connect -> ready +4ms\r\nready\r\n  ioredis:redis write command[127.0.0.1:6379]: 0 -> quit([]) +1ms\r\ndone\r\n  ioredis:redis status[127.0.0.1:6379]: ready -> close +3ms\r\n  ioredis:connection skip reconnecting since the connection is manually closed. +0ms\r\n  ioredis:redis status[127.0.0.1:6379]: close -> end +1ms\r\n<hangs here>\r\n```\r\n\r\nThis does not happen if one uses `redis.disconnect()` instead of `redis.quit()`.\r\n\r\n\r\nWhen calling `redis.quit()`, the closeHandler (in event_handler.ts) is called with `self.manuallyClosing == true` which does **not** call the  `clearInterval` added to `Redis.prototype.disconnect()`.\r\n\r\nSome options I see (though I am not very familiar with ioredis, so I'm definitely happy to be overriden):\r\n\r\n1. Add `this._addedScriptHashesCleanInterval.unref()` (https://nodejs.org/api/timers.html#timers_timeout_unref) to the `connect` method.  That'll prevent node from hanging, but *will* persist the setInterval after a program is presumably finished with the ioredis session.\r\n2. Refactor the use of the `closeHandler` to explicitly call `clearInterval`.\r\n3. Refactor access to `this._addedScriptHashes` so that it doesn't require a setInterval to clear it. E.g. perhaps something like https://github.com/isaacs/node-lru-cache using its `maxAge` option.\r\n\r\n", "closed_by": {"login": "AVVS", "id": 1713617, "node_id": "MDQ6VXNlcjE3MTM2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1713617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AVVS", "html_url": "https://github.com/AVVS", "followers_url": "https://api.github.com/users/AVVS/followers", "following_url": "https://api.github.com/users/AVVS/following{/other_user}", "gists_url": "https://api.github.com/users/AVVS/gists{/gist_id}", "starred_url": "https://api.github.com/users/AVVS/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AVVS/subscriptions", "organizations_url": "https://api.github.com/users/AVVS/orgs", "repos_url": "https://api.github.com/users/AVVS/repos", "events_url": "https://api.github.com/users/AVVS/events{/privacy}", "received_events_url": "https://api.github.com/users/AVVS/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/1215/reactions", "total_count": 1, "+1": 0, "-1": 0, "laugh": 0, "hooray": 1, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/1215/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/328", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/328/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/328/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/328/events", "html_url": "https://github.com/redis/ioredis/issues/328", "id": 159792114, "node_id": "MDU6SXNzdWUxNTk3OTIxMTQ=", "number": 328, "title": "cluster: redisOptions ingored in pipeline()", "user": {"login": "AVVS", "id": 1713617, "node_id": "MDQ6VXNlcjE3MTM2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/1713617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AVVS", "html_url": "https://github.com/AVVS", "followers_url": "https://api.github.com/users/AVVS/followers", "following_url": "https://api.github.com/users/AVVS/following{/other_user}", "gists_url": "https://api.github.com/users/AVVS/gists{/gist_id}", "starred_url": "https://api.github.com/users/AVVS/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AVVS/subscriptions", "organizations_url": "https://api.github.com/users/AVVS/orgs", "repos_url": "https://api.github.com/users/AVVS/repos", "events_url": "https://api.github.com/users/AVVS/events{/privacy}", "received_events_url": "https://api.github.com/users/AVVS/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 4, "created_at": "2016-06-11T20:20:16Z", "updated_at": "2017-10-30T18:45:21Z", "closed_at": "2017-10-30T18:45:21Z", "assignee": null, "author_association": "CONTRIBUTOR", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "```\n// conf example\nredis: {\n    options: {\n      // attempt to fix cluster?\n      keyPrefix: '{ms-users}',\n      // pass this to constructor\n      redisOptions: {\n        // must have {}, so that the keys end up on a single machine\n        keyPrefix: '{ms-users}',\n        // do not use buffers\n        dropBufferSupport: true,\n      },\n    },\n  },\n```\n\nWhen using cluster like `new redis.Cluster(redis.hosts, redis.options)` - commands in `.pipeline()` ignores redisOptions and I have to duplicate `keyPrefix` in both root options and `redisOptions`\n", "closed_by": {"login": "stale[bot]", "id": 26384082, "node_id": "MDM6Qm90MjYzODQwODI=", "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stale%5Bbot%5D", "html_url": "https://github.com/apps/stale", "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers", "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos", "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events", "type": "Bot", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/328/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/328/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/217", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/217/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/217/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/217/events", "html_url": "https://github.com/redis/ioredis/issues/217", "id": 123113804, "node_id": "MDU6SXNzdWUxMjMxMTM4MDQ=", "number": 217, "title": "Fails to redis.mset({a:123,b:345}) if options.keyPrefix was used", "user": {"login": "garkin", "id": 422774, "node_id": "MDQ6VXNlcjQyMjc3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/422774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/garkin", "html_url": "https://github.com/garkin", "followers_url": "https://api.github.com/users/garkin/followers", "following_url": "https://api.github.com/users/garkin/following{/other_user}", "gists_url": "https://api.github.com/users/garkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/garkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/garkin/subscriptions", "organizations_url": "https://api.github.com/users/garkin/orgs", "repos_url": "https://api.github.com/users/garkin/repos", "events_url": "https://api.github.com/users/garkin/events{/privacy}", "received_events_url": "https://api.github.com/users/garkin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 4, "created_at": "2015-12-19T22:12:47Z", "updated_at": "2015-12-20T03:59:26Z", "closed_at": "2015-12-20T03:49:15Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "Fails to `redis.mset({a:123,b:345})` if `options.keyPrefix` was used.\n\nBefore handling `keyPrefix`[#](https://github.com/luin/ioredis/blob/master/lib/command.js#L49):\n![image](https://cloud.githubusercontent.com/assets/422774/11915422/d5db3fc0-a6cf-11e5-80e7-c869c32d7545.png)\n\nAfter handling `keyPrefix`:\n![image](https://cloud.githubusercontent.com/assets/422774/11915423/d94a93d6-a6cf-11e5-9515-15ee69d05590.png)\n", "closed_by": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/217/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/217/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}, {"url": "https://api.github.com/repos/redis/ioredis/issues/52", "repository_url": "https://api.github.com/repos/redis/ioredis", "labels_url": "https://api.github.com/repos/redis/ioredis/issues/52/labels{/name}", "comments_url": "https://api.github.com/repos/redis/ioredis/issues/52/comments", "events_url": "https://api.github.com/repos/redis/ioredis/issues/52/events", "html_url": "https://github.com/redis/ioredis/issues/52", "id": 82580154, "node_id": "MDU6SXNzdWU4MjU4MDE1NA==", "number": 52, "title": "Monitor listener not present after reconnect", "user": {"login": "smithandweb", "id": 6816141, "node_id": "MDQ6VXNlcjY4MTYxNDE=", "avatar_url": "https://avatars.githubusercontent.com/u/6816141?v=4", "gravatar_id": "", "url": "https://api.github.com/users/smithandweb", "html_url": "https://github.com/smithandweb", "followers_url": "https://api.github.com/users/smithandweb/followers", "following_url": "https://api.github.com/users/smithandweb/following{/other_user}", "gists_url": "https://api.github.com/users/smithandweb/gists{/gist_id}", "starred_url": "https://api.github.com/users/smithandweb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/smithandweb/subscriptions", "organizations_url": "https://api.github.com/users/smithandweb/orgs", "repos_url": "https://api.github.com/users/smithandweb/repos", "events_url": "https://api.github.com/users/smithandweb/events{/privacy}", "received_events_url": "https://api.github.com/users/smithandweb/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "labels": [{"id": 194935611, "node_id": "MDU6TGFiZWwxOTQ5MzU2MTE=", "url": "https://api.github.com/repos/redis/ioredis/labels/bug", "name": "bug", "color": "fc2929", "default": true, "description": null}], "state": "closed", "locked": false, "assignees": [], "milestone": null, "comments": 4, "created_at": "2015-05-29T20:44:16Z", "updated_at": "2015-06-08T16:03:21Z", "closed_at": "2015-06-03T07:44:39Z", "assignee": null, "author_association": "NONE", "type": null, "active_lock_reason": null, "sub_issues_summary": {"total": 0, "completed": 0, "percent_completed": 0}, "issue_dependencies_summary": {"blocked_by": 0, "total_blocked_by": 0, "blocking": 0, "total_blocking": 0}, "body": "I have my Redis master setup on a private DNS name with a TTL of 30. Average reconnection it obviously around that time once everything propagates. \n\nOne thing I've noticed is that any `monitor` that is running on the client is not present after a reconnect.\n\nTo see if I could recreate it on a reconnect I first called `monitor.off('monitor');` and then attached the listener again once `redis.status` was `ready`.\n\nIt's not an important part of my server so I wasn't worried about it not working, but one thing that happened was this lovely error:\n\n```\n[2015-05-29 20:30:50.073] [ERROR] [Server]-> Caught exception: Error: Command queue state error. If you can reproduce this, please report it.\n    at Redis.exports.returnReply (/home/compilr/node_modules/ioredis/lib/redis/prototype/parser.js:125:33)\n    at HiredisReplyParser.<anonymous> (/home/compilr/node_modules/ioredis/lib/redis/prototype/parser.js:27:10)\n    at HiredisReplyParser.emit (events.js:107:17)\n    at HiredisReplyParser.execute (/home/compilr/node_modules/ioredis/lib/parsers/hiredis.js:42:12)\n    at Socket.<anonymous> (/home/compilr/node_modules/ioredis/lib/redis/event_handler.js:86:22)\n    at Socket.emit (events.js:107:17)\n    at readableAddChunk (_stream_readable.js:163:16)\n    at Socket.Readable.push (_stream_readable.js:126:10)\n    at TCP.onread (net.js:538:20)\n\n```\n\nSo I'm reporting it just like you asked. Looks to be a `hiredis` issue and not yours perhaps.\n\nIf you need more info let me know!\n", "closed_by": {"login": "luin", "id": 635902, "node_id": "MDQ6VXNlcjYzNTkwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/635902?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luin", "html_url": "https://github.com/luin", "followers_url": "https://api.github.com/users/luin/followers", "following_url": "https://api.github.com/users/luin/following{/other_user}", "gists_url": "https://api.github.com/users/luin/gists{/gist_id}", "starred_url": "https://api.github.com/users/luin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luin/subscriptions", "organizations_url": "https://api.github.com/users/luin/orgs", "repos_url": "https://api.github.com/users/luin/repos", "events_url": "https://api.github.com/users/luin/events{/privacy}", "received_events_url": "https://api.github.com/users/luin/received_events", "type": "User", "user_view_type": "public", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/redis/ioredis/issues/52/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/redis/ioredis/issues/52/timeline", "performed_via_github_app": null, "state_reason": "completed", "pinned_comment": null}]}